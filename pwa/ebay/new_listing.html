<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>New Listing ‚Äî eBay QuickList</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f;
            --bg-card: #13131a;
            --bg-input: #1a1a24;
            --border: #2a2a3a;
            --text: #f0f0f5;
            --text-dim: #8888aa;
            --accent: #00c9a7;
            --purple: #7c5cff;
            --red: #ff4d6a;
            --green: #00e676;
            --yellow: #ffc107;
            --radius: 12px;
            --accent-glow: rgba(0, 201, 167, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 700;
        }

        .header .step-badge {
            margin-left: auto;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: var(--accent-glow);
            color: var(--accent);
        }

        /* ‚îÄ‚îÄ‚îÄ Upload Area ‚îÄ‚îÄ‚îÄ */
        .upload-section {
            padding: 20px;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .upload-zone .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .upload-zone p {
            color: var(--text-dim);
            font-size: 14px;
        }

        .upload-zone input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .image-preview .img-wrap {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-input);
        }

        .image-preview .img-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview .img-wrap .remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--red);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ‚îÄ‚îÄ‚îÄ Notes Input ‚îÄ‚îÄ‚îÄ */
        .notes-section {
            padding: 0 20px 20px;
        }

        .notes-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        .notes-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .notes-label {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
            display: block;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* ‚îÄ‚îÄ‚îÄ Generate Button ‚îÄ‚îÄ‚îÄ */
        .generate-section {
            padding: 0 20px 20px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--purple));
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-secondary {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--green), var(--accent));
            color: #000;
        }

        .btn-danger {
            background: var(--bg-input);
            border: 1px solid var(--red);
            color: var(--red);
        }

        /* ‚îÄ‚îÄ‚îÄ Result / Preview ‚îÄ‚îÄ‚îÄ */
        .result-section {
            padding: 0 20px 20px;
            display: none;
        }

        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .result-card h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field-group {
            margin-bottom: 16px;
        }

        .field-group label {
            display: block;
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .field-group input,
        .field-group textarea,
        .field-group select {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            outline: none;
        }

        .field-group input:focus,
        .field-group textarea:focus {
            border-color: var(--accent);
        }

        .field-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .char-count {
            font-size: 11px;
            color: var(--text-dim);
            text-align: right;
            margin-top: 4px;
        }

        .price-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .dims-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        /* ‚îÄ‚îÄ‚îÄ Profit Preview ‚îÄ‚îÄ‚îÄ */
        .profit-card {
            background: linear-gradient(135deg, rgba(0, 201, 167, 0.08), rgba(124, 92, 255, 0.08));
            border: 1px solid var(--accent);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .profit-card h3 {
            color: var(--accent);
            margin-bottom: 16px;
        }

        .profit-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
        }

        .profit-row.total {
            border-top: 1px solid var(--border);
            padding-top: 12px;
            margin-top: 8px;
            font-weight: 700;
            font-size: 16px;
        }

        .profit-row .neg {
            color: var(--red);
        }

        .profit-row .pos {
            color: var(--green);
        }

        /* ‚îÄ‚îÄ‚îÄ Duplicate Warning ‚îÄ‚îÄ‚îÄ */
        .dupe-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid var(--yellow);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .dupe-warning h4 {
            color: var(--yellow);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .dupe-warning p {
            font-size: 13px;
            color: var(--text-dim);
        }

        .dupe-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .dupe-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: inherit;
        }

        /* ‚îÄ‚îÄ‚îÄ Pricing Research ‚îÄ‚îÄ‚îÄ */
        .pricing-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .pricing-card .price-compare {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .pricing-card .comp-item {
            flex: 1;
            min-width: 100px;
            text-align: center;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 8px;
        }

        .pricing-card .comp-item .val {
            font-size: 18px;
            font-weight: 700;
            color: var(--yellow);
        }

        .pricing-card .comp-item .lbl {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* ‚îÄ‚îÄ‚îÄ Post Actions ‚îÄ‚îÄ‚îÄ */
        .post-actions {
            padding: 0 20px 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ‚îÄ‚îÄ‚îÄ Loading Overlay ‚îÄ‚îÄ‚îÄ */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-overlay .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        .loading-overlay .status {
            color: var(--text);
            font-size: 16px;
            margin-top: 20px;
            font-weight: 600;
        }

        .loading-overlay .sub {
            color: var(--text-dim);
            font-size: 13px;
            margin-top: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ‚îÄ‚îÄ‚îÄ Bottom Nav ‚îÄ‚îÄ‚îÄ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            gap: 4px;
            text-decoration: none;
            color: var(--text-dim);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: none;
        }

        .nav-item.active {
            color: var(--accent);
        }

        .nav-item .icon {
            font-size: 20px;
        }

        /* Shipping toggle */
        .ship-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-input);
            border-radius: 8px;
            padding: 3px;
            margin-bottom: 12px;
        }

        .ship-toggle button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: none;
            color: var(--text-dim);
            font-family: inherit;
            transition: all 0.2s;
        }

        .ship-toggle button.active {
            background: var(--accent);
            color: #000;
        }

        /* ‚îÄ‚îÄ‚îÄ Description Preview ‚îÄ‚îÄ‚îÄ */
        .desc-preview {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            color: var(--text);
            font-size: 14px;
            line-height: 1.6;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }

        .desc-preview h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--accent);
        }

        .desc-preview ul {
            padding-left: 20px;
            margin: 8px 0;
        }

        .desc-preview li {
            margin-bottom: 4px;
        }

        .desc-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .desc-toggle button {
            padding: 4px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: none;
            color: var(--text-dim);
            font-size: 11px;
            cursor: pointer;
            font-family: inherit;
        }

        .desc-toggle button.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        /* ‚îÄ‚îÄ‚îÄ Screenshot Modal ‚îÄ‚îÄ‚îÄ */
        .screenshot-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .screenshot-modal.show {
            display: flex;
        }

        .screenshot-modal h2 {
            color: var(--accent);
            margin-bottom: 12px;
            font-size: 20px;
        }

        .screenshot-modal .status-msg {
            color: var(--text);
            margin-bottom: 16px;
            font-size: 14px;
            text-align: center;
        }

        .screenshot-modal img {
            max-width: 90vw;
            max-height: 50vh;
            border-radius: 12px;
            border: 2px solid var(--border);
            margin-bottom: 20px;
        }

        .screenshot-modal .modal-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .screenshot-modal .btn-looks-good {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--green), var(--accent));
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
        }

        .screenshot-modal .btn-try-again {
            padding: 14px 28px;
            background: var(--bg-input);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        .screenshot-modal .btn-close-modal {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 24px;
            cursor: pointer;
        }

        /* ‚îÄ‚îÄ‚îÄ TikTok Cross-Reference ‚îÄ‚îÄ‚îÄ */
        .tiktok-card {
            background: linear-gradient(135deg, rgba(255, 0, 80, 0.06), rgba(0, 242, 234, 0.06));
            border: 1px solid rgba(255, 0, 80, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .tiktok-card h3 {
            color: #ff0050;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .tiktok-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .tiktok-stats .stat {
            text-align: center;
            padding: 8px;
            background: var(--bg-input);
            border-radius: 8px;
        }

        .tiktok-stats .stat .val {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
        }

        .tiktok-stats .stat .lbl {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-top: 2px;
        }

        .tiktok-insight {
            font-size: 13px;
            color: var(--green);
            padding: 10px;
            background: rgba(0, 230, 118, 0.08);
            border-radius: 8px;
        }

        /* ‚îÄ‚îÄ‚îÄ Item Specifics ‚îÄ‚îÄ‚îÄ */
        .specifics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .specifics-grid .field-group {
            margin-bottom: 8px;
        }

        /* ‚îÄ‚îÄ‚îÄ Return Policy Toggle ‚îÄ‚îÄ‚îÄ */
        .return-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 8px;
        }

        .return-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
        }

        .return-toggle label {
            font-size: 14px;
            color: var(--text);
        }

        .return-toggle .tip {
            font-size: 11px;
            color: var(--text-dim);
            margin-left: auto;
        }

        /* ‚îÄ‚îÄ‚îÄ Clipboard Toast ‚îÄ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--green);
            color: #000;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .btn-ebay-disabled {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-dim);
            position: relative;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <button class="back-btn" onclick="history.back()">‚Üê</button>
        <h1>New Listing</h1>
        <span class="step-badge" id="stepBadge">Step 1: Upload</span>
    </div>

    <!-- Step 1: Upload Images -->
    <div id="step1">
        <div class="upload-section">
            <div class="upload-zone" id="uploadZone">
                <div class="icon">üì∏</div>
                <p><strong>Tap to upload</strong> or drag & drop photos</p>
                <p style="margin-top:8px;font-size:12px;">2-10 product images ‚Ä¢ JPG or PNG</p>
                <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFiles(this.files)">
            </div>
            <div class="image-preview" id="imagePreview"></div>
        </div>

        <div class="notes-section">
            <label class="notes-label">Notes (optional)</label>
            <textarea class="notes-input" id="userNotes"
                placeholder="e.g., Cost $0 (sample), quantity 3, color: pink, size: regular..."></textarea>
        </div>

        <div class="generate-section">
            <button class="btn btn-primary" id="generateBtn" onclick="generateListing()" disabled>
                ü§ñ Generate eBay Listing with AI
            </button>
        </div>
    </div>

    <!-- Step 2: Review & Edit -->
    <div class="result-section" id="step2">
        <!-- Duplicate Warning -->
        <div class="dupe-warning" id="dupeWarning" style="display:none;">
            <h4>‚ö†Ô∏è Possible Duplicate Detected</h4>
            <p id="dupeText">Similar listing found in your active inventory.</p>
            <div class="dupe-actions">
                <button class="btn-danger" onclick="cancelDupe()"
                    style="background:var(--bg-input);border:1px solid var(--red);color:var(--red);">Cancel</button>
                <button style="background:var(--yellow);color:#000;" onclick="dismissDupe()">Post Anyway</button>
            </div>
        </div>

        <!-- Pricing Research -->
        <div class="pricing-card" id="pricingCard">
            <h3 style="font-size:13px;font-weight:700;color:var(--yellow);margin-bottom:12px;">üí∞ Pricing Research</h3>
            <div class="price-compare">
                <div class="comp-item">
                    <div class="val" id="priceAvg">‚Äî</div>
                    <div class="lbl">Avg Sold</div>
                </div>
                <div class="comp-item">
                    <div class="val" id="priceLow">‚Äî</div>
                    <div class="lbl">Lowest Total</div>
                </div>
            </div>
            <div class="comp-item">
                <div class="val" id="priceOpt">‚Äî</div>
                <div class="lbl">Suggested</div>
            </div>
        </div>
        <p id="priceReason" style="font-size:12px;color:var(--text-dim);margin-top:10px;"></p>
    </div>

    <!-- Title & Description -->
    <div class="result-card">
        <h3>üìù Listing Details</h3>
        <div class="field-group">
            <label>Title</label>
            <input type="text" id="editTitle" maxlength="80" oninput="updateCharCount()">
            <div class="char-count"><span id="charCount">0</span>/80</div>
        </div>
        <div class="field-group">
            <label>Description</label>
            <div class="desc-toggle">
                <button class="active" onclick="toggleDescView('preview', this)">Preview</button>
                <button onclick="toggleDescView('html', this)">Edit HTML</button>
            </div>
            <div class="desc-preview" id="descPreview"></div>
            <textarea id="editDesc" rows="6" style="display:none;"></textarea>
        </div>
        <div class="field-group">
            <label>Category</label>
            <input type="text" id="editCategory" readonly style="color:var(--text-dim);">
        </div>
        <div class="field-group">
            <label>UPC / Barcode <span style="font-weight:400;color:var(--text-dim);">(boosts eBay
                    visibility)</span></label>
            <input type="text" id="editUpc" placeholder="Auto-detected from images or enter manually">
        </div>
        <div class="price-row">
            <div class="field-group">
                <label>Price ($)</label>
                <input type="number" id="editPrice" step="0.01" min="0" oninput="updateProfit()">
            </div>
            <div class="field-group">
                <label>Quantity</label>
                <input type="number" id="editQty" min="1" value="1">
            </div>
        </div>
        <div class="price-row">
            <div class="field-group">
                <label>Condition</label>
                <select id="editCondition">
                    <option value="NEW">New</option>
                    <option value="NEW_OTHER">New (Other)</option>
                    <option value="LIKE_NEW">Like New</option>
                    <option value="USED_EXCELLENT">Used - Excellent</option>
                </select>
            </div>
            <div class="field-group">
                <label>Condition Detail</label>
                <select id="editConditionDetail">
                    <option value="Factory sealed">Factory sealed</option>
                    <option value="New in box">New in box</option>
                    <option value="Open box - never used">Open box - never used</option>
                    <option value="New without tags">New without tags</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Item Specifics -->
    <div class="result-card" id="itemSpecificsCard" style="display:none;">
        <h3>üè∑Ô∏è Item Specifics</h3>
        <div class="specifics-grid" id="specificsGrid"></div>
    </div>

    <!-- TikTok Cross-Reference -->
    <div class="tiktok-card" id="tiktokCard" style="display:none;">
        <h3>üéµ TikTok Intelligence</h3>
        <div class="tiktok-stats">
            <div class="stat">
                <div class="val" id="ttPrice">‚Äî</div>
                <div class="lbl">TikTok Price</div>
            </div>
            <div class="stat">
                <div class="val" id="ttCommission">‚Äî</div>
                <div class="lbl">Commission</div>
            </div>
            <div class="stat">
                <div class="val" id="ttSales">‚Äî</div>
                <div class="lbl">7D Sales</div>
            </div>
        </div>
        <div class="tiktok-insight" id="ttInsight"></div>
    </div>

    <!-- Shipping -->
    <div class="result-card">
        <h3>üì¶ Shipping & Returns</h3>
        <div class="ship-toggle">
            <button class="active" onclick="setShipType('FREE',this)">Free Shipping</button>
            <button onclick="setShipType('CALCULATED',this)">Calculated</button>
            <button onclick="setShipType('FLAT_RATE',this)">Flat Rate</button>
        </div>
        <div id="flatRateField" style="display:none;">
            <div class="field-group">
                <label>Flat Rate ($)</label>
                <input type="number" id="editShipCost" step="0.01" value="0" oninput="updateProfit()">
            </div>
        </div>
        <div class="field-group">
            <label>Weight (oz)</label>
            <input type="number" id="editWeightOz" step="0.1" min="0">
        </div>
        <div class="dims-row">
            <div class="field-group">
                <label>L (in)</label>
                <input type="number" id="editLength" step="0.1">
            </div>
            <div class="field-group">
                <label>W (in)</label>
                <input type="number" id="editWidth" step="0.1">
            </div>
            <div class="field-group">
                <label>H (in)</label>
                <input type="number" id="editHeight" step="0.1">
            </div>
        </div>
        <div style="margin-top:12px;">
            <div class="return-toggle">
                <input type="checkbox" id="editReturns" checked>
                <label for="editReturns">30-Day Free Returns</label>
                <span class="tip">Boosts eBay ranking ‚ú®</span>
            </div>
        </div>
    </div>

    <!-- Profit Preview -->
    <div class="profit-card" id="profitCard">
        <h3>üìä Profit Estimate</h3>
        <div class="profit-row"><span>Sale Price (free shipping)</span><span id="profPrice" class="pos">$0</span></div>
        <div class="profit-row"><span>Cost</span><span id="profCost">$0</span></div>
        <div class="profit-row"><span>eBay Fees (~13.25%)</span><span id="profFees" class="neg">-$0</span></div>
        <div class="profit-row"><span>Shipping (you pay)</span><span id="profShip" class="neg">-$12</span></div>
        <div class="profit-row total"><span>Net Profit per Sale</span><span id="profNet" class="pos">$0</span></div>
    </div>

    <!-- Actions -->
    <div class="post-actions">
        <button class="btn btn-success" id="clipboardBtn" onclick="copyToClipboard()">üìã Copy All to
            Clipboard</button>
        <button class="btn btn-primary"
            style="background:linear-gradient(135deg, var(--green), var(--accent)); color:#000; font-weight:700;"
            onclick="autoFillEbay()">üöÄ Auto-Fill eBay</button>
        <button class="btn btn-primary" onclick="saveListing('draft')">üíæ Save as Draft</button>
        <button class="btn btn-secondary" onclick="resetForm()">‚Ü©Ô∏è Start Over</button>
    </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="status" id="loadingStatus">Analyzing images with AI...</div>
        <div class="sub" id="loadingSub">This usually takes 10-20 seconds</div>
    </div>
    <!-- Toast Notification -->
    <div class="toast" id="toast">‚úÖ Copied to clipboard!</div>

    <!-- Screenshot Preview Modal -->
    <div class="screenshot-modal" id="screenshotModal">
        <button class="btn-close-modal" onclick="closeScreenshotModal()">‚úï</button>
        <h2 id="modalTitle">‚úÖ eBay Form Filled!</h2>
        <div class="status-msg" id="modalMsg">Review the screenshot below to verify all fields look correct.</div>
        <img id="modalScreenshot" src="" alt="eBay form screenshot" style="display:none;">

        <!-- Copyable Listing Data (shown on login/CAPTCHA/error) -->
        <div id="modalListingData" style="display:none; margin:12px 0; text-align:left;">
            <div style="background:rgba(255,255,255,0.08); border-radius:12px; padding:14px; font-size:13px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <strong style="color:#4ade80;">üìã Your Listing Data</strong>
                    <button onclick="copyAllListingData()"
                        style="background:#4ade80; color:#000; border:none; padding:6px 14px; border-radius:8px; font-size:12px; font-weight:600; cursor:pointer;">Copy
                        All</button>
                </div>
                <div id="dataFieldTitle" style="margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="color:#aaa; font-size:11px;">TITLE</span>
                        <button onclick="copyField('dataTitle')"
                            style="background:none; border:1px solid #555; color:#ccc; padding:2px 8px; border-radius:6px; font-size:11px; cursor:pointer;">Copy</button>
                    </div>
                    <div id="dataTitle" style="color:#fff; padding:4px 0; word-break:break-word;"></div>
                </div>
                <div id="dataFieldDesc" style="margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="color:#aaa; font-size:11px;">DESCRIPTION</span>
                        <button onclick="copyField('dataDesc')"
                            style="background:none; border:1px solid #555; color:#ccc; padding:2px 8px; border-radius:6px; font-size:11px; cursor:pointer;">Copy</button>
                    </div>
                    <div id="dataDesc"
                        style="color:#fff; padding:4px 0; max-height:120px; overflow-y:auto; word-break:break-word; font-size:12px; line-height:1.4;">
                    </div>
                </div>
                <div style="display:flex; gap:12px;">
                    <div style="flex:1;">
                        <span style="color:#aaa; font-size:11px;">PRICE</span>
                        <div id="dataPrice" style="color:#4ade80; font-weight:700; font-size:18px;"></div>
                    </div>
                    <div style="flex:1;">
                        <span style="color:#aaa; font-size:11px;">CONDITION</span>
                        <div id="dataCondition" style="color:#fff;"></div>
                    </div>
                    <div style="flex:1;">
                        <span style="color:#aaa; font-size:11px;">SHIPPING</span>
                        <div style="color:#fff;">Free</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn-looks-good" id="modalOpenEbay" onclick="openEbayFromModal()">‚úÖ Looks Good ‚Üí Open eBay
                Now</button>
            <button class="btn-looks-good" id="modalSolveCaptcha" onclick="solveCaptchaAndRetry()"
                style="display:none; background:#f59e0b;">üîì Solve in eBay & Try Again</button>
            <button class="btn-try-again" onclick="autoFillEbay()">üîÑ Something's Wrong ‚Üí Try Again</button>
            <button class="btn-try-again" onclick="closeScreenshotModal()">‚úï Close</button>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <a class="nav-item" href="/ebay"><span class="icon">üè†</span>Home</a>
        <a class="nav-item active" href="/ebay/new"><span class="icon">‚ûï</span>New</a>
        <a class="nav-item" href="/ebay/listings"><span class="icon">üìã</span>Listings</a>
        <a class="nav-item" href="/ebay/stats"><span class="icon">üìä</span>Stats</a>
        <a class="nav-item" href="/ebay/settings"><span class="icon">‚öôÔ∏è</span>Settings</a>
    </div>

    <script>
        let uploadedImages = []; // base64 strings
        let currentListingData = null;
        let shippingType = 'FREE';

        // Auth check
        fetch('/ebay/api/me').then(r => r.json()).then(d => {
            if (!d.authenticated) window.location.href = '/ebay/login';
        }).catch(() => window.location.href = '/ebay/login');

        // ‚îÄ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const zone = document.getElementById('uploadZone');
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
            e.preventDefault(); zone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;
                if (uploadedImages.length >= 10) return;
                const reader = new FileReader();
                reader.onload = e => {
                    uploadedImages.push(e.target.result);
                    renderPreviews();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderPreviews() {
            const container = document.getElementById('imagePreview');
            container.innerHTML = uploadedImages.map((img, i) => `
                <div class="img-wrap">
                    <img src="${img}" alt="Product ${i + 1}">
                    <button class="remove" onclick="removeImage(${i})">‚úï</button>
                </div>
            `).join('');
            document.getElementById('generateBtn').disabled = uploadedImages.length === 0;
        }

        function removeImage(idx) {
            uploadedImages.splice(idx, 1);
            renderPreviews();
        }

        // ‚îÄ‚îÄ‚îÄ Generate Listing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function generateListing() {
            if (uploadedImages.length === 0) return;
            showLoading('ü§ñ Analyzing images with AI...', 'Identifying brand, condition, UPC & specs...');

            try {
                const resp = await fetch('/ebay/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        images: uploadedImages,
                        notes: document.getElementById('userNotes').value,
                    }),
                });
                const data = await resp.json();
                if (!data.success) throw new Error(data.error || 'Generation failed');

                currentListingData = data;
                populateForm(data);
                hideLoading();

                // Show result section
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
                document.getElementById('stepBadge').textContent = 'Step 2: Review';
                window.scrollTo(0, 0);

            } catch (err) {
                hideLoading();
                alert('Error: ' + err.message);
            }
        }

        function populateForm(data) {
            const l = data.listing;
            const p = data.pricing;

            document.getElementById('editTitle').value = l.title || '';
            document.getElementById('editDesc').value = l.description || '';
            document.getElementById('descPreview').innerHTML = l.description || '';
            document.getElementById('editCategory').value = l.category_name || '';
            document.getElementById('editPrice').value = l.price || 0;
            document.getElementById('editCondition').value = l.condition || 'NEW';
            document.getElementById('editWeightOz').value = l.weight_oz || 0;
            document.getElementById('editLength').value = l.length_in || 0;
            document.getElementById('editWidth').value = l.width_in || 0;
            document.getElementById('editHeight').value = l.height_in || 0;

            // New fields
            document.getElementById('editUpc').value = l.upc || '';
            if (l.condition_detail) {
                const detailSel = document.getElementById('editConditionDetail');
                for (let opt of detailSel.options) {
                    if (l.condition_detail.toLowerCase().includes(opt.value.toLowerCase())) {
                        detailSel.value = opt.value;
                        break;
                    }
                }
            }

            // Item Specifics
            if (l.item_specifics && Object.keys(l.item_specifics).length > 0) {
                const grid = document.getElementById('specificsGrid');
                grid.innerHTML = Object.entries(l.item_specifics).map(([key, val]) => `
                    <div class="field-group">
                        <label>${key}</label>
                        <input type="text" value="${val}" data-specific="${key}">
                    </div>
                `).join('');
                document.getElementById('itemSpecificsCard').style.display = 'block';
            }

            updateCharCount();
            updateProfit();

            // Pricing research
            if (p) {
                document.getElementById('priceAvg').textContent = p.avg_sold_price ? `$${p.avg_sold_price}` : '‚Äî';
                document.getElementById('priceLow').textContent = (p.lowest_competitor_total || p.lowest_current) ? `$${p.lowest_competitor_total || p.lowest_current}` : '‚Äî';
                document.getElementById('priceOpt').textContent = p.optimal_price ? `$${p.optimal_price}` : '‚Äî';
                document.getElementById('priceReason').textContent = p.price_reasoning || '';
            }

            // TikTok Cross-Reference
            const tt = data.tiktok_match;
            if (tt) {
                document.getElementById('tiktokCard').style.display = 'block';
                document.getElementById('ttPrice').textContent = tt.tiktok_price ? `$${tt.tiktok_price}` : '‚Äî';
                document.getElementById('ttCommission').textContent = tt.commission_rate ? `${tt.commission_rate}%` : '‚Äî';
                document.getElementById('ttSales').textContent = tt.sales_7d ? tt.sales_7d.toLocaleString() : '‚Äî';

                // Generate insight
                const ebayPrice = parseFloat(document.getElementById('editPrice').value) || 0;
                const ttPrice = tt.tiktok_price || 0;
                if (ebayPrice > 0 && ttPrice > 0) {
                    const priceDiff = ((ttPrice - ebayPrice) / ttPrice * 100).toFixed(0);
                    const commProfit = (ttPrice * (tt.commission_rate / 100)).toFixed(2);
                    const ebayProfit = (ebayPrice * 0.8675 - 12.0).toFixed(2); // after fees + shipping you pay
                    document.getElementById('ttInsight').textContent =
                        `üìä eBay at $${ebayPrice.toFixed(2)} = ~$${ebayProfit} profit | TikTok affiliate = ~$${commProfit}/sale | ${tt.sales_7d} sales/week on TikTok`;
                } else {
                    document.getElementById('ttInsight').textContent =
                        `Found in TikTok DB: ${tt.product_name} ‚Ä¢ ${tt.video_count} videos ‚Ä¢ ${tt.influencer_count} influencers`;
                }
            }

            // Duplicate warning
            if (data.duplicates && data.duplicates.length > 0) {
                document.getElementById('dupeWarning').style.display = 'block';
                document.getElementById('dupeText').textContent =
                    `Similar listing found: "${data.duplicates[0].title}" (${data.duplicates[0].status})`;
            }
        }

        function updateCharCount() {
            const len = document.getElementById('editTitle').value.length;
            document.getElementById('charCount').textContent = len;
        }

        function updateProfit() {
            const price = parseFloat(document.getElementById('editPrice').value) || 0;
            const fees = (price * 0.1325) + 0.30;
            // FREE shipping = seller pays ~$12, FLAT_RATE = buyer pays, CALCULATED = buyer pays
            const shipping = shippingType === 'FREE' ? 12 :
                shippingType === 'FLAT_RATE' ? parseFloat(document.getElementById('editShipCost').value) || 0 : 0;
            const profit = price - fees - shipping;

            document.getElementById('profPrice').textContent = `$${price.toFixed(2)}`;
            document.getElementById('profFees').textContent = `-$${fees.toFixed(2)}`;
            document.getElementById('profShip').textContent = shippingType === 'FREE' ? `-$${shipping.toFixed(2)}` : `$0 (buyer pays)`;
            document.getElementById('profNet').textContent = `$${profit.toFixed(2)}`;
            document.getElementById('profNet').className = profit >= 0 ? 'pos' : 'neg';
        }

        function setShipType(type, btn) {
            shippingType = type;
            document.querySelectorAll('.ship-toggle button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('flatRateField').style.display = type === 'FLAT_RATE' ? 'block' : 'none';
            updateProfit();
        }

        function cancelDupe() {
            resetForm();
        }

        function dismissDupe() {
            document.getElementById('dupeWarning').style.display = 'none';
        }

        // ‚îÄ‚îÄ‚îÄ Description Preview/Edit Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function toggleDescView(mode, btn) {
            document.querySelectorAll('.desc-toggle button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (mode === 'preview') {
                // Sync any edits from textarea back to preview
                document.getElementById('descPreview').innerHTML = document.getElementById('editDesc').value;
                document.getElementById('descPreview').style.display = 'block';
                document.getElementById('editDesc').style.display = 'none';
            } else {
                document.getElementById('descPreview').style.display = 'none';
                document.getElementById('editDesc').style.display = 'block';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Copy to Clipboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function copyToClipboard() {
            const title = document.getElementById('editTitle').value;
            const desc = document.getElementById('editDesc').value;
            const price = document.getElementById('editPrice').value;
            const condition = document.getElementById('editCondition').value;
            const condDetail = document.getElementById('editConditionDetail').value;
            const category = document.getElementById('editCategory').value;
            const upc = document.getElementById('editUpc').value;
            const weightOz = document.getElementById('editWeightOz').value;
            const qty = document.getElementById('editQty').value;
            const sku = currentListingData?.listing?.sku || '';
            const returns = document.getElementById('editReturns').checked ? '30-day free returns' : 'No returns';

            // Strip HTML for plain text description
            const plainDesc = desc.replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim();

            // Collect item specifics
            const specifics = [];
            document.querySelectorAll('#specificsGrid input[data-specific]').forEach(input => {
                if (input.value) specifics.push(`  ${input.dataset.specific}: ${input.value}`);
            });

            const lines = [
                `=== eBay Listing ===`,
                ``,
                `TITLE: ${title}`,
                `PRICE: $${parseFloat(price).toFixed(2)}`,
                `CONDITION: ${condition} (${condDetail})`,
                `QUANTITY: ${qty}`,
                `CATEGORY: ${category}`,
                upc ? `UPC: ${upc}` : '',
                `SKU: ${sku}`,
                ``,
                `DESCRIPTION:`,
                plainDesc,
                ``,
                specifics.length ? `ITEM SPECIFICS:` : '',
                ...specifics,
                specifics.length ? '' : '',
                `SHIPPING: ${shippingType === 'FREE' ? 'FREE SHIPPING (included in price)' : shippingType} | Weight: ${weightOz}oz`,
                `RETURNS: ${returns}`,
                ``,
                `--- HTML DESCRIPTION (paste into eBay editor) ---`,
                desc,
            ].filter(l => l !== undefined);

            try {
                await navigator.clipboard.writeText(lines.join('\n'));
                showToast('‚úÖ Copied to clipboard!');
            } catch {
                // Fallback for older browsers
                const ta = document.createElement('textarea');
                ta.value = lines.join('\n');
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                ta.remove();
                showToast('‚úÖ Copied to clipboard!');
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // ‚îÄ‚îÄ‚îÄ Save / Post Listing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function saveListing(action) {
            showLoading(
                action === 'ready' ? 'üöÄ Posting to eBay...' : 'üíæ Saving draft...',
                'Please wait...'
            );

            try {
                const listing = {
                    title: document.getElementById('editTitle').value,
                    description: document.getElementById('editDesc').value,
                    category_id: currentListingData?.listing?.category_id || '',
                    category_name: document.getElementById('editCategory').value,
                    condition: document.getElementById('editCondition').value,
                    price: parseFloat(document.getElementById('editPrice').value) || 0,
                    quantity: parseInt(document.getElementById('editQty').value) || 1,
                    cost_price: 0,
                    weight_oz: parseFloat(document.getElementById('editWeightOz').value) || 0,
                    length_in: parseFloat(document.getElementById('editLength').value) || 0,
                    width_in: parseFloat(document.getElementById('editWidth').value) || 0,
                    height_in: parseFloat(document.getElementById('editHeight').value) || 0,
                    shipping_type: shippingType,
                    shipping_cost: shippingType === 'FLAT_RATE' ? parseFloat(document.getElementById('editShipCost').value) || 0 : 0,
                    images: uploadedImages,
                    sku: currentListingData?.listing?.sku || '',
                    status: 'draft',
                    comp_avg_price: currentListingData?.pricing?.avg_sold_price,
                    comp_low_price: currentListingData?.pricing?.lowest_current,
                };

                // Save to database
                const saveResp = await fetch('/ebay/api/listings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(listing),
                });
                const saveData = await saveResp.json();
                if (!saveData.success) throw new Error(saveData.error || 'Save failed');

                // If posting to eBay, call the post endpoint
                if (action === 'ready') {
                    const postResp = await fetch(`/ebay/api/listings/${saveData.listing.id}/post`, {
                        method: 'POST',
                    });
                    const postData = await postResp.json();
                    if (!postData.success) {
                        hideLoading();
                        alert('Saved as draft. eBay posting error: ' + (postData.error || 'Unknown error'));
                        window.location.href = '/ebay/listings';
                        return;
                    }
                    hideLoading();
                    alert(`‚úÖ Listed on eBay!\n${postData.ebay_url || ''}`);
                } else {
                    hideLoading();
                    alert('‚úÖ Draft saved!');
                }

                window.location.href = '/ebay';

            } catch (err) {
                hideLoading();
                alert('Error: ' + err.message);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Auto-Fill eBay via Playwright ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let lastAutofillUrl = '';

        async function autoFillEbay() {
            closeScreenshotModal();
            showLoading(
                'üöÄ Auto-filling eBay listing...',
                'Playwright is opening eBay and filling your listing. This takes 30-60 seconds...'
            );

            try {
                // Build listing data from form
                const listing = {
                    title: document.getElementById('editTitle').value,
                    description: document.getElementById('editDesc').value,
                    category_id: currentListingData?.listing?.category_id || '',
                    category_name: document.getElementById('editCategory').value,
                    condition: document.getElementById('editCondition').value,
                    price: parseFloat(document.getElementById('editPrice').value) || 0,
                    quantity: parseInt(document.getElementById('editQty').value) || 1,
                    cost_price: 0,
                    weight_oz: parseFloat(document.getElementById('editWeightOz').value) || 0,
                    length_in: parseFloat(document.getElementById('editLength').value) || 0,
                    width_in: parseFloat(document.getElementById('editWidth').value) || 0,
                    height_in: parseFloat(document.getElementById('editHeight').value) || 0,
                    shipping_type: shippingType,
                    shipping_cost: 0,
                    images: uploadedImages,
                    sku: currentListingData?.listing?.sku || '',
                    upc: document.getElementById('editUpc')?.value || '',
                };

                // Save as draft first
                const saveResp = await fetch('/ebay/api/listings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...listing, status: 'draft' }),
                });
                const saveData = await saveResp.json();
                if (!saveData.success) throw new Error(saveData.error || 'Failed to save draft');

                const listingId = saveData.listing.id;

                // Update loading message
                document.getElementById('loadingSub').textContent =
                    `Draft saved (#${listingId}). Now filling eBay form...`;

                // Trigger Playwright auto-fill
                const fillResp = await fetch(`/ebay/api/listings/${listingId}/autofill`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(listing),
                });
                const fillData = await fillResp.json();
                hideLoading();

                if (fillData.login_required) {
                    // Login required ‚Äî show listing data + solve option
                    lastAutofillUrl = 'https://www.ebay.com/sl/sell';
                    document.getElementById('modalTitle').textContent = 'üîë Session Expired';
                    document.getElementById('modalMsg').textContent =
                        'eBay needs you to log in. Solve below then retry, or copy your data and list manually.';
                    showListingDataInModal(listing);
                    document.getElementById('modalSolveCaptcha').style.display = 'block';
                    document.getElementById('modalSolveCaptcha').textContent = 'üîë Log In to eBay & Retry';

                    if (fillData.screenshot) {
                        const img = document.getElementById('modalScreenshot');
                        img.src = fillData.screenshot;
                        img.style.display = 'block';
                    }

                    document.getElementById('modalOpenEbay').textContent = 'üìã Copy All & Open eBay';
                    document.getElementById('screenshotModal').classList.add('show');
                } else if (fillData.captcha_detected) {
                    // CAPTCHA detected ‚Äî show listing data + solve option
                    lastAutofillUrl = 'https://www.ebay.com/sl/sell';
                    document.getElementById('modalTitle').textContent = 'üîí CAPTCHA Detected';
                    document.getElementById('modalMsg').textContent =
                        'eBay needs verification. Solve below then retry, or copy your data and list manually.';
                    showListingDataInModal(listing);
                    document.getElementById('modalSolveCaptcha').style.display = 'block';
                    document.getElementById('modalSolveCaptcha').textContent = 'üîì Solve CAPTCHA & Retry';

                    if (fillData.screenshot) {
                        const img = document.getElementById('modalScreenshot');
                        img.src = fillData.screenshot;
                        img.style.display = 'block';
                    }

                    document.getElementById('modalOpenEbay').textContent = 'üìã Copy All & Open eBay';
                    document.getElementById('screenshotModal').classList.add('show');
                } else if (fillData.success) {
                    // Show screenshot modal
                    lastAutofillUrl = fillData.ebay_url || 'https://www.ebay.com/sl/sell';
                    document.getElementById('modalTitle').textContent = '‚úÖ eBay Form Filled!';
                    document.getElementById('modalMsg').textContent =
                        'Review the screenshot below. When ready, click "Open eBay Now" to review and submit.';

                    if (fillData.screenshot) {
                        const img = document.getElementById('modalScreenshot');
                        img.src = fillData.screenshot;
                        img.style.display = 'block';
                    }

                    document.getElementById('screenshotModal').classList.add('show');
                } else {
                    // Show error with screenshot if available
                    const errStep = fillData.step ? ` (at step: ${fillData.step})` : '';
                    document.getElementById('modalTitle').textContent = '‚ö†Ô∏è Auto-Fill Issue';
                    document.getElementById('modalMsg').textContent =
                        (fillData.error || 'Unknown error') + errStep;

                    if (fillData.screenshot) {
                        const img = document.getElementById('modalScreenshot');
                        img.src = fillData.screenshot;
                        img.style.display = 'block';
                    } else {
                        document.getElementById('modalScreenshot').style.display = 'none';
                    }

                    document.getElementById('modalOpenEbay').textContent = 'üìã Copy & List Manually Instead';
                    lastAutofillUrl = 'https://www.ebay.com/sl/sell';
                    document.getElementById('screenshotModal').classList.add('show');
                }

            } catch (err) {
                hideLoading();
                alert('Auto-fill error: ' + err.message);
            }
        }

        function decodeHtmlEntities(text) {
            const ta = document.createElement('textarea');
            ta.innerHTML = text;
            return ta.value;
        }

        function showListingDataInModal(listing) {
            document.getElementById('dataTitle').textContent = decodeHtmlEntities(listing.title || '');
            document.getElementById('dataDesc').textContent = decodeHtmlEntities(listing.description || '');
            document.getElementById('dataPrice').textContent = '$' + (listing.price || 0).toFixed(2);
            document.getElementById('dataCondition').textContent = listing.condition || 'NEW';
            document.getElementById('modalListingData').style.display = 'block';
        }

        function solveCaptchaAndRetry() {
            // Open eBay in a new tab so user can solve CAPTCHA/login
            window.open('https://www.ebay.com/sl/sell', '_blank');
            // Change button text to indicate they should come back and retry
            document.getElementById('modalSolveCaptcha').textContent = '‚úÖ Done? Click Try Again ‚Üì';
            document.getElementById('modalSolveCaptcha').style.background = '#22c55e';
            document.getElementById('modalSolveCaptcha').onclick = null;
        }

        function copyField(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.textContent = '‚úÖ Copied!';
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 1500);
            });
        }

        function copyAllListingData() {
            const title = document.getElementById('dataTitle').textContent;
            const desc = document.getElementById('dataDesc').textContent;
            const price = document.getElementById('dataPrice').textContent;
            const condition = document.getElementById('dataCondition').textContent;
            const text = `${title}\n\n${desc}\n\nPrice: ${price}\nCondition: ${condition}\nShipping: Free`;
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.textContent = '‚úÖ All data copied to clipboard!';
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            });
        }

        function openEbayFromModal() {
            // If listing data is showing, copy to clipboard first
            const dataPanel = document.getElementById('modalListingData');
            if (dataPanel && dataPanel.style.display !== 'none') {
                copyAllListingData();
            }
            // Try eBay app deep link first, fall back to web
            const ebayAppUrl = 'ebay://sell';
            const webUrl = lastAutofillUrl || 'https://www.ebay.com/sl/sell';
            window.location.href = ebayAppUrl;
            setTimeout(() => {
                window.open(webUrl, '_blank');
            }, 1500);
            closeScreenshotModal();
        }

        function closeScreenshotModal() {
            document.getElementById('screenshotModal').classList.remove('show');
            document.getElementById('modalScreenshot').style.display = 'none';
            document.getElementById('modalListingData').style.display = 'none';
            document.getElementById('modalSolveCaptcha').style.display = 'none';
            document.getElementById('modalOpenEbay').textContent = '‚úÖ Looks Good ‚Üí Open eBay Now';
        }

        function resetForm() {
            uploadedImages = [];
            currentListingData = null;
            renderPreviews();
            document.getElementById('step1').style.display = 'block';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('stepBadge').textContent = 'Step 1: Upload';
            document.getElementById('dupeWarning').style.display = 'none';
            document.getElementById('userNotes').value = '';
            window.scrollTo(0, 0);
        }

        // ‚îÄ‚îÄ‚îÄ Loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showLoading(status, sub) {
            document.getElementById('loadingStatus').textContent = status;
            document.getElementById('loadingSub').textContent = sub;
            document.getElementById('loadingOverlay').classList.add('show');
        }
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }
    </script>
</body>

</html>