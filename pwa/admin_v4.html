<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Gem Hunter</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/pwa/css/main.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        midnight: '#05070a',
                        cyan: '#06b6d4',
                        violet: '#7c3aed',
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .admin-table th {
            text-align: left;
            padding: 1.25rem 1.5rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: #64748b;
            font-weight: 800;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .admin-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .admin-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }
    </style>
</head>

<body class="bg-midnight min-h-screen text-white overflow-x-hidden pb-32">

    <!-- Top Nav -->
    <nav class="glass px-6 h-20 flex justify-between items-center sticky top-0 z-50 border-b border-white/5">
        <div class="flex items-center gap-6">
            <a href="/"
                class="flex items-center gap-3 glass py-2 px-4 rounded-xl group hover:border-cyan-400/50 transition-all border-white/5">
                <i class="fas fa-chevron-left text-slate-500 group-hover:text-cyan-400"></i>
                <span class="font-heading font-medium text-sm text-slate-300 group-hover:text-white">Exit
                    Terminal</span>
            </a>
            <div class="h-6 w-px bg-white/10 hidden md:block"></div>
            <h1 class="font-heading font-bold text-xl text-white hidden md:block">Executive Command</h1>
        </div>

        <div class="flex items-center gap-3">
            <div id="statusIndicator" class="flex items-center gap-2 glass px-4 py-2 rounded-xl border-white/5">
                <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div>
                <span class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest">Protocol Active</span>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8 max-w-7xl space-y-10">

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass-card p-8 group transition-all hover:border-cyan-400/30">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-2">Authenticated Users</p>
                <div class="text-3xl font-heading font-bold text-white flex items-center gap-3">
                    <span id="statUsers">--</span>
                    <i class="fas fa-users text-sm text-cyan-400 opacity-50"></i>
                </div>
            </div>
            <div class="glass-card p-8 group transition-all hover:border-violet-400/30">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-2">Total Intel SKUs</p>
                <div class="text-3xl font-heading font-bold text-cyan-400 flex items-center gap-3">
                    <span id="statProducts">--</span>
                    <i class="fas fa-database text-sm opacity-50"></i>
                </div>
            </div>
            <div class="glass-card p-8 border-t-4 border-t-emerald-500/50">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-2">Mainframe Uplink</p>
                <div class="text-3xl font-heading font-bold text-emerald-400 flex items-center gap-3">
                    V4.0.2
                    <div class="flex gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left: User Registry -->
            <div class="lg:col-span-12 glass border border-white/5 rounded-3xl overflow-hidden shadow-2xl relative">
                <div class="p-6 border-b border-white/5 bg-white/[0.02] flex items-center justify-between">
                    <h2 class="font-heading font-bold text-lg flex items-center gap-3">
                        <i class="fas fa-id-badge text-violet-400"></i>
                        Authorized Operators
                    </h2>
                    <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Registry Sync:
                        Active</span>
                </div>
                <div class="overflow-x-auto no-scrollbar">
                    <table class="w-full admin-table">
                        <thead>
                            <tr>
                                <th>Entity</th>
                                <th>Access Level</th>
                                <th>Status</th>
                                <th class="text-right">Operations</th>
                            </tr>
                        </thead>
                        <tbody id="userTable">
                            <tr>
                                <td colspan="4"
                                    class="py-12 text-center text-slate-600 font-bold uppercase tracking-[0.2em]">
                                    Synchronizing Registry...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Full Width: System Mainframe Logs -->
            <div class="lg:col-span-12 glass border border-white/5 rounded-3xl overflow-hidden shadow-2xl relative">
                <div class="p-6 border-b border-white/5 bg-white/[0.02] flex items-center justify-between">
                    <h2 class="font-heading font-bold text-lg flex items-center gap-3">
                        <i class="fas fa-terminal text-cyan-400"></i>
                        System Activity Logs
                    </h2>
                    <button onclick="window.location.reload()"
                        class="text-[10px] font-bold text-slate-500 hover:text-white uppercase tracking-widest transition-colors">Flush
                        Buffer</button>
                </div>
                <div class="overflow-x-auto max-h-[500px] no-scrollbar">
                    <table class="w-full admin-table border-collapse">
                        <thead class="sticky top-0 glass z-10">
                            <tr>
                                <th>Timestamp</th>
                                <th>Operator</th>
                                <th>Protocol</th>
                                <th>Parameters</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody" class="font-mono text-[11px] text-slate-400 tabular-nums">
                            <tr>
                                <td colspan="4" class="py-12 text-center text-slate-600">Established secure link.
                                    Awaiting logs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- System Controls -->
        <div class="glass-card p-8 bg-gradient-to-br from-midnight to-black/40 border-white/10">
            <h3 class="font-heading font-bold text-xl mb-8 flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-cyan-500/10 flex items-center justify-center">
                    <i class="fas fa-gem text-cyan-500 text-sm"></i>
                </div>
                Gem Hunter Controls
            </h3>

            <div class="flex flex-wrap gap-4 mb-8">
                <button onclick="syncCopilot()" id="btnCopilot"
                    class="glass px-6 py-3 rounded-2xl border-emerald-500/30 hover:border-emerald-400 hover:bg-emerald-500/10 text-emerald-400 flex items-center gap-3 transition-all">
                    <i class="fas fa-gem text-xs"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">Sync from Copilot</span>
                </button>

                <button onclick="runCleanup()"
                    class="glass px-6 py-3 rounded-2xl border-amber-500/30 hover:border-amber-400 text-amber-400 flex items-center gap-3 transition-all">
                    <i class="fas fa-broom text-xs"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">Vacuum DB</span>
                </button>
            </div>

            <h4 class="text-xs font-bold text-slate-600 uppercase tracking-widest mb-4">Danger Zone</h4>
            <div class="flex flex-wrap gap-4">
                <button onclick="nukeProducts()"
                    class="glass px-6 py-3 rounded-2xl border-rose-500/30 hover:bg-rose-500 hover:text-white text-rose-500 flex items-center gap-3 transition-all group">
                    <i class="fas fa-radiation text-xs group-hover:animate-spin"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">Absolute Wipe (Nuke)</span>
                </button>
            </div>
        </div>
    </main>

    <script>
        async function loadAdmin() {
            try {
                const pRes = await fetch('/api/oos-stats');
                if (pRes.ok) {
                    const data = await pRes.json();
                    document.getElementById('statProducts').textContent = (data.stats.total_products || 0).toLocaleString();
                }

                const meRes = await fetch('/api/me');
                if (meRes.ok) {
                    const me = await meRes.json();
                    document.getElementById('statUsers').textContent = "1 Master Account";

                    document.getElementById('userTable').innerHTML = `
                        <tr class="admin-row">
                            <td>
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-xl bg-slate-800 p-1 border border-white/5 relative overflow-hidden">
                                        <img src="https://cdn.discordapp.com/avatars/${me.discord_id}/${me.discord_avatar}.png" 
                                             class="w-full h-full object-cover rounded-lg" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                                    </div>
                                    <div>
                                        <p class="font-bold text-white text-sm tracking-tight">${me.discord_username || 'Unknown Operator'}</p>
                                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">ID: ${me.discord_id}</p>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge-premium bg-violet-600/20 text-violet-400 border border-violet-500/30">L5 Admin</span>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div>
                                    <span class="text-[10px] font-bold text-white uppercase">Online</span>
                                </div>
                            </td>
                            <td class="text-right">
                                <button class="text-slate-500 hover:text-white transition-colors"><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>`;
                }

                const logRes = await fetch('/api/admin/activity');
                if (logRes.ok) {
                    const lData = await logRes.json();
                    const rows = (lData.logs || []).map(l => `
                        <tr class="admin-row">
                            <td class="opacity-50">${l.created_at_est || l.created_at}</td>
                            <td class="text-cyan-400 font-bold">${l.username}</td>
                            <td class="text-white">${l.action}</td>
                            <td class="max-w-xs truncate" title="${l.details || ''}">${l.details || "-"}</td>
                        </tr>`).join('');
                    document.getElementById('logTableBody').innerHTML = rows || '<tr><td colspan="4" class="py-8 text-center text-slate-600">ZERO ACTIVITY DETECTED</td></tr>';
                }
            } catch (e) { console.error("Admin Load Error", e); }
        }

        async function syncCopilot() {
            const btn = document.getElementById('btnCopilot');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold uppercase tracking-widest">Syncing...</span>';
            btn.disabled = true;

            try {
                let totalSaved = 0;
                for (let page = 0; page < 20; page++) {
                    const res = await fetch('/api/copilot/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ timeframe: '7d', limit: 50, page })
                    });
                    const data = await res.json();
                    if (data.success) totalSaved += data.saved;
                    await new Promise(r => setTimeout(r, 1500));
                }
                alert(`✅ Copilot Sync Complete! Saved ${totalSaved} products.`);
                window.location.reload();
            } catch (e) {
                alert('Sync Error: ' + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function nukeProducts() {
            if (!confirm("⚠️ PROTOCOL OVERRIDE REQUIRED ⚠️\n\nInitiate full database purge? This action is irreversible.")) return;
            if (!confirm("Final Confirmation: Nuke all products?")) return;

            try {
                const res = await fetch('/api/admin/products/nuke', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keep_favorites: false })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Purge Complete: ${data.deleted} entities removed.`);
                    window.location.reload();
                } else alert('Override Failed: ' + data.error);
            } catch (e) { alert('Critical System Fault: ' + e); }
        }

        async function refreshAllStats() {
            const btn = document.getElementById('btnStats');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold uppercase tracking-widest">Processing...</span>';
            btn.disabled = true;

            try {
                let offset = 0;
                let more = true;
                while (more) {
                    const res = await fetch(`/api/refresh-all-products?limit=100&offset=${offset}`);
                    if (!res.ok) {
                        alert(`Sync Protocol Failed: HTTP ${res.status}. Your session may have expired or you are hitting a rate limit.`);
                        break;
                    }
                    const data = await res.json();
                    if (data.success) {
                        if (data.count < 100) more = false;
                        else offset += 100;
                    } else {
                        alert(`Sync Logic Error: ${data.error || 'Unknown'}`);
                        break;
                    }
                }
                alert('Intelligence Synchronization Complete.');
                window.location.reload();
            } catch (e) { alert('Sync Fault: ' + e); }
            finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function refreshAllImages() {
            const btn = document.getElementById('btnImages');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold uppercase tracking-widest">Signing...</span>';
            btn.disabled = true;

            try {
                const res = await fetch('/api/refresh-images?batch=100&force=true');
                const data = await res.json();
                if (data.success) alert(`Keys Signed: ${data.updated} images renewed.`);
                else alert('Protocol Error: ' + data.error);
            } catch (e) { alert('System Fault: ' + e); }
            finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function runCleanup() {
            try {
                const res = await fetch('/api/cleanup', { method: 'POST' });
                const data = await res.json();
                alert('Buffer Purged: ' + data.message);
                loadAdmin();
            } catch (e) { alert('System Fault: ' + e); }
        }

        document.addEventListener('DOMContentLoaded', loadAdmin);
    </script>
</body>

</html>