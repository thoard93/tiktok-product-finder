<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console | Vantage</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/pwa/css/main.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        midnight: '#020617',
                        slate: {
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        primary: '#2563eb',
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .admin-table th {
            text-align: left;
            padding: 1.25rem 1.5rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: #64748b;
            font-weight: 800;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .admin-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .admin-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }
    </style>
</head>

<body class="bg-slate-950 min-h-screen text-slate-200 overflow-x-hidden pb-32">

    <!-- Top Nav -->
    <nav
        class="bg-slate-900/50 backdrop-blur-md px-6 h-16 flex justify-between items-center sticky top-0 z-50 border-b border-white/5">
        <div class="flex items-center gap-6">
            <a href="/"
                class="flex items-center gap-3 bg-slate-900 py-2 px-4 rounded-xl group hover:border-primary/50 transition-all border border-white/5">
                <i class="fas fa-chevron-left text-slate-500 group-hover:text-primary"></i>
                <span class="font-heading font-medium text-xs text-slate-300 group-hover:text-white">Back to
                    Dashboard</span>
            </a>
            <div class="h-4 w-px bg-white/10 hidden md:block"></div>
            <h1 class="font-heading font-bold text-lg text-white hidden md:block">Admin Console</h1>
        </div>

        <div class="flex items-center gap-3">
            <div id="statusIndicator"
                class="flex items-center gap-2 bg-emerald-500/10 px-3 py-1.5 rounded-full border border-emerald-500/20">
                <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                <span class="text-[9px] font-bold text-emerald-400 uppercase tracking-widest">System Active</span>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8 max-w-7xl space-y-10">

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div
                class="bg-slate-900 border border-white/5 rounded-2xl p-6 group transition-all hover:border-primary/30">
                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-2">Authenticated Users</p>
                <div class="text-2xl font-heading font-bold text-white flex items-center gap-3">
                    <span id="statUsers">--</span>
                    <i class="fas fa-users text-xs text-primary opacity-50"></i>
                </div>
            </div>
            <div
                class="bg-slate-900 border border-white/5 rounded-2xl p-6 group transition-all hover:border-violet-500/30">
                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-2">Total Database SKUs</p>
                <div class="text-2xl font-heading font-bold text-white flex items-center gap-3">
                    <span id="statProducts">--</span>
                    <i class="fas fa-database text-xs text-violet-500 opacity-50"></i>
                </div>
            </div>
            <div class="bg-slate-900 border border-white/5 rounded-2xl p-6 border-t-4 border-t-emerald-500">
                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-2">Platform Version</p>
                <div class="text-2xl font-heading font-bold text-emerald-400 flex items-center gap-3">
                    V4.1.0
                    <div class="flex gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left: User Registry -->
            <div
                class="lg:col-span-12 bg-slate-900 border border-white/5 rounded-2xl overflow-hidden shadow-lg relative">
                <div class="p-5 border-b border-white/5 bg-white/[0.02] flex items-center justify-between">
                    <h2 class="font-heading font-bold text-sm flex items-center gap-3 text-white">
                        <i class="fas fa-id-badge text-violet-500"></i>
                        Authorized Users
                    </h2>
                    <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Registry Sync:
                        Active</span>
                </div>
                <div class="overflow-x-auto no-scrollbar">
                    <table class="w-full admin-table">
                        <thead>
                            <tr>
                                <th>Entity</th>
                                <th>Access Level</th>
                                <th>Status</th>
                                <th class="text-right">Operations</th>
                            </tr>
                        </thead>
                        <tbody id="userTable">
                            <tr>
                                <td colspan="4"
                                    class="py-12 text-center text-slate-600 font-bold uppercase tracking-widest text-xs">
                                    Synchronizing Registry...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Full Width: System Mainframe Logs -->
            <div
                class="lg:col-span-12 bg-slate-900 border border-white/5 rounded-2xl overflow-hidden shadow-lg relative">
                <div class="p-5 border-b border-white/5 bg-white/[0.02] flex items-center justify-between">
                    <h2 class="font-heading font-bold text-sm flex items-center gap-3 text-white">
                        <i class="fas fa-terminal text-primary"></i>
                        Activity Logs
                    </h2>
                    <button onclick="window.location.reload()"
                        class="text-[9px] font-bold text-slate-500 hover:text-white uppercase tracking-widest transition-colors">Refresh
                        Logs</button>
                </div>
                <div class="overflow-x-auto max-h-[500px] no-scrollbar">
                    <table class="w-full admin-table border-collapse">
                        <thead class="sticky top-0 bg-slate-900 z-10 shadow-sm">
                            <tr>
                                <th>Timestamp</th>
                                <th>Operator</th>
                                <th>Protocol</th>
                                <th>Parameters</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody" class="font-mono text-[10px] text-slate-400 tabular-nums">
                            <tr>
                                <td colspan="4" class="py-12 text-center text-slate-600">Connection active.
                                    Awaiting logs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- System Controls -->
        <div class="bg-slate-900 border border-white/5 rounded-2xl p-8 shadow-lg">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-heading font-bold text-lg flex items-center gap-3 text-white">
                    <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center">
                        <i class="fas fa-database text-primary text-xs"></i>
                    </div>
                    Database Controls
                </h3>
                <button onclick="stopSync(this)" id="btnStop" disabled
                    class="bg-rose-600/20 text-rose-500 border border-rose-500/20 px-4 py-2 rounded-xl font-bold uppercase tracking-widest text-[9px] hover:bg-rose-600 hover:text-white disabled:opacity-30 disabled:pointer-events-none transition-all flex items-center gap-2">
                    <i class="fas fa-stop"></i> Stop Current Sync
                </button>
            </div>

            <div class="flex flex-wrap gap-4 mb-8 items-end">
                <div>
                    <label class="block text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-2">Sync
                        Volume</label>
                    <select id="syncPages"
                        class="bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-xs text-white focus:border-primary/50 outline-none transition-all">
                        <option value="20">1,000 Products (Quick)</option>
                        <option value="50">2,500 Products (Standard)</option>
                        <option value="100">5,000 Products (Deep)</option>
                        <option value="200">10,000 Products (Mass)</option>
                        <option value="400">20,000 Products (Mega)</option>
                        <option value="600" selected>30,000 Products (Ultra)</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 bg-slate-950 border border-white/10 rounded-xl px-4 py-3">
                    <input type="checkbox" id="autoEnrich" checked class="w-4 h-4 accent-cyan-500">
                    <label for="autoEnrich"
                        class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Auto-Enrich After
                        Sync</label>
                </div>
                <button onclick="syncCopilot()" id="btnCopilot"
                    class="btn-premium px-8 py-3 shadow-lg shadow-primary/20">
                    <i class="fas fa-bolt mr-2 text-xs"></i>
                    Initiate Sync
                </button>

                <button onclick="runCleanup()"
                    class="bg-slate-950 border border-white/10 px-6 py-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white flex items-center gap-3 transition-all text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-broom text-xs"></i>
                    <span>Optimize Database</span>
                </button>

                <button onclick="enrichVideos()" id="btnEnrichVideos"
                    class="bg-cyan-600 hover:bg-cyan-500 px-6 py-3 rounded-xl text-white flex items-center gap-3 transition-all text-xs font-bold uppercase tracking-widest shadow-lg shadow-cyan-500/20">
                    <i class="fas fa-video text-xs"></i>
                    <span>üìä Manual Enrich</span>
                </button>
            </div>

            <!-- Creator Products Export -->
            <h3 class="font-heading font-bold text-lg mb-6 flex items-center gap-3 mt-10 text-white">
                <div class="w-8 h-8 rounded-lg bg-pink-500/10 flex items-center justify-center">
                    <i class="fas fa-user-circle text-pink-500 text-xs"></i>
                </div>
                Creator Products Export
            </h3>
            <p class="text-slate-400 text-xs mb-4">Extract all products from a specific TikTok affiliate creator and
                export to CSV.</p>

            <div class="flex flex-wrap gap-4 items-end mb-8">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Creator
                        ID</label>
                    <input type="text" id="creatorIdInput" value="7436686228703265838"
                        placeholder="e.g. 7436686228703265838"
                        class="bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-xs font-mono text-pink-400 focus:border-pink-400/50 outline-none transition-all w-64">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Creator
                        Name (for filename)</label>
                    <input type="text" id="creatorNameInput" value="cakedfinds" placeholder="e.g. cakedfinds"
                        class="bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-xs text-white focus:border-pink-400/50 outline-none transition-all w-48">
                </div>
                <button onclick="exportCreatorProducts()" id="btnExportCreator"
                    class="bg-pink-600 hover:bg-pink-500 px-6 py-3 rounded-xl text-white flex items-center gap-3 transition-all text-xs font-bold uppercase tracking-widest shadow-lg shadow-pink-500/20">
                    <i class="fas fa-file-csv text-xs"></i>
                    <span>Export to CSV</span>
                </button>
            </div>

            <!-- Google Sheets Sync Section -->
            <h3 class="font-heading font-bold text-lg mb-6 flex items-center gap-3 mt-10 text-white">
                <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                    <i class="fas fa-table text-emerald-500 text-xs"></i>
                </div>
                Google Sheets Auto-Sync
            </h3>
            <p class="text-slate-400 text-xs mb-4">
                Auto-sync cakedfinds products to Google Sheets.
                <a href="https://console.cloud.google.com/" target="_blank" class="text-emerald-400 underline">Create
                    service account</a>,
                share sheet with the email, paste credentials below.
            </p>

            <div class="space-y-4 max-w-2xl mb-6">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Google
                        Sheet ID</label>
                    <input type="text" id="googleSheetIdInput"
                        placeholder="e.g. 1_ZRoTnG3rd-cE5aZwGY5uFUrffjf6oP2itZZJvt82CY"
                        class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-xs font-mono text-emerald-400 focus:border-emerald-400/50 outline-none transition-all">
                    <p class="text-slate-600 text-[10px] mt-1">From URL:
                        docs.google.com/spreadsheets/d/<strong>[SHEET_ID]</strong>/edit</p>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Service
                        Account JSON</label>
                    <textarea id="googleCredsInput" rows="4"
                        placeholder='{"type": "service_account", "project_id": "...", "private_key_id": "...", ...}'
                        class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-xs font-mono text-slate-400 focus:border-emerald-400/50 outline-none transition-all resize-none"></textarea>
                </div>
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label
                            class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Auto-Sync
                            Frequency</label>
                        <select id="googleSyncFrequency"
                            class="bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-xs text-white focus:border-emerald-400/50 outline-none transition-all">
                            <option value="manual">Manual Only</option>
                            <option value="daily">Daily</option>
                            <option value="3days" selected>Every 3 Days</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                    <button onclick="saveGoogleSheetsConfig()"
                        class="px-6 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold uppercase tracking-widest transition-all shadow-lg shadow-emerald-500/20">
                        Save Config
                    </button>
                    <button onclick="syncToGoogleSheets()" id="btnSyncSheets"
                        class="px-6 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold uppercase tracking-widest transition-all flex items-center gap-2">
                        <i class="fas fa-sync text-xs"></i>
                        Sync Now
                    </button>
                </div>
                <p id="lastSyncTime" class="text-slate-600 text-[10px]">Last sync: Never</p>
            </div>

            <h3 class="font-heading font-bold text-lg mb-6 flex items-center gap-3 mt-10 text-white">
                <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                    <i class="fas fa-cookie-bite text-emerald-500 text-xs"></i>
                </div>
                TikTokCopilot Configuration
            </h3>

            <div class="space-y-6 max-w-2xl mb-10">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Session
                        Cookie (Direct String)</label>
                    <div class="flex gap-4">
                        <textarea id="copilotCookieInput" rows="3"
                            placeholder="_ga=...; __session=...; __session_pOM46XQh=..."
                            class="flex-1 bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-xs font-mono text-emerald-400 focus:border-emerald-400/50 outline-none transition-all resize-none"></textarea>
                    </div>
                    <div class="mt-3 flex gap-4">
                        <button onclick="saveCopilotCookie()"
                            class="px-6 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold uppercase tracking-widest transition-all shadow-lg shadow-emerald-500/20">
                            Save Cookie
                        </button>
                        <button onclick="testCopilotCookie()" id="btnTestCookie"
                            class="px-6 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold uppercase tracking-widest transition-all border border-white/5">
                            Test Connection
                        </button>
                    </div>
                </div>

                <!-- Legacy Auto-Refresh Section removed - now using Playwright 2FA below -->
            </div>

            <!-- 2FA Playwright Authentication Section -->
            <h3 class="font-heading font-bold text-lg mb-6 flex items-center gap-3 mt-10 text-white">
                <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-shield-alt text-primary text-xs"></i>
                </div>
                Playwright 2FA Authentication
            </h3>
            <p class="text-slate-400 text-xs mb-4">
                Authenticate with TikTokCopilot using Playwright + 2FA. Session persists in database (survives deploys).
            </p>

            <div class="space-y-4 max-w-2xl mb-10">
                <!-- Status -->
                <div class="flex items-center gap-4 mb-4">
                    <div class="flex items-center gap-2">
                        <div id="auth2faIndicator" class="w-2 h-2 rounded-full bg-slate-600"></div>
                        <span id="auth2faStatus" class="text-xs text-slate-400">Checking status...</span>
                    </div>
                    <button onclick="checkAuth2faStatus()"
                        class="text-[10px] text-slate-500 hover:text-white uppercase tracking-widest">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh Status
                    </button>
                </div>

                <!-- Step 1: Initiate -->
                <div class="p-4 rounded-xl bg-slate-800/50 border border-white/5">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Step 1: Start Login
                    </p>
                    <div class="flex flex-wrap gap-3 items-center">
                        <button onclick="initiateCopilotAuth()" id="btnInitiateAuth"
                            class="px-5 py-2.5 rounded-xl bg-primary hover:bg-blue-600 text-white text-xs font-bold uppercase tracking-widest transition-all shadow-lg shadow-primary/20 flex items-center gap-2">
                            <i class="fas fa-key text-xs"></i>
                            Start Login
                        </button>
                        <span class="text-[10px] text-slate-500">This will send a 2FA code to your email</span>
                    </div>
                </div>

                <!-- Step 2: Verify -->
                <div class="p-4 rounded-xl bg-slate-800/50 border border-white/5">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Step 2: Enter Code
                    </p>
                    <div class="flex flex-wrap gap-3 items-end">
                        <div>
                            <label
                                class="block text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-2">6-Digit
                                Code from Email</label>
                            <input type="text" id="auth2faCodeInput" placeholder="123456" maxlength="6"
                                class="bg-slate-950 border border-white/10 rounded-xl px-4 py-2.5 text-lg font-mono text-emerald-400 focus:border-emerald-400/50 outline-none transition-all w-36 text-center tracking-[0.5em]">
                        </div>
                        <button onclick="verifyCopilotAuth()" id="btnVerifyAuth"
                            class="px-5 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold uppercase tracking-widest transition-all shadow-lg shadow-emerald-500/20 flex items-center gap-2">
                            <i class="fas fa-check text-xs"></i>
                            Verify Code
                        </button>
                    </div>
                </div>

                <p id="auth2faMessage" class="text-xs text-slate-400 hidden"></p>
            </div>

            <h3 class="font-heading font-bold text-lg mb-6 flex items-center gap-3 mt-10 text-white">
                <div class="w-8 h-8 rounded-lg bg-violet-500/10 flex items-center justify-center">
                    <i class="fas fa-robot text-violet-500 text-xs"></i>
                </div>
                AI Configuration
            </h3>

            <div class="space-y-6 max-w-2xl">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Anthropic
                        API Key</label>
                    <div class="flex gap-4">
                        <input type="password" id="anthropicKeyInput" placeholder="sk-ant-..."
                            class="flex-1 bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-xs font-mono text-cyan-400 focus:border-cyan-400/50 outline-none transition-all">
                        <button onclick="saveAnthropicKey()"
                            class="px-6 py-3 rounded-xl bg-violet-600 hover:bg-violet-500 text-white text-xs font-bold uppercase tracking-widest transition-all shadow-lg shadow-violet-500/20">
                            Save Key
                        </button>
                    </div>
                </div>
            </div>

            <h4
                class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-4 mt-12 border-t border-white/5 pt-8">
                Danger Zone</h4>
            <div class="flex flex-wrap gap-4">
                <button onclick="toggleMaintenanceMode()" id="btnMaintenance"
                    class="bg-amber-950/20 border border-amber-500/20 px-6 py-3 rounded-xl hover:bg-amber-500 hover:text-white text-amber-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-tools text-xs group-hover:animate-spin"></i>
                    <span id="maintenanceBtnText">Enable Maintenance</span>
                </button>
                <button onclick="restoreHiddenProducts()" id="btnRestoreHidden"
                    class="bg-emerald-950/20 border border-emerald-500/20 px-6 py-3 rounded-xl hover:bg-emerald-500 hover:text-white text-emerald-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-eye text-xs"></i>
                    <span>Restore Hidden Products</span>
                </button>
                <button onclick="initBrandHunter()" id="btnInitBrands"
                    class="bg-cyan-950/20 border border-cyan-500/20 px-6 py-3 rounded-xl hover:bg-cyan-500 hover:text-white text-cyan-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-database text-xs"></i>
                    <span>Init Brand Hunter</span>
                </button>
                <button onclick="resetBrandHunter()" id="btnResetBrands"
                    class="bg-violet-950/20 border border-violet-500/20 px-6 py-3 rounded-xl hover:bg-violet-500 hover:text-white text-violet-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-bullseye text-xs"></i>
                    <span>Reset Brand Hunter</span>
                </button>
                <button onclick="cleanupZeroSales()" id="btnCleanZeroSales"
                    class="bg-amber-950/20 border border-amber-500/20 px-6 py-3 rounded-xl hover:bg-amber-500 hover:text-white text-amber-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-trash-alt text-xs"></i>
                    <span>Delete 0 7D Sales</span>
                </button>
                <button onclick="cleanupZeroStats()" id="btnCleanZero"
                    class="bg-amber-950/20 border border-amber-500/20 px-6 py-3 rounded-xl hover:bg-amber-500 hover:text-white text-amber-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-trash-alt text-xs"></i>
                    <span>Delete 0-Stat Products</span>
                </button>
                <button onclick="deleteLowVideos()" id="btnDeleteLowVideos"
                    class="bg-orange-950/20 border border-orange-500/20 px-6 py-3 rounded-xl hover:bg-orange-500 hover:text-white text-orange-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-video-slash text-xs"></i>
                    <span>Delete &lt;20 Videos</span>
                </button>
                <button onclick="nukeProducts()"
                    class="bg-rose-950/20 border border-rose-500/20 px-6 py-3 rounded-xl hover:bg-rose-500 hover:text-white text-rose-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-radiation text-xs group-hover:animate-spin"></i>
                    <span>System Reset</span>
                </button>
                <button onclick="nukeBrandHunter()"
                    class="bg-rose-950/20 border border-rose-500/20 px-6 py-3 rounded-xl hover:bg-rose-500 hover:text-white text-rose-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-bomb text-xs group-hover:animate-bounce"></i>
                    <span>Nuke Brand Hunter</span>
                </button>
                <button onclick="cleanupFull()"
                    class="bg-indigo-950/20 border border-indigo-500/20 px-6 py-3 rounded-xl hover:bg-indigo-500 hover:text-white text-indigo-400 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-broom text-xs group-hover:animate-pulse"></i>
                    <span>Deep Clean Brands</span>
                </button>
                <button onclick="runMigrations()" id="btnMigrate"
                    class="bg-teal-950/20 border border-teal-500/20 px-6 py-3 rounded-xl hover:bg-teal-500 hover:text-white text-teal-400 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-database text-xs group-hover:animate-pulse"></i>
                    <span>Run Migrations</span>
                </button>
            </div>
        </div>
    </main>

    <script>
        async function loadAdmin() {
            try {
                const pRes = await fetch('/api/oos-stats');
                if (pRes.ok) {
                    const data = await pRes.json();
                    document.getElementById('statProducts').textContent = (data.stats.total_products || 0).toLocaleString();
                }

                const meRes = await fetch('/api/me');
                if (meRes.ok) {
                    const me = await meRes.json();
                    document.getElementById('statUsers').textContent = "1 Master Account";

                    document.getElementById('userTable').innerHTML = `
                        <tr class="admin-row">
                            <td>
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-xl bg-slate-800 p-1 border border-white/5 relative overflow-hidden">
                                        <img src="https://cdn.discordapp.com/avatars/${me.discord_id}/${me.discord_avatar}.png" 
                                             class="w-full h-full object-cover rounded-lg" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                                    </div>
                                    <div>
                                        <p class="font-bold text-white text-sm tracking-tight">${me.discord_username || 'Unknown Operator'}</p>
                                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">ID: ${me.discord_id}</p>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge-premium bg-violet-600/20 text-violet-400 border border-violet-500/30">L5 Admin</span>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div>
                                    <span class="text-[10px] font-bold text-white uppercase">Online</span>
                                </div>
                            </td>
                            <td class="text-right">
                                <button class="text-slate-500 hover:text-white transition-colors"><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>`;
                }

                const logRes = await fetch('/api/admin/activity');
                if (logRes.ok) {
                    const lData = await logRes.json();
                    const rows = (lData.logs || []).map(l => `
                        <tr class="admin-row">
                            <td class="opacity-50">${l.created_at_est || l.created_at}</td>
                            <td class="text-cyan-400 font-bold">${l.username}</td>
                            <td class="text-white">${l.action}</td>
                            <td class="max-w-xs truncate" title="${l.details || ''}">${l.details || "-"}</td>
                        </tr>`).join('');
                    document.getElementById('logTableBody').innerHTML = rows || '<tr><td colspan="4" class="py-8 text-center text-slate-600">ZERO ACTIVITY DETECTED</td></tr>';
                }

                // Load existing keys (masked for safety)
                const configRes = await fetch('/api/admin/config/ANTHROPIC_API_KEY');
                if (configRes.ok) {
                    const cData = await configRes.json();
                    if (cData.value) {
                        document.getElementById('anthropicKeyInput').value = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
                    }
                }

                const cookieRes = await fetch('/api/admin/config/TIKTOK_COPILOT_COOKIE');
                if (cookieRes.ok) {
                    const ckData = await cookieRes.json();
                    if (ckData.value) {
                        document.getElementById('copilotCookieInput').value = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (Active Cookie Set)";
                    }
                }
            } catch (e) { console.error("Admin Load Error", e); }
        }

        async function saveAnthropicKey() {
            const key = document.getElementById('anthropicKeyInput').value;
            if (!key || key.includes('‚Ä¢')) return alert("Please enter a valid key.");

            try {
                const res = await fetch('/api/admin/config/ANTHROPIC_API_KEY', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: key })
                });
                const data = await res.json();
                if (data.success) {
                    alert("Anthropic API Key secured and saved!");
                    document.getElementById('anthropicKeyInput').value = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
                } else alert("Error: " + data.error);
            } catch (e) { alert("Fault: " + e); }
        }

        async function saveCopilotCookie() {
            const cookie = document.getElementById('copilotCookieInput').value;
            if (!cookie || cookie.includes('‚Ä¢')) return alert("Please enter a valid cookie string.");

            try {
                const res = await fetch('/api/admin/config/TIKTOK_COPILOT_COOKIE', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: cookie })
                });
                const data = await res.json();
                if (data.success) {
                    alert("TikTokCopilot Cookie updated successfully!");
                    document.getElementById('copilotCookieInput').value = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (Active Cookie Set)";
                } else alert("Error: " + data.error);
            } catch (e) { alert("Fault: " + e); }
        }

        async function testCopilotCookie() {
            const btn = document.getElementById('btnTestCookie');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/copilot/test');
                const data = await res.json();
                if (data.success) {
                    alert("‚úÖ Connection Successful! " + (data.message || "Cookie is valid."));
                } else {
                    alert("‚ùå Connection Failed: " + (data.error || "Cookie may be invalid or expired."));
                    console.log("Test Resp:", data);
                }
            } catch (e) {
                alert("‚ùå Connection Fault: " + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        // Legacy refreshCopilotSession and checkAutoRefreshStatus removed - using Playwright 2FA now

        // Check status on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth2faStatus();
            // Check 2FA status every 5 minutes
            setInterval(checkAuth2faStatus, 300000);
        });

        // ============ 2FA AUTHENTICATION FUNCTIONS ============

        async function checkAuth2faStatus() {
            const indicator = document.getElementById('auth2faIndicator');
            const status = document.getElementById('auth2faStatus');

            try {
                const res = await fetch('/api/copilot-auth/status');
                const data = await res.json();

                if (data.sessionValid) {
                    indicator.className = 'w-2 h-2 rounded-full bg-emerald-500 animate-pulse';
                    status.textContent = '‚úì Session Active - ' + (data.sessionCookies?.length || 0) + ' cookies';
                    status.className = 'text-xs text-emerald-400';
                } else if (data.pendingSignIn) {
                    indicator.className = 'w-2 h-2 rounded-full bg-amber-500 animate-pulse';
                    status.textContent = '‚è≥ Awaiting 2FA Code';
                    status.className = 'text-xs text-amber-400';
                } else {
                    indicator.className = 'w-2 h-2 rounded-full bg-slate-600';
                    status.textContent = 'No active session';
                    status.className = 'text-xs text-slate-400';
                }
            } catch (e) {
                indicator.className = 'w-2 h-2 rounded-full bg-rose-500';
                status.textContent = 'Error checking status';
                status.className = 'text-xs text-rose-400';
            }
        }

        async function initiateCopilotAuth() {
            const btn = document.getElementById('btnInitiateAuth');
            const msg = document.getElementById('auth2faMessage');
            const original = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            btn.disabled = true;
            msg.className = 'text-xs text-slate-400 hidden';

            try {
                const res = await fetch('/api/copilot-auth/initiate', { method: 'POST' });
                const data = await res.json();

                if (data.status === 'needs_2fa') {
                    msg.textContent = 'üìß Check your email for the 6-digit code, then enter it below!';
                    msg.className = 'text-xs text-amber-400 p-3 bg-amber-500/10 rounded-lg border border-amber-500/20';
                    checkAuth2faStatus();
                } else if (data.status === 'complete') {
                    msg.textContent = '‚úÖ Login successful! No 2FA needed. Session saved.';
                    msg.className = 'text-xs text-emerald-400 p-3 bg-emerald-500/10 rounded-lg border border-emerald-500/20';
                    checkAuth2faStatus();
                } else if (data.error) {
                    msg.textContent = '‚ùå Error: ' + data.error;
                    msg.className = 'text-xs text-rose-400 p-3 bg-rose-500/10 rounded-lg border border-rose-500/20';
                } else {
                    msg.textContent = '‚ö†Ô∏è Unexpected response: ' + JSON.stringify(data);
                    msg.className = 'text-xs text-amber-400';
                }
            } catch (e) {
                msg.textContent = '‚ùå Connection Error: ' + e.message;
                msg.className = 'text-xs text-rose-400 p-3 bg-rose-500/10 rounded-lg border border-rose-500/20';
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function verifyCopilotAuth() {
            const btn = document.getElementById('btnVerifyAuth');
            const codeInput = document.getElementById('auth2faCodeInput');
            const msg = document.getElementById('auth2faMessage');
            const code = codeInput.value.trim();
            const original = btn.innerHTML;

            if (!code || code.length !== 6) {
                alert('Please enter the 6-digit code from your email.');
                codeInput.focus();
                return;
            }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/copilot-auth/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });
                const data = await res.json();

                if (data.status === 'complete') {
                    msg.textContent = '‚úÖ ' + (data.message || '2FA Verified! Session saved to database.');
                    msg.className = 'text-xs text-emerald-400 p-3 bg-emerald-500/10 rounded-lg border border-emerald-500/20';
                    codeInput.value = '';
                    checkAuth2faStatus();
                } else if (data.error) {
                    msg.textContent = '‚ùå Error: ' + data.error;
                    msg.className = 'text-xs text-rose-400 p-3 bg-rose-500/10 rounded-lg border border-rose-500/20';
                } else {
                    msg.textContent = '‚ö†Ô∏è Unexpected: ' + JSON.stringify(data);
                    msg.className = 'text-xs text-amber-400';
                }
            } catch (e) {
                msg.textContent = '‚ùå Verification Error: ' + e.message;
                msg.className = 'text-xs text-rose-400 p-3 bg-rose-500/10 rounded-lg border border-rose-500/20';
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        let isStopRequested = false;

        async function stopSync(btn) {
            isStopRequested = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';
            try {
                await fetch('/api/copilot/stop-sync', { method: 'POST' });
                alert("üõë Stop signal sent! Background syncs will terminate shortly.");
            } catch (e) {
                console.error("Stop signal error:", e);
                alert("Error sending stop signal: " + e.message);
            } finally {
                // Reset button after a short delay
                setTimeout(() => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-stop"></i> Stop Current Sync';
                }, 1500);
            }
        }

        async function syncCopilot() {
            const btn = document.getElementById('btnCopilot');
            const stopBtn = document.getElementById('btnStop');
            const pageSelect = document.getElementById('syncPages');
            const autoEnrichCheckbox = document.getElementById('autoEnrich');
            const maxPages = parseInt(pageSelect.value || 20);
            const targetProducts = maxPages * 50; // ~50 products per page
            const original = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold uppercase tracking-widest">Starting...</span>';
            btn.disabled = true;
            stopBtn.disabled = false;

            try {
                // Reset backend state
                try { await fetch('/api/copilot/reset-sync', { method: 'POST' }); } catch (e) { }

                // Use server-side mass-sync (runs in background - can close browser!)
                const autoEnrichEnabled = autoEnrichCheckbox && autoEnrichCheckbox.checked;
                const res = await fetch('/api/copilot/mass-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target: targetProducts,
                        timeframe: 'all',  // All-time for video/creator counts
                        auto_enrich: autoEnrichEnabled
                    })
                });
                const data = await res.json();

                if (data.status === 'success') {
                    let msg = `üöÄ SYNC STARTED (Server-Side)\n\n${data.message}\n\n`;
                    msg += `‚úÖ You can close this page - sync runs in background on server.\n`;
                    msg += `üìä Check Render logs for progress.`;
                    if (autoEnrichEnabled) {
                        msg += `\n\nüîÑ Auto-enrich will run after sync completes.`;
                    }
                    alert(msg);
                } else {
                    alert('‚ùå Sync Error: ' + (data.message || data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Sync Error: ' + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
                stopBtn.disabled = false; // Keep stop enabled for background task
            }
        }

        async function nukeProducts() {
            if (!confirm("‚ö†Ô∏è PROTOCOL OVERRIDE REQUIRED ‚ö†Ô∏è\n\nInitiate full database purge? This action is irreversible.")) return;
            if (!confirm("Final Confirmation: Nuke all products?")) return;

            try {
                const res = await fetch('/api/admin/products/nuke', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keep_favorites: false })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Purge Complete: ${data.deleted} entities removed.`);
                    window.location.reload();
                } else alert('Override Failed: ' + data.error);
            } catch (e) { alert('Critical System Fault: ' + e); }
        }

        async function refreshAllStats() {
            const btn = document.getElementById('btnStats');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold uppercase tracking-widest">Processing...</span>';
            btn.disabled = true;

            try {
                let offset = 0;
                let more = true;
                while (more) {
                    const res = await fetch(`/api/refresh-all-products?limit=100&offset=${offset}`);
                    if (!res.ok) {
                        alert(`Sync Protocol Failed: HTTP ${res.status}. Your session may have expired or you are hitting a rate limit.`);
                        break;
                    }
                    const data = await res.json();
                    if (data.success) {
                        if (data.count < 100) more = false;
                        else offset += 100;
                    } else {
                        alert(`Sync Logic Error: ${data.error || 'Unknown'}`);
                        break;
                    }
                }
                alert('Intelligence Synchronization Complete.');
                window.location.reload();
            } catch (e) { alert('Sync Fault: ' + e); }
            finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function refreshAllImages() {
            const btn = document.getElementById('btnImages');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold uppercase tracking-widest">Signing...</span>';
            btn.disabled = true;

            try {
                const res = await fetch('/api/refresh-images?batch=100&force=true');
                const data = await res.json();
                if (data.success) alert(`Keys Signed: ${data.updated} images renewed.`);
                else alert('Protocol Error: ' + data.error);
            } catch (e) { alert('System Fault: ' + e); }
            finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function massSyncProducts(target) {
            const btnId = target >= 10000 ? 'btnMassSync10K' : 'btnMassSync5K';
            const btn = document.getElementById(btnId);
            const stopBtn = document.getElementById('btnStop');
            const original = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold">Starting...</span>';
            btn.disabled = true;
            stopBtn.disabled = false;

            try {
                // Reset backend state
                try { await fetch('/api/copilot/reset-sync', { method: 'POST' }); } catch (e) { }

                const res = await fetch('/api/copilot/mass-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: target, timeframe: '7d' })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`üöÄ SYNC STARTED!\n\n${data.message}\n\n‚è≥ Running in background. Use the STOP button above if you need to cancel.`);
                } else {
                    alert('‚ùå Sync Error: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
                // Leave stop button enabled for background task
            }
        }

        async function nuclearSync() {
            if (!confirm("‚ò¢Ô∏è NUCLEAR SYNC - 100,000+ PRODUCTS\n\n‚ö†Ô∏è This will:\n‚Ä¢ Fetch up to 2000 pages of products\n‚Ä¢ Take 10-15 minutes to complete\n‚Ä¢ Use significant API resources\n\nAre you absolutely sure?")) return;

            const btn = document.getElementById('btnNuclearSync');
            const stopBtn = document.getElementById('btnStop');
            const original = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold">‚ò¢Ô∏è STARTING...</span>';
            btn.disabled = true;
            btn.classList.remove('animate-pulse');
            stopBtn.disabled = false;

            try {
                // Reset backend state
                try { await fetch('/api/copilot/reset-sync', { method: 'POST' }); } catch (e) { }

                const res = await fetch('/api/copilot/mass-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: 100000, timeframe: '7d' })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`‚ò¢Ô∏è NUCLEAR SYNC STARTED!\n\n${data.message}\n\n‚è≥ This runs in the background. Use the STOP button above to cancel if needed.`);
                } else {
                    alert('‚ùå Nuclear Sync Error: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
                btn.classList.add('animate-pulse');
            }
        }

        async function enrichVideos() {
            if (!confirm("üìä ENRICH ALL-TIME STATS\n\nThis will fetch ALL-TIME video counts AND creator counts for products in the database.\n\nThese values will be preserved during regular syncs.\n\nProceed?")) return;

            const btn = document.getElementById('btnEnrichVideos');
            const stopBtn = document.getElementById('btnStop');
            const original = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold">ENRICHING...</span>';
            btn.disabled = true;
            stopBtn.disabled = false;

            try {
                // Reset backend state
                try { await fetch('/api/copilot/reset-sync', { method: 'POST' }); } catch (e) { }

                const res = await fetch('/api/copilot/enrich-videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pages: 2000 })  // 2000 pages x ~50 products = ~100K coverage
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`üìä All-Time Stats Enrichment started!\n\n${data.message}\n\n‚è≥ Running in background. Use the STOP button above if needed.`);
                } else {
                    alert('‚ùå Enrichment Error: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function restoreHiddenProducts() {
            if (!confirm("üëÅÔ∏è Restore all hidden products?\n\nThis will make valid products (20+ videos, sales > 0) visible again.")) return;

            const btn = document.getElementById('btnRestoreHidden');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restoring...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/admin/reset-product-status', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`‚úÖ Restore Complete!\n\n${data.message}`);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function resetBrandHunter() {
            if (!confirm("üéØ RESET BRAND HUNTER?\n\nThis will remove all tracked brands from Brand Hunter.\n\nProducts are NOT affected - only the brand tracking list.")) return;

            const btn = document.getElementById('btnResetBrands');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/brands/clear-all', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ Brand Hunter Reset!\n\n${data.message}`);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function initBrandHunter() {
            const btn = document.getElementById('btnInitBrands');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Initializing...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/brands/init', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function nukeBrandHunter() {
            if (!confirm("‚ò¢Ô∏è NUCLEAR BRAND RESET?\\n\\nThis will DROP the entire Watched Brands table and recreate it.\\n\\nONLY use this if brands won't clear or are stuck on 'undefined'.")) return;
            if (!confirm("‚ö†Ô∏è FINAL WARNING: This cannot be undone.")) return;

            const btn = event.currentTarget;
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> NUKING...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/brands/nuke', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`‚ò¢Ô∏è ${data.message}`);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function cleanupFull() {
            if (!confirm("üßπ DEEP CLEAN BRAND SYSTEM?\\n\\nThis will purge all 'undefined', 'null', and empty brands from BOTH the Brand Hunter table and the Product table.")) return;

            const btn = event.currentTarget;
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CLEANING...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/brands/cleanup-full', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`‚ú® ${data.message}`);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function cleanupZeroSales() {
            if (!confirm("üóëÔ∏è Delete all products with 0 7D Sales?\n\nThis will remove products that haven't sold in the last 7 days.")) return;

            const btn = document.getElementById('btnCleanZeroSales');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/cleanup/zero-sales', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`‚úÖ Cleanup Complete!\n\n${data.message}`);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function cleanupZeroStats() {
            if (!confirm("Delete all products with 0 sales, 0 GMV, and 0 ad spend?\n\n(Favorites are protected)")) return;

            const btn = document.getElementById('btnCleanZero');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/admin/cleanup-zero-stats', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ Cleanup Complete: Deleted ${data.deleted} products with zero stats.`);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function deleteLowVideos() {
            if (!confirm("üóëÔ∏è Delete products with <20 total videos?\n\nThis will remove placeholder products with few videos.\n\n(Favorites are NOT protected)")) return;

            const btn = document.getElementById('btnDeleteLowVideos');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/admin/delete-low-videos', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ Cleanup Complete!\n\n${data.message}`);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function runCleanup() {
            try {
                const res = await fetch('/api/cleanup', { method: 'POST' });
                const data = await res.json();
                alert('Buffer Purged: ' + data.message);
                loadAdmin();
            } catch (e) { alert('System Fault: ' + e); }
        }

        async function runMigrations() {
            const btn = document.getElementById('btnMigrate');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/admin/migrate', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ Migrations Complete!\\n\\n${(data.results || []).join('\\n')}`);
                } else {
                    alert('‚ùå Migration Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function exportCreatorProducts() {
            const creatorId = document.getElementById('creatorIdInput').value.trim();
            const creatorName = document.getElementById('creatorNameInput').value.trim() || 'creator';

            if (!creatorId) {
                alert('Please enter a Creator ID');
                return;
            }

            const btn = document.getElementById('btnExportCreator');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/copilot/creator-products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        creator_id: creatorId,
                        creator_name: creatorName,
                        max_pages: 100,  // ~2500 products max
                        delay: 3.0
                    })
                });

                if (res.ok) {
                    // Download the CSV file
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${creatorName}_products.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    alert(`‚úÖ Export Complete! Downloaded ${creatorName}_products.csv`);
                } else {
                    const data = await res.json();
                    alert('‚ùå Export Error: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        // Google Sheets Sync Functions
        async function loadGoogleSheetsConfig() {
            try {
                const res = await fetch('/api/admin/google-sheets-config');
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('googleSheetIdInput').value = data.sheet_id || '';
                    document.getElementById('googleCredsInput').value = data.credentials ? '(credentials saved)' : '';
                    document.getElementById('googleSyncFrequency').value = data.frequency || '3days';
                    if (data.last_sync) {
                        document.getElementById('lastSyncTime').textContent = 'Last sync: ' + new Date(data.last_sync).toLocaleString();
                    }
                }
            } catch (e) { console.log('Google Sheets config not loaded:', e); }
        }

        async function saveGoogleSheetsConfig() {
            const sheetId = document.getElementById('googleSheetIdInput').value.trim();
            const credentials = document.getElementById('googleCredsInput').value.trim();
            const frequency = document.getElementById('googleSyncFrequency').value;

            if (!sheetId) {
                alert('Please enter a Google Sheet ID');
                return;
            }

            try {
                const body = { sheet_id: sheetId, frequency: frequency };
                // Only send credentials if they're not the placeholder
                if (credentials && credentials !== '(credentials saved)') {
                    body.credentials = credentials;
                }

                const res = await fetch('/api/admin/google-sheets-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Google Sheets config saved!');
                    document.getElementById('googleCredsInput').value = '(credentials saved)';
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e.message);
            }
        }

        async function syncToGoogleSheets() {
            const btn = document.getElementById('btnSyncSheets');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            btn.disabled = true;

            try {
                const creatorId = document.getElementById('creatorIdInput').value.trim();
                const creatorName = document.getElementById('creatorNameInput').value.trim() || 'creator';

                const res = await fetch('/api/admin/google-sheets-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ creator_id: creatorId, creator_name: creatorName })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ Synced ${data.rows} products to Google Sheets!`);
                    document.getElementById('lastSyncTime').textContent = 'Last sync: ' + new Date().toLocaleString();
                } else {
                    alert('‚ùå Sync Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        // ===== MAINTENANCE MODE =====
        let isMaintenanceMode = false;

        async function checkMaintenanceStatus() {
            try {
                const res = await fetch('/api/maintenance/status');
                const data = await res.json();
                isMaintenanceMode = data.maintenance;
                updateMaintenanceButton();
            } catch (e) {
                console.log('Maintenance status check failed:', e);
            }
        }

        function updateMaintenanceButton() {
            const btn = document.getElementById('btnMaintenance');
            const text = document.getElementById('maintenanceBtnText');
            if (!btn || !text) return; // Elements not loaded yet

            if (isMaintenanceMode) {
                btn.classList.remove('bg-amber-950/20', 'border-amber-500/20', 'text-amber-500', 'hover:bg-amber-500');
                btn.classList.add('bg-emerald-950/20', 'border-emerald-500/20', 'text-emerald-500', 'hover:bg-emerald-500');
                text.textContent = 'Disable Maintenance';
            } else {
                btn.classList.remove('bg-emerald-950/20', 'border-emerald-500/20', 'text-emerald-500', 'hover:bg-emerald-500');
                btn.classList.add('bg-amber-950/20', 'border-amber-500/20', 'text-amber-500', 'hover:bg-amber-500');
                text.textContent = 'Enable Maintenance';
            }
        }

        async function toggleMaintenanceMode() {
            const action = isMaintenanceMode ? 'disable' : 'enable';
            const confirmMsg = isMaintenanceMode
                ? 'Disable maintenance mode? Site will be accessible again.'
                : '‚ö†Ô∏è Enable maintenance mode?\n\nThis will:\n‚Ä¢ Block all site access\n‚Ä¢ Stop all background automation\n\nVisitors will see a maintenance page.';

            if (!confirm(confirmMsg)) return;

            const btn = document.getElementById('btnMaintenance');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            btn.disabled = true;

            try {
                const res = await fetch(`/api/maintenance/${action}`, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    isMaintenanceMode = !isMaintenanceMode;
                    updateMaintenanceButton();
                    alert(data.message);

                    if (isMaintenanceMode) {
                        // Redirect to maintenance page after enabling
                        setTimeout(() => window.location.href = '/maintenance', 1000);
                    }
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Error: ' + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
                updateMaintenanceButton();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAdmin();
            loadGoogleSheetsConfig();
            checkMaintenanceStatus();
        });
    </script>
</body>

</html>