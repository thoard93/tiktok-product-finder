<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console | Vantage</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/pwa/css/main.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        midnight: '#020617',
                        slate: {
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        primary: '#2563eb',
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .admin-table th {
            text-align: left;
            padding: 1.25rem 1.5rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: #64748b;
            font-weight: 800;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .admin-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .admin-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }
    </style>
</head>

<body class="bg-slate-950 min-h-screen text-slate-200 overflow-x-hidden pb-32">

    <!-- Top Nav -->
    <nav
        class="bg-slate-900/50 backdrop-blur-md px-6 h-16 flex justify-between items-center sticky top-0 z-50 border-b border-white/5">
        <div class="flex items-center gap-6">
            <a href="/"
                class="flex items-center gap-3 bg-slate-900 py-2 px-4 rounded-xl group hover:border-primary/50 transition-all border border-white/5">
                <i class="fas fa-chevron-left text-slate-500 group-hover:text-primary"></i>
                <span class="font-heading font-medium text-xs text-slate-300 group-hover:text-white">Back to
                    Dashboard</span>
            </a>
            <div class="h-4 w-px bg-white/10 hidden md:block"></div>
            <h1 class="font-heading font-bold text-lg text-white hidden md:block">Admin Console</h1>
        </div>

        <div class="flex items-center gap-3">
            <div id="statusIndicator"
                class="flex items-center gap-2 bg-emerald-500/10 px-3 py-1.5 rounded-full border border-emerald-500/20">
                <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                <span class="text-[9px] font-bold text-emerald-400 uppercase tracking-widest">System Active</span>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8 max-w-7xl space-y-10">

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div
                class="bg-slate-900 border border-white/5 rounded-2xl p-6 group transition-all hover:border-primary/30">
                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-2">Authenticated Users</p>
                <div class="text-2xl font-heading font-bold text-white flex items-center gap-3">
                    <span id="statUsers">--</span>
                    <i class="fas fa-users text-xs text-primary opacity-50"></i>
                </div>
            </div>
            <div
                class="bg-slate-900 border border-white/5 rounded-2xl p-6 group transition-all hover:border-violet-500/30">
                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-2">Total Database SKUs</p>
                <div class="text-2xl font-heading font-bold text-white flex items-center gap-3">
                    <span id="statProducts">--</span>
                    <i class="fas fa-database text-xs text-violet-500 opacity-50"></i>
                </div>
            </div>
            <div class="bg-slate-900 border border-white/5 rounded-2xl p-6 border-t-4 border-t-emerald-500">
                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-2">Platform Version</p>
                <div class="text-2xl font-heading font-bold text-emerald-400 flex items-center gap-3">
                    V4.1.0
                    <div class="flex gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left: User Registry -->
            <div
                class="lg:col-span-12 bg-slate-900 border border-white/5 rounded-2xl overflow-hidden shadow-lg relative">
                <div class="p-5 border-b border-white/5 bg-white/[0.02] flex items-center justify-between">
                    <h2 class="font-heading font-bold text-sm flex items-center gap-3 text-white">
                        <i class="fas fa-id-badge text-violet-500"></i>
                        Authorized Users
                    </h2>
                    <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Registry Sync:
                        Active</span>
                </div>
                <div class="overflow-x-auto no-scrollbar">
                    <table class="w-full admin-table">
                        <thead>
                            <tr>
                                <th>Entity</th>
                                <th>Access Level</th>
                                <th>Status</th>
                                <th class="text-right">Operations</th>
                            </tr>
                        </thead>
                        <tbody id="userTable">
                            <tr>
                                <td colspan="4"
                                    class="py-12 text-center text-slate-600 font-bold uppercase tracking-widest text-xs">
                                    Synchronizing Registry...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Full Width: System Mainframe Logs -->
            <div
                class="lg:col-span-12 bg-slate-900 border border-white/5 rounded-2xl overflow-hidden shadow-lg relative">
                <div class="p-5 border-b border-white/5 bg-white/[0.02] flex items-center justify-between">
                    <h2 class="font-heading font-bold text-sm flex items-center gap-3 text-white">
                        <i class="fas fa-terminal text-primary"></i>
                        Activity Logs
                    </h2>
                    <button onclick="window.location.reload()"
                        class="text-[9px] font-bold text-slate-500 hover:text-white uppercase tracking-widest transition-colors">Refresh
                        Logs</button>
                </div>
                <div class="overflow-x-auto max-h-[500px] no-scrollbar">
                    <table class="w-full admin-table border-collapse">
                        <thead class="sticky top-0 bg-slate-900 z-10 shadow-sm">
                            <tr>
                                <th>Timestamp</th>
                                <th>Operator</th>
                                <th>Protocol</th>
                                <th>Parameters</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody" class="font-mono text-[10px] text-slate-400 tabular-nums">
                            <tr>
                                <td colspan="4" class="py-12 text-center text-slate-600">Connection active.
                                    Awaiting logs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- System Controls -->
        <div class="bg-slate-900 border border-white/5 rounded-2xl p-8 shadow-lg">
            <h3 class="font-heading font-bold text-lg mb-6 flex items-center gap-3 text-white">
                <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-database text-primary text-xs"></i>
                </div>
                Database Controls
            </h3>

            <div class="flex flex-wrap gap-4 mb-8">
                <button onclick="syncCopilot()" id="btnCopilot"
                    class="btn-premium px-6 py-3 shadow-lg shadow-primary/20">
                    <i class="fas fa-bolt mr-2"></i>
                    Quick Sync (1K)
                </button>

                <button onclick="massSyncProducts(10000)" id="btnMassSync5K"
                    class="bg-emerald-600 hover:bg-emerald-500 px-6 py-3 rounded-xl text-white flex items-center gap-3 transition-all text-xs font-bold uppercase tracking-widest shadow-lg shadow-emerald-500/20">
                    <i class="fas fa-rocket text-xs"></i>
                    <span>Mass Sync (10K)</span>
                </button>

                <button onclick="massSyncProducts(25000)" id="btnMassSync10K"
                    class="bg-violet-600 hover:bg-violet-500 px-6 py-3 rounded-xl text-white flex items-center gap-3 transition-all text-xs font-bold uppercase tracking-widest shadow-lg shadow-violet-500/20">
                    <i class="fas fa-meteor text-xs"></i>
                    <span>MEGA Sync (25K)</span>
                </button>

                <button onclick="massSyncProducts(50000)" id="btnMassSync50K"
                    class="bg-rose-600 hover:bg-rose-500 px-6 py-3 rounded-xl text-white flex items-center gap-3 transition-all text-xs font-bold uppercase tracking-widest shadow-lg shadow-rose-500/20">
                    <i class="fas fa-fire text-xs"></i>
                    <span>ULTRA Sync (50K)</span>
                </button>

                <button onclick="nuclearSync()" id="btnNuclearSync"
                    class="bg-gradient-to-r from-amber-500 via-orange-500 to-red-600 hover:from-amber-400 hover:via-orange-400 hover:to-red-500 px-6 py-3 rounded-xl text-white flex items-center gap-3 transition-all text-xs font-bold uppercase tracking-widest shadow-lg shadow-orange-500/30 animate-pulse">
                    <i class="fas fa-radiation text-xs"></i>
                    <span>‚ò¢Ô∏è NUCLEAR (100K+)</span>
                </button>

                <button onclick="runCleanup()"
                    class="bg-slate-950 border border-white/10 px-6 py-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white flex items-center gap-3 transition-all text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-broom text-xs"></i>
                    <span>Optimize Database</span>
                </button>

                <button onclick="enrichVideos()" id="btnEnrichVideos"
                    class="bg-cyan-600 hover:bg-cyan-500 px-6 py-3 rounded-xl text-white flex items-center gap-3 transition-all text-xs font-bold uppercase tracking-widest shadow-lg shadow-cyan-500/20">
                    <i class="fas fa-video text-xs"></i>
                    <span>üìä Enrich Videos (All-Time)</span>
                </button>
            </div>

            <h3 class="font-heading font-bold text-lg mb-6 flex items-center gap-3 mt-10 text-white">
                <div class="w-8 h-8 rounded-lg bg-violet-500/10 flex items-center justify-center">
                    <i class="fas fa-robot text-violet-500 text-xs"></i>
                </div>
                AI Configuration
            </h3>

            <div class="space-y-6 max-w-2xl">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Anthropic
                        API Key</label>
                    <div class="flex gap-4">
                        <input type="password" id="anthropicKeyInput" placeholder="sk-ant-..."
                            class="flex-1 bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-xs font-mono text-cyan-400 focus:border-cyan-400/50 outline-none transition-all">
                        <button onclick="saveAnthropicKey()"
                            class="px-6 py-3 rounded-xl bg-violet-600 hover:bg-violet-500 text-white text-xs font-bold uppercase tracking-widest transition-all shadow-lg shadow-violet-500/20">
                            Save Key
                        </button>
                    </div>
                </div>
            </div>

            <h4
                class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-4 mt-12 border-t border-white/5 pt-8">
                Danger Zone</h4>
            <div class="flex flex-wrap gap-4">
                <button onclick="restoreHiddenProducts()" id="btnRestoreHidden"
                    class="bg-emerald-950/20 border border-emerald-500/20 px-6 py-3 rounded-xl hover:bg-emerald-500 hover:text-white text-emerald-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-eye text-xs"></i>
                    <span>Restore Hidden Products</span>
                </button>
                <button onclick="initBrandHunter()" id="btnInitBrands"
                    class="bg-cyan-950/20 border border-cyan-500/20 px-6 py-3 rounded-xl hover:bg-cyan-500 hover:text-white text-cyan-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-database text-xs"></i>
                    <span>Init Brand Hunter</span>
                </button>
                <button onclick="resetBrandHunter()" id="btnResetBrands"
                    class="bg-violet-950/20 border border-violet-500/20 px-6 py-3 rounded-xl hover:bg-violet-500 hover:text-white text-violet-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-bullseye text-xs"></i>
                    <span>Reset Brand Hunter</span>
                </button>
                <button onclick="cleanupZeroSales()" id="btnCleanZeroSales"
                    class="bg-amber-950/20 border border-amber-500/20 px-6 py-3 rounded-xl hover:bg-amber-500 hover:text-white text-amber-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-trash-alt text-xs"></i>
                    <span>Delete 0 7D Sales</span>
                </button>
                <button onclick="cleanupZeroStats()" id="btnCleanZero"
                    class="bg-amber-950/20 border border-amber-500/20 px-6 py-3 rounded-xl hover:bg-amber-500 hover:text-white text-amber-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-trash-alt text-xs"></i>
                    <span>Delete 0-Stat Products</span>
                </button>
                <button onclick="nukeProducts()"
                    class="bg-rose-950/20 border border-rose-500/20 px-6 py-3 rounded-xl hover:bg-rose-500 hover:text-white text-rose-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-radiation text-xs group-hover:animate-spin"></i>
                    <span>System Reset</span>
                </button>
                <button onclick="nukeBrandHunter()"
                    class="bg-rose-950/20 border border-rose-500/20 px-6 py-3 rounded-xl hover:bg-rose-500 hover:text-white text-rose-500 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-bomb text-xs group-hover:animate-bounce"></i>
                    <span>Nuke Brand Hunter</span>
                </button>
                <button onclick="cleanupFull()"
                    class="bg-indigo-950/20 border border-indigo-500/20 px-6 py-3 rounded-xl hover:bg-indigo-500 hover:text-white text-indigo-400 flex items-center gap-3 transition-all group text-xs font-bold uppercase tracking-widest">
                    <i class="fas fa-broom text-xs group-hover:animate-pulse"></i>
                    <span>Deep Clean Brands</span>
                </button>
            </div>
        </div>
    </main>

    <script>
        async function loadAdmin() {
            try {
                const pRes = await fetch('/api/oos-stats');
                if (pRes.ok) {
                    const data = await pRes.json();
                    document.getElementById('statProducts').textContent = (data.stats.total_products || 0).toLocaleString();
                }

                const meRes = await fetch('/api/me');
                if (meRes.ok) {
                    const me = await meRes.json();
                    document.getElementById('statUsers').textContent = "1 Master Account";

                    document.getElementById('userTable').innerHTML = `
                        <tr class="admin-row">
                            <td>
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-xl bg-slate-800 p-1 border border-white/5 relative overflow-hidden">
                                        <img src="https://cdn.discordapp.com/avatars/${me.discord_id}/${me.discord_avatar}.png" 
                                             class="w-full h-full object-cover rounded-lg" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                                    </div>
                                    <div>
                                        <p class="font-bold text-white text-sm tracking-tight">${me.discord_username || 'Unknown Operator'}</p>
                                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">ID: ${me.discord_id}</p>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge-premium bg-violet-600/20 text-violet-400 border border-violet-500/30">L5 Admin</span>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div>
                                    <span class="text-[10px] font-bold text-white uppercase">Online</span>
                                </div>
                            </td>
                            <td class="text-right">
                                <button class="text-slate-500 hover:text-white transition-colors"><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>`;
                }

                const logRes = await fetch('/api/admin/activity');
                if (logRes.ok) {
                    const lData = await logRes.json();
                    const rows = (lData.logs || []).map(l => `
                        <tr class="admin-row">
                            <td class="opacity-50">${l.created_at_est || l.created_at}</td>
                            <td class="text-cyan-400 font-bold">${l.username}</td>
                            <td class="text-white">${l.action}</td>
                            <td class="max-w-xs truncate" title="${l.details || ''}">${l.details || "-"}</td>
                        </tr>`).join('');
                    document.getElementById('logTableBody').innerHTML = rows || '<tr><td colspan="4" class="py-8 text-center text-slate-600">ZERO ACTIVITY DETECTED</td></tr>';
                }

                // Load existing keys (masked for safety)
                const configRes = await fetch('/api/admin/config/ANTHROPIC_API_KEY');
                if (configRes.ok) {
                    const cData = await configRes.json();
                    if (cData.value) {
                        document.getElementById('anthropicKeyInput').value = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
                    }
                }
            } catch (e) { console.error("Admin Load Error", e); }
        }

        async function saveAnthropicKey() {
            const key = document.getElementById('anthropicKeyInput').value;
            if (!key || key.includes('‚Ä¢')) return alert("Please enter a valid key.");

            try {
                const res = await fetch('/api/admin/config/ANTHROPIC_API_KEY', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: key })
                });
                const data = await res.json();
                if (data.success) {
                    alert("Anthropic API Key secured and saved!");
                    document.getElementById('anthropicKeyInput').value = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
                } else alert("Error: " + data.error);
            } catch (e) { alert("Fault: " + e); }
        }

        async function syncCopilot() {
            const btn = document.getElementById('btnCopilot');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold uppercase tracking-widest">Syncing...</span>';
            btn.disabled = true;

            try {
                let totalSaved = 0;
                for (let page = 0; page < 20; page++) {
                    const res = await fetch('/api/copilot/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ timeframe: '7d', limit: 50, page })
                    });
                    const data = await res.json();
                    if (data.success) totalSaved += data.saved;
                    await new Promise(r => setTimeout(r, 1500));
                }
                alert(`‚úÖ Copilot Sync Complete! Saved ${totalSaved} products.`);
                window.location.reload();
            } catch (e) {
                alert('Sync Error: ' + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function nukeProducts() {
            if (!confirm("‚ö†Ô∏è PROTOCOL OVERRIDE REQUIRED ‚ö†Ô∏è\n\nInitiate full database purge? This action is irreversible.")) return;
            if (!confirm("Final Confirmation: Nuke all products?")) return;

            try {
                const res = await fetch('/api/admin/products/nuke', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keep_favorites: false })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Purge Complete: ${data.deleted} entities removed.`);
                    window.location.reload();
                } else alert('Override Failed: ' + data.error);
            } catch (e) { alert('Critical System Fault: ' + e); }
        }

        async function refreshAllStats() {
            const btn = document.getElementById('btnStats');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold uppercase tracking-widest">Processing...</span>';
            btn.disabled = true;

            try {
                let offset = 0;
                let more = true;
                while (more) {
                    const res = await fetch(`/api/refresh-all-products?limit=100&offset=${offset}`);
                    if (!res.ok) {
                        alert(`Sync Protocol Failed: HTTP ${res.status}. Your session may have expired or you are hitting a rate limit.`);
                        break;
                    }
                    const data = await res.json();
                    if (data.success) {
                        if (data.count < 100) more = false;
                        else offset += 100;
                    } else {
                        alert(`Sync Logic Error: ${data.error || 'Unknown'}`);
                        break;
                    }
                }
                alert('Intelligence Synchronization Complete.');
                window.location.reload();
            } catch (e) { alert('Sync Fault: ' + e); }
            finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function refreshAllImages() {
            const btn = document.getElementById('btnImages');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold uppercase tracking-widest">Signing...</span>';
            btn.disabled = true;

            try {
                const res = await fetch('/api/refresh-images?batch=100&force=true');
                const data = await res.json();
                if (data.success) alert(`Keys Signed: ${data.updated} images renewed.`);
                else alert('Protocol Error: ' + data.error);
            } catch (e) { alert('System Fault: ' + e); }
            finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function massSyncProducts(target) {
            const btnId = target >= 10000 ? 'btnMassSync10K' : 'btnMassSync5K';
            const btn = document.getElementById(btnId);
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold">Starting...</span>';
            btn.disabled = true;

            try {
                const res = await fetch('/api/copilot/mass-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: target, timeframe: '7d' })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`üöÄ SYNC STARTED!\n\n${data.message}\n\n‚è≥ Running in background. Refresh the dashboard in a few minutes to see new products.`);
                } else {
                    alert('‚ùå Sync Error: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function nuclearSync() {
            if (!confirm("‚ò¢Ô∏è NUCLEAR SYNC - 100,000+ PRODUCTS\n\n‚ö†Ô∏è This will:\n‚Ä¢ Fetch up to 2000 pages of products\n‚Ä¢ Take 10-15 minutes to complete\n‚Ä¢ Use significant API resources\n\nAre you absolutely sure?")) return;

            const btn = document.getElementById('btnNuclearSync');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold">‚ò¢Ô∏è STARTING...</span>';
            btn.disabled = true;
            btn.classList.remove('animate-pulse');

            try {
                const res = await fetch('/api/copilot/mass-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: 100000, timeframe: '7d' })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`‚ò¢Ô∏è NUCLEAR SYNC STARTED!\n\n${data.message}\n\n‚è≥ This runs in the background and may take 5-10 minutes.\n\nüìä Check Render logs for progress, then refresh this page to see new products.`);
                    // Don't reload - let them see the message
                } else {
                    alert('‚ùå Nuclear Sync Error: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
                btn.classList.add('animate-pulse');
            }
        }

        async function enrichVideos() {
            if (!confirm("üìä ENRICH VIDEO COUNTS\\n\\nThis will fetch ALL-TIME video counts for products in the database.\\n\\nThis runs alongside your 7D sales data to give you full saturation metrics.\\n\\nProceed?")) return;

            const btn = document.getElementById('btnEnrichVideos');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> <span class="text-xs font-bold">ENRICHING...</span>';
            btn.disabled = true;

            try {
                const res = await fetch('/api/copilot/enrich-videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ limit: 1000 })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`üìä Video Enrichment Complete!\\n\\n${data.message}\\n\\n‚úÖ ${data.enriched} products updated with all-time video counts.`);
                } else {
                    alert('‚ùå Enrichment Error: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function restoreHiddenProducts() {
            if (!confirm("üëÅÔ∏è Restore all hidden products?\n\nThis will make valid products (20+ videos, sales > 0) visible again.")) return;

            const btn = document.getElementById('btnRestoreHidden');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restoring...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/admin/reset-product-status', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`‚úÖ Restore Complete!\n\n${data.message}`);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function resetBrandHunter() {
            if (!confirm("üéØ RESET BRAND HUNTER?\n\nThis will remove all tracked brands from Brand Hunter.\n\nProducts are NOT affected - only the brand tracking list.")) return;

            const btn = document.getElementById('btnResetBrands');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/brands/clear-all', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ Brand Hunter Reset!\n\n${data.message}`);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function initBrandHunter() {
            const btn = document.getElementById('btnInitBrands');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Initializing...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/brands/init', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function nukeBrandHunter() {
            if (!confirm("‚ò¢Ô∏è NUCLEAR BRAND RESET?\\n\\nThis will DROP the entire Watched Brands table and recreate it.\\n\\nONLY use this if brands won't clear or are stuck on 'undefined'.")) return;
            if (!confirm("‚ö†Ô∏è FINAL WARNING: This cannot be undone.")) return;

            const btn = event.currentTarget;
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> NUKING...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/brands/nuke', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`‚ò¢Ô∏è ${data.message}`);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function cleanupFull() {
            if (!confirm("üßπ DEEP CLEAN BRAND SYSTEM?\\n\\nThis will purge all 'undefined', 'null', and empty brands from BOTH the Brand Hunter table and the Product table.")) return;

            const btn = event.currentTarget;
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CLEANING...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/brands/cleanup-full', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`‚ú® ${data.message}`);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function cleanupZeroSales() {
            if (!confirm("üóëÔ∏è Delete all products with 0 7D Sales?\n\nThis will remove products that haven't sold in the last 7 days.")) return;

            const btn = document.getElementById('btnCleanZeroSales');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/cleanup/zero-sales', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`‚úÖ Cleanup Complete!\n\n${data.message}`);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function cleanupZeroStats() {
            if (!confirm("Delete all products with 0 sales, 0 GMV, and 0 ad spend?\n\n(Favorites are protected)")) return;

            const btn = document.getElementById('btnCleanZero');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/admin/cleanup-zero-stats', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ Cleanup Complete: Deleted ${data.deleted} products with zero stats.`);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (e) {
                alert('System Fault: ' + e);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        async function runCleanup() {
            try {
                const res = await fetch('/api/cleanup', { method: 'POST' });
                const data = await res.json();
                alert('Buffer Purged: ' + data.message);
                loadAdmin();
            } catch (e) { alert('System Fault: ' + e); }
        }

        document.addEventListener('DOMContentLoaded', loadAdmin);
    </script>
</body>

</html>