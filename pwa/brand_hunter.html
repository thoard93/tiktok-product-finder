<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Brand Hunter</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding-bottom: 120px;
        }
        
        .header {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            text-align: center;
        }
        
        .header h1 { font-size: 1.5rem; margin-bottom: 3px; }
        .header p { color: #888; font-size: 0.8rem; }
        
        .content { padding: 12px; }
        
        /* Search Bar */
        .search-container {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 0.9rem;
        }
        
        .search-input::placeholder { color: #666; }
        
        .search-btn {
            padding: 10px 16px;
            background: #e94560;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Stats Card */
        .stats-card {
            background: linear-gradient(135deg, #e94560, #0f3460);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.3rem; font-weight: bold; }
        .stat-label { font-size: 0.65rem; color: rgba(255,255,255,0.7); }
        
        /* Date Filter Pills */
        .date-filter {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .date-pill {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.2);
            color: #fff;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .date-pill.active {
            background: #e94560;
            border-color: #e94560;
        }
        
        /* Sort Dropdown */
        .sort-container {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .sort-label {
            font-size: 0.8rem;
            color: #888;
        }
        
        .sort-select {
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .sort-select option {
            background: #1a1a2e;
        }
        
        /* Scan Settings Card */
        .scan-settings {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .scan-settings h4 {
            color: #e94560;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }
        
        .scan-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .scan-tab {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.2);
            color: #fff;
            font-size: 0.8rem;
            cursor: pointer;
            text-align: center;
        }
        
        .scan-tab.active {
            background: #e94560;
            border-color: #e94560;
        }
        
        .scan-panel {
            display: none;
        }
        
        .scan-panel.active {
            display: block;
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .setting-row label {
            font-size: 0.85rem;
            color: #ccc;
        }
        
        .setting-row input, .setting-row select {
            width: 100px;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #fff;
            text-align: center;
        }
        
        .setting-hint {
            font-size: 0.7rem;
            color: #888;
            margin-top: 4px;
        }
        
        .setting-warning {
            font-size: 0.75rem;
            color: #ffc107;
            background: rgba(255,193,7,0.1);
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        /* Deep Scan Brand Input */
        .brand-input-container {
            margin-bottom: 10px;
        }
        
        .brand-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .brand-suggestions {
            display: none;
            background: rgba(0,0,0,0.9);
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .brand-suggestions.show {
            display: block;
        }
        
        .brand-suggestion {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .brand-suggestion:hover {
            background: rgba(233,69,96,0.3);
        }
        
        /* Filter Pills */
        .filter-pills {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .pill {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.2);
            color: #fff;
            font-size: 0.75rem;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .pill.active {
            background: #e94560;
            border-color: #e94560;
        }
        
        .pill .count {
            background: rgba(0,0,0,0.3);
            padding: 1px 5px;
            border-radius: 8px;
            font-size: 0.65rem;
        }
        
        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        
        .product-card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        
        .product-card:hover {
            transform: scale(1.02);
        }
        
        .product-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: #333;
        }
        
        .product-info {
            padding: 8px;
        }
        
        .product-name {
            font-size: 0.7rem;
            line-height: 1.2;
            height: 2.4em;
            overflow: hidden;
            margin-bottom: 4px;
        }
        
        .product-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.65rem;
        }
        
        .commission-badge {
            background: #4ade80;
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.6rem;
        }
        
        .commission-badge.low {
            background: #fbbf24;
        }
        
        .commission-badge.very-low {
            background: #f87171;
            color: #fff;
        }
        
        .influencer-badge {
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.65rem;
        }
        
        .influencer-badge.hot { background: #e94560; }
        .influencer-badge.warm { background: #f97316; }
        .influencer-badge.cool { background: #3b82f6; }
        
        .favorite-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            background: rgba(0,0,0,0.5);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            z-index: 10;
        }
        
        .favorite-btn:hover { background: rgba(0,0,0,0.7); transform: scale(1.1); }
        .favorite-btn.active { background: #e94560; }
        
        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.98);
            padding: 12px;
            display: flex;
            gap: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .nav-btn {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .nav-btn.primary {
            background: linear-gradient(135deg, #e94560, #f97316);
            color: #fff;
        }
        
        .nav-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .nav-btn.tools {
            background: rgba(59, 130, 246, 0.3);
            color: #3b82f6;
            flex: 0.5;
        }
        
        /* Tools Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h3 {
            margin-bottom: 15px;
            color: #e94560;
        }
        
        .modal-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 10px;
            text-align: left;
        }
        
        .modal-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .modal-btn .icon {
            margin-right: 10px;
        }
        
        .modal-close {
            margin-top: 10px;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: transparent;
            color: #fff;
            cursor: pointer;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.85rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 90%;
            text-align: center;
        }
        
        .toast.show { opacity: 1; }
        .toast.error { background: #e94560; }
        .toast.success { background: #10b981; }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        
        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        /* Collapsible */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .collapsible-header .toggle {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }
        
        .collapsible-header.collapsed .toggle {
            transform: rotate(-90deg);
        }
        
        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s;
        }
        
        .collapsible-content.collapsed {
            max-height: 0;
        }
        
        /* Strategy Info */
        .strategy-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .strategy-card h4 {
            color: #3b82f6;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        
        .strategy-card p {
            font-size: 0.75rem;
            color: #888;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Brand Hunter</h1>
        <p>Find hidden gems from top brands</p>
    </div>
    
    <div class="content">
        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" class="search-input" id="brand-search" placeholder="üîç Search brands..." onkeyup="if(event.key==='Enter')applyFilters()">
            <button class="search-btn" onclick="applyFilters()">Search</button>
        </div>
        
        <!-- Date Filters -->
        <div class="date-filter">
            <button class="date-pill active" onclick="setDateFilter('all', this)">All Time</button>
            <button class="date-pill" onclick="setDateFilter('today', this)">Today</button>
            <button class="date-pill" onclick="setDateFilter('yesterday', this)">Yesterday</button>
            <button class="date-pill" onclick="setDateFilter('7days', this)">Last 7 Days</button>
            <button class="date-pill" onclick="setDateFilter('favorites', this)">‚ù§Ô∏è Favorites</button>
        </div>
        
        <!-- Stats Card -->
        <div class="stats-card">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="stat-products">0</div>
                    <div class="stat-label">Products Found</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-brands">0</div>
                    <div class="stat-label">Brands Scanned</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-untapped">0</div>
                    <div class="stat-label">üî• Untapped (1-10)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-low">0</div>
                    <div class="stat-label">üíé Low (11-30)</div>
                </div>
            </div>
        </div>
        
        <!-- Sort Options -->
        <div class="sort-container">
            <span class="sort-label">Sort by:</span>
            <select class="sort-select" id="sort-select" onchange="applySort()">
                <option value="sales_7d">üìà 7-Day Sales</option>
                <option value="commission">üí∞ Commission %</option>
                <option value="influencers_asc">üë§ Influencers (Low‚ÜíHigh)</option>
                <option value="influencers_desc">üë§ Influencers (High‚ÜíLow)</option>
                <option value="newest">üÜï Newest First</option>
                <option value="price_high">üíµ Price (High‚ÜíLow)</option>
                <option value="price_low">üíµ Price (Low‚ÜíHigh)</option>
            </select>
        </div>
        
        <!-- Scan Settings -->
        <div class="scan-settings">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <h4>‚öôÔ∏è Scan Settings</h4>
                <span class="toggle">‚ñº</span>
            </div>
            <div class="collapsible-content">
                <!-- Scan Type Tabs -->
                <div class="scan-tabs">
                    <button class="scan-tab active" onclick="setScanTab('quick', this)">‚ö° Quick Scan</button>
                    <button class="scan-tab" onclick="setScanTab('deep', this)">üîç Deep Scan</button>
                    <button class="scan-tab" onclick="setScanTab('brand', this)">üè∑Ô∏è Brand Scan</button>
                </div>
                
                <!-- Quick Scan Panel -->
                <div class="scan-panel active" id="panel-quick">
                    <div class="setting-row">
                        <label>Start from rank:</label>
                        <input type="number" id="start-rank" value="1" min="1" max="500">
                    </div>
                    <div class="setting-row">
                        <label>Brands to scan:</label>
                        <input type="number" id="num-brands" value="10" min="1" max="50">
                    </div>
                    <div class="setting-row">
                        <label>Pages per brand:</label>
                        <input type="number" id="pages-per-brand" value="5" min="1" max="10">
                    </div>
                    <div class="setting-row">
                        <label>Max influencers:</label>
                        <input type="number" id="max-influencers" value="100" min="1" max="500">
                    </div>
                    <div class="setting-row">
                        <label>Min 7-day sales:</label>
                        <input type="number" id="min-sales" value="0" min="0">
                    </div>
                    <div class="setting-warning">
                        ‚ö° Quick Scan: ~1-2 min for 10 brands √ó 5 pages. Products are saved automatically.
                    </div>
                </div>
                
                <!-- Deep Scan Panel -->
                <div class="scan-panel" id="panel-deep">
                    <div class="setting-row">
                        <label>Start from rank:</label>
                        <input type="number" id="deep-start-rank" value="1" min="1" max="500">
                    </div>
                    <div class="setting-row">
                        <label>Brands to scan:</label>
                        <input type="number" id="deep-num-brands" value="5" min="1" max="20">
                    </div>
                    <div class="setting-row">
                        <label>Start page:</label>
                        <input type="number" id="deep-start-page" value="50" min="1" max="200">
                    </div>
                    <div class="setting-row">
                        <label>End page:</label>
                        <input type="number" id="deep-end-page" value="100" min="1" max="200">
                    </div>
                    <div class="setting-row">
                        <label>Max influencers:</label>
                        <input type="number" id="deep-max-influencers" value="50" min="1" max="500">
                    </div>
                    <div class="setting-warning">
                        üîç Deep Scan: Scans pages 50-100+ where hidden gems hide. Takes longer but finds products others miss!
                    </div>
                </div>
                
                <!-- Brand Scan Panel -->
                <div class="scan-panel" id="panel-brand">
                    <div class="brand-input-container">
                        <input type="text" class="brand-input" id="brand-scan-input" placeholder="Search for a brand (e.g. QVC, Tarte, PopMart)..." oninput="searchBrands(this.value)">
                        <div class="brand-suggestions" id="brand-suggestions"></div>
                    </div>
                    <div class="setting-row">
                        <label>Selected Brand:</label>
                        <span id="selected-brand-name" style="color:#4ade80;">None</span>
                    </div>
                    <input type="hidden" id="selected-brand-id" value="">
                    <div class="setting-row">
                        <label>Start page:</label>
                        <input type="number" id="brand-start-page" value="1" min="1" max="200">
                    </div>
                    <div class="setting-row">
                        <label>End page:</label>
                        <input type="number" id="brand-end-page" value="50" min="1" max="200">
                    </div>
                    <div class="setting-row">
                        <label>Max influencers:</label>
                        <input type="number" id="brand-max-influencers" value="100" min="1" max="500">
                    </div>
                    <div class="setting-warning">
                        üè∑Ô∏è Brand Scan: Deep dive into a specific brand. Great for brands like QVC, Tarte, PopMart that have lots of products!
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Influencer Filter Pills -->
        <div class="filter-pills">
            <button class="pill active" onclick="filterProducts('all', this)">
                All <span class="count" id="count-all">0</span>
            </button>
            <button class="pill" onclick="filterProducts('untapped', this)">
                üî• 1-10 <span class="count" id="count-untapped">0</span>
            </button>
            <button class="pill" onclick="filterProducts('low', this)">
                üíé 11-30 <span class="count" id="count-low">0</span>
            </button>
            <button class="pill" onclick="filterProducts('medium', this)">
                üìä 31-60 <span class="count" id="count-medium">0</span>
            </button>
            <button class="pill" onclick="filterProducts('good', this)">
                ‚úÖ 61-100 <span class="count" id="count-good">0</span>
            </button>
        </div>
        
        <!-- Products Grid -->
        <div id="products-container" class="product-grid">
            <div class="empty-state" style="grid-column: 1/-1;">
                <div class="icon">üîç</div>
                <p>No products yet</p>
                <p style="font-size:0.85rem; margin-top:10px;">Click "Scan" to start finding gems!</p>
            </div>
        </div>
    </div>
    
    <!-- Tools Modal -->
    <div class="modal-overlay" id="tools-modal">
        <div class="modal">
            <h3>üõ†Ô∏è Tools</h3>
            <button class="modal-btn" onclick="refreshImages()">
                <span class="icon">üñºÔ∏è</span> Refresh All Images
            </button>
            <button class="modal-btn" onclick="cleanupProducts()">
                <span class="icon">üßπ</span> Cleanup (Remove 0% Commission)
            </button>
            <button class="modal-btn" onclick="exportFavorites()">
                <span class="icon">üì§</span> Export Favorites to CSV
            </button>
            <button class="modal-btn" onclick="viewStats()">
                <span class="icon">üìä</span> View Database Stats
            </button>
            <button class="modal-close" onclick="closeModal()">Close</button>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn tools" onclick="openModal()">üõ†Ô∏è</button>
        <button class="nav-btn secondary" onclick="loadProducts()">‚Üª Refresh</button>
        <button class="nav-btn primary" id="scan-btn" onclick="startScan()">üîç Scan</button>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="toast"></div>
    
    <script>
        let allProducts = [];
        let currentFilter = 'all';
        let currentDateFilter = 'all';
        let currentBrandSearch = '';
        let currentSort = 'sales_7d';
        let currentScanTab = 'quick';
        let scanAborted = false;
        let knownBrands = [];
        
        // Load products on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadStats();
            loadKnownBrands();
        });
        
        async function loadKnownBrands() {
            try {
                const response = await fetch('/api/brands');
                const data = await response.json();
                if (data.brands) {
                    knownBrands = data.brands;
                }
            } catch (err) {
                console.error('Failed to load brands:', err);
            }
        }
        
        function searchBrands(query) {
            const container = document.getElementById('brand-suggestions');
            if (!query || query.length < 2) {
                container.classList.remove('show');
                return;
            }
            
            const matches = knownBrands.filter(b => 
                b.seller_name.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 5);
            
            if (matches.length === 0) {
                container.innerHTML = '<div class="brand-suggestion" style="color:#888;">No brands found. Scan more brands first!</div>';
            } else {
                container.innerHTML = matches.map(b => `
                    <div class="brand-suggestion" onclick="selectBrand('${b.seller_id}', '${b.seller_name.replace(/'/g, "\\'")}')">
                        ${b.seller_name} <span style="color:#888;">(${b.product_count} products)</span>
                    </div>
                `).join('');
            }
            container.classList.add('show');
        }
        
        function selectBrand(sellerId, sellerName) {
            document.getElementById('selected-brand-id').value = sellerId;
            document.getElementById('selected-brand-name').textContent = sellerName;
            document.getElementById('brand-scan-input').value = sellerName;
            document.getElementById('brand-suggestions').classList.remove('show');
        }
        
        function setScanTab(tab, btn) {
            currentScanTab = tab;
            document.querySelectorAll('.scan-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.scan-panel').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(`panel-${tab}`).classList.add('active');
        }
        
        function toggleCollapsible(header) {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        }
        
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('stat-products').textContent = data.total_products || 0;
                document.getElementById('stat-brands').textContent = data.unique_brands || 0;
                document.getElementById('stat-untapped').textContent = data.untapped || 0;
                document.getElementById('stat-low').textContent = data.low_competition || 0;
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }
        
        async function loadProducts() {
            try {
                let url = '/api/products?limit=500';
                if (currentDateFilter === 'favorites') {
                    url = '/api/favorites';
                } else if (currentDateFilter !== 'all') {
                    url += `&date=${currentDateFilter}`;
                }
                if (currentBrandSearch) {
                    url += `&brand=${encodeURIComponent(currentBrandSearch)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                allProducts = data.products || [];
                updateCounts();
                applySort();
            } catch (err) {
                showToast('Failed to load products', true);
            }
        }
        
        function setDateFilter(filter, btn) {
            currentDateFilter = filter;
            document.querySelectorAll('.date-pill').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            loadProducts();
        }
        
        function applyFilters() {
            currentBrandSearch = document.getElementById('brand-search').value;
            loadProducts();
        }
        
        function applySort() {
            currentSort = document.getElementById('sort-select').value;
            
            let sorted = [...allProducts];
            switch(currentSort) {
                case 'sales_7d':
                    sorted.sort((a, b) => (b.sales_7d || 0) - (a.sales_7d || 0));
                    break;
                case 'commission':
                    sorted.sort((a, b) => (b.commission_rate || 0) - (a.commission_rate || 0));
                    break;
                case 'influencers_asc':
                    sorted.sort((a, b) => (a.influencer_count || 0) - (b.influencer_count || 0));
                    break;
                case 'influencers_desc':
                    sorted.sort((a, b) => (b.influencer_count || 0) - (a.influencer_count || 0));
                    break;
                case 'newest':
                    sorted.sort((a, b) => new Date(b.first_seen || 0) - new Date(a.first_seen || 0));
                    break;
                case 'price_high':
                    sorted.sort((a, b) => (b.price || 0) - (a.price || 0));
                    break;
                case 'price_low':
                    sorted.sort((a, b) => (a.price || 0) - (b.price || 0));
                    break;
            }
            
            filterProducts(currentFilter, null, sorted);
        }
        
        function updateCounts() {
            const counts = { all: 0, untapped: 0, low: 0, medium: 0, good: 0 };
            
            allProducts.forEach(p => {
                const inf = p.influencer_count || 0;
                counts.all++;
                if (inf >= 1 && inf <= 10) counts.untapped++;
                else if (inf >= 11 && inf <= 30) counts.low++;
                else if (inf >= 31 && inf <= 60) counts.medium++;
                else if (inf >= 61 && inf <= 100) counts.good++;
            });
            
            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-untapped').textContent = counts.untapped;
            document.getElementById('count-low').textContent = counts.low;
            document.getElementById('count-medium').textContent = counts.medium;
            document.getElementById('count-good').textContent = counts.good;
        }
        
        function filterProducts(filter, btn, products = null) {
            currentFilter = filter;
            
            if (btn) {
                document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
            }
            
            let source = products || allProducts;
            let filtered = source;
            
            if (filter === 'untapped') {
                filtered = source.filter(p => p.influencer_count >= 1 && p.influencer_count <= 10);
            } else if (filter === 'low') {
                filtered = source.filter(p => p.influencer_count >= 11 && p.influencer_count <= 30);
            } else if (filter === 'medium') {
                filtered = source.filter(p => p.influencer_count >= 31 && p.influencer_count <= 60);
            } else if (filter === 'good') {
                filtered = source.filter(p => p.influencer_count >= 61 && p.influencer_count <= 100);
            }
            
            renderProducts(filtered);
        }
        
        function renderProducts(products) {
            const container = document.getElementById('products-container');
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="icon">üîç</div>
                        <p>No products found</p>
                        <p style="font-size:0.85rem; margin-top:10px;">Try adjusting your filters or scan more brands!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = products.map(p => {
                const inf = p.influencer_count || 0;
                let badgeClass = '';
                if (inf <= 10) badgeClass = 'hot';
                else if (inf <= 30) badgeClass = 'warm';
                else if (inf <= 60) badgeClass = 'cool';
                
                // Commission rate - API returns as decimal (0.15 = 15%) 
                let commission = p.commission_rate || 0;
                // If it looks like a decimal (less than 1), multiply by 100
                if (commission > 0 && commission < 1) {
                    commission = commission * 100;
                }
                commission = Math.round(commission * 10) / 10; // Round to 1 decimal
                
                let commissionClass = '';
                if (commission < 5) commissionClass = 'very-low';
                else if (commission < 10) commissionClass = 'low';
                
                const isFav = p.is_favorite ? 'active' : '';
                const heartIcon = p.is_favorite ? '‚ù§Ô∏è' : 'ü§ç';
                
                return `
                    <div class="product-card">
                        <button class="favorite-btn ${isFav}" onclick="event.stopPropagation(); toggleFavorite('${p.product_id}', this)">
                            ${heartIcon}
                        </button>
                        <img class="product-image" 
                             src="${p.cached_image_url || p.image_url || ''}" 
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2240%22>üì¶</text></svg>'"
                             alt=""
                             onclick="openProduct('${p.product_id}')">
                        <div class="product-info" onclick="openProduct('${p.product_id}')">
                            <div class="product-name">${p.product_name}</div>
                            <div class="product-stats">
                                <span class="commission-badge ${commissionClass}">${commission}%</span>
                                <span class="influencer-badge ${badgeClass}">${inf} üë§</span>
                            </div>
                            <div style="font-size:0.6rem; color:#888; margin-top:4px; display:flex; justify-content:space-between;">
                                <span>${(p.sales_7d || 0).toLocaleString()}/7d</span>
                                <span>$${(p.price || 0).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function toggleFavorite(productId, btn) {
            try {
                const response = await fetch(`/api/favorite/${productId}`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    btn.classList.toggle('active');
                    btn.textContent = data.is_favorite ? '‚ù§Ô∏è' : 'ü§ç';
                    
                    const product = allProducts.find(p => p.product_id === productId);
                    if (product) product.is_favorite = data.is_favorite;
                    
                    showToast(data.is_favorite ? '‚ù§Ô∏è Added to favorites' : 'üíî Removed from favorites', false, 'success');
                }
            } catch (err) {
                showToast('Failed to update favorite', true);
            }
        }
        
        function openProduct(productId) {
            window.location.href = `/product?id=${productId}`;
        }
        
        async function startScan() {
            const btn = document.getElementById('scan-btn');
            const originalText = btn.innerHTML;
            scanAborted = false;
            
            if (currentScanTab === 'quick') {
                await runQuickScan(btn, originalText);
            } else if (currentScanTab === 'deep') {
                await runDeepScan(btn, originalText);
            } else if (currentScanTab === 'brand') {
                await runBrandScan(btn, originalText);
            }
        }
        
        async function runQuickScan(btn, originalText) {
            const startRank = parseInt(document.getElementById('start-rank').value);
            let numBrands = parseInt(document.getElementById('num-brands').value);
            let pagesPerBrand = parseInt(document.getElementById('pages-per-brand').value);
            
            // Safety limits
            if (numBrands > 50) {
                numBrands = 50;
                document.getElementById('num-brands').value = 50;
                showToast('‚ö†Ô∏è Brands capped at 50');
            }
            if (pagesPerBrand > 10) {
                pagesPerBrand = 10;
                document.getElementById('pages-per-brand').value = 10;
                showToast('‚ö†Ô∏è Pages capped at 10 to avoid timeout');
            }
            
            const maxInfluencers = document.getElementById('max-influencers').value;
            const minSales = document.getElementById('min-sales').value;
            
            let totalFound = 0, totalSaved = 0, brandsCompleted = 0, errors = 0;
            
            try {
                for (let i = 0; i < numBrands; i++) {
                    if (scanAborted) {
                        showToast(`‚èπÔ∏è Stopped after ${brandsCompleted} brands`);
                        break;
                    }
                    
                    const brandRank = startRank + i;
                    btn.innerHTML = `‚è≥ ${i + 1}/${numBrands} (#${brandRank})`;
                    btn.onclick = () => { scanAborted = true; btn.innerHTML = '‚èπÔ∏è Stopping...'; };
                    
                    try {
                        const url = `/api/quick-scan?brand_rank=${brandRank}&pages=${pagesPerBrand}&min_influencers=1&max_influencers=${maxInfluencers}&min_sales=${minSales}`;
                        const response = await fetch(url);
                        
                        if (!response.ok) { errors++; continue; }
                        
                        const data = await response.json();
                        if (data.error) { errors++; continue; }
                        
                        if (data.result) {
                            totalFound += data.result.products_found;
                            totalSaved += data.result.products_saved;
                            brandsCompleted++;
                        }
                    } catch (fetchErr) {
                        errors++;
                    }
                }
                
                const errorMsg = errors > 0 ? ` (${errors} errors)` : '';
                showToast(`‚úÖ ${brandsCompleted}/${numBrands} brands: Found ${totalFound}, saved ${totalSaved}${errorMsg}`, false, 'success');
                document.getElementById('start-rank').value = startRank + numBrands;
                
                // Auto refresh images after scan
                await refreshImagesQuiet();
                
                loadProducts();
                loadStats();
                loadKnownBrands();
                
            } catch (err) {
                showToast('Scan failed: ' + err.message, true);
            } finally {
                btn.innerHTML = originalText;
                btn.onclick = startScan;
            }
        }
        
        async function runDeepScan(btn, originalText) {
            const startRank = parseInt(document.getElementById('deep-start-rank').value);
            let numBrands = parseInt(document.getElementById('deep-num-brands').value);
            let startPage = parseInt(document.getElementById('deep-start-page').value);
            let endPage = parseInt(document.getElementById('deep-end-page').value);
            const maxInfluencers = document.getElementById('deep-max-influencers').value;
            
            // Safety limits
            if (numBrands > 20) {
                numBrands = 20;
                document.getElementById('deep-num-brands').value = 20;
            }
            if (endPage - startPage > 50) {
                endPage = startPage + 50;
                document.getElementById('deep-end-page').value = endPage;
                showToast('‚ö†Ô∏è Page range capped at 50 pages per brand');
            }
            
            let totalFound = 0, totalSaved = 0, brandsCompleted = 0, errors = 0;
            
            try {
                // First get the brands
                btn.innerHTML = '‚è≥ Getting brands...';
                const brandsResponse = await fetch(`/api/top-brands?start_rank=${startRank}&count=${numBrands}`);
                const brandsData = await brandsResponse.json();
                
                if (!brandsData.brands || brandsData.brands.length === 0) {
                    showToast('Failed to get brands', true);
                    return;
                }
                
                for (let i = 0; i < brandsData.brands.length; i++) {
                    if (scanAborted) break;
                    
                    const brand = brandsData.brands[i];
                    btn.innerHTML = `üîç Deep ${i + 1}/${numBrands}: ${brand.seller_name.substring(0, 15)}...`;
                    btn.onclick = () => { scanAborted = true; btn.innerHTML = '‚èπÔ∏è Stopping...'; };
                    
                    // Scan in chunks of 10 pages to avoid timeout
                    for (let page = startPage; page <= endPage; page += 10) {
                        if (scanAborted) break;
                        
                        const chunkEnd = Math.min(page + 9, endPage);
                        btn.innerHTML = `üîç ${brand.seller_name.substring(0, 10)}... (p${page}-${chunkEnd})`;
                        
                        try {
                            // Pass seller_name so products get correct brand
                            const url = `/api/scan-pages/${brand.seller_id}?start=${page}&end=${chunkEnd}&max_influencers=${maxInfluencers}&min_sales=0&seller_name=${encodeURIComponent(brand.seller_name)}`;
                            const response = await fetch(url);
                            
                            if (!response.ok) continue;
                            
                            const data = await response.json();
                            if (data.products_found) totalFound += data.products_found;
                            if (data.products_saved) totalSaved += data.products_saved;
                        } catch (err) {
                            errors++;
                        }
                    }
                    brandsCompleted++;
                }
                
                showToast(`üîç Deep scan: ${brandsCompleted} brands, found ${totalFound}, saved ${totalSaved}`, false, 'success');
                await refreshImagesQuiet();
                loadProducts();
                loadStats();
                
            } catch (err) {
                showToast('Deep scan failed: ' + err.message, true);
            } finally {
                btn.innerHTML = originalText;
                btn.onclick = startScan;
            }
        }
        
        async function runBrandScan(btn, originalText) {
            const sellerId = document.getElementById('selected-brand-id').value;
            const sellerName = document.getElementById('selected-brand-name').textContent;
            
            if (!sellerId || sellerId === '' || sellerName === 'None') {
                showToast('‚ö†Ô∏è Please select a brand first', true);
                return;
            }
            
            let startPage = parseInt(document.getElementById('brand-start-page').value);
            let endPage = parseInt(document.getElementById('brand-end-page').value);
            const maxInfluencers = document.getElementById('brand-max-influencers').value;
            
            // Safety limit
            if (endPage - startPage > 100) {
                endPage = startPage + 100;
                document.getElementById('brand-end-page').value = endPage;
                showToast('‚ö†Ô∏è Page range capped at 100 pages');
            }
            
            let totalFound = 0, totalSaved = 0, errors = 0;
            
            try {
                // Scan in chunks of 10 pages
                for (let page = startPage; page <= endPage; page += 10) {
                    if (scanAborted) break;
                    
                    const chunkEnd = Math.min(page + 9, endPage);
                    btn.innerHTML = `üè∑Ô∏è ${sellerName.substring(0, 12)}... (p${page}-${chunkEnd})`;
                    btn.onclick = () => { scanAborted = true; btn.innerHTML = '‚èπÔ∏è Stopping...'; };
                    
                    try {
                        const url = `/api/scan-pages/${sellerId}?start=${page}&end=${chunkEnd}&max_influencers=${maxInfluencers}&min_sales=0`;
                        const response = await fetch(url);
                        
                        if (!response.ok) { errors++; continue; }
                        
                        const data = await response.json();
                        if (data.products_found) totalFound += data.products_found;
                        if (data.products_saved) totalSaved += data.products_saved;
                    } catch (err) {
                        errors++;
                    }
                }
                
                const errorMsg = errors > 0 ? ` (${errors} errors)` : '';
                showToast(`üè∑Ô∏è ${sellerName}: Found ${totalFound}, saved ${totalSaved}${errorMsg}`, false, 'success');
                await refreshImagesQuiet();
                loadProducts();
                loadStats();
                
            } catch (err) {
                showToast('Brand scan failed: ' + err.message, true);
            } finally {
                btn.innerHTML = originalText;
                btn.onclick = startScan;
            }
        }
        
        // Tools functions
        function openModal() {
            document.getElementById('tools-modal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('tools-modal').classList.remove('show');
        }
        
        async function refreshImages() {
            showToast('üñºÔ∏è Refreshing images...', false);
            closeModal();
            try {
                const response = await fetch('/api/refresh-images');
                const data = await response.json();
                showToast(`üñºÔ∏è Refreshed ${data.updated || 0} images`, false, 'success');
                loadProducts();
            } catch (err) {
                showToast('Failed to refresh images', true);
            }
        }
        
        async function refreshImagesQuiet() {
            try {
                await fetch('/api/refresh-images');
            } catch (err) {
                console.error('Failed to refresh images:', err);
            }
        }
        
        async function cleanupProducts() {
            if (!confirm('This will remove all products with 0% commission. Continue?')) return;
            closeModal();
            try {
                const response = await fetch('/api/cleanup');
                const data = await response.json();
                showToast(`üßπ Removed ${data.removed || 0} products`, false, 'success');
                loadProducts();
                loadStats();
            } catch (err) {
                showToast('Cleanup failed', true);
            }
        }
        
        async function exportFavorites() {
            closeModal();
            try {
                const response = await fetch('/api/favorites');
                const data = await response.json();
                
                if (!data.products || data.products.length === 0) {
                    showToast('No favorites to export', true);
                    return;
                }
                
                // Create CSV
                const headers = ['Product Name', 'Brand', 'Commission %', 'Influencers', '7-Day Sales', 'Price', 'Product ID', 'TikTok Link'];
                const rows = data.products.map(p => {
                    let commission = p.commission_rate || 0;
                    if (commission > 0 && commission < 1) commission = commission * 100;
                    return [
                        `"${(p.product_name || '').replace(/"/g, '""')}"`,
                        `"${(p.seller_name || '').replace(/"/g, '""')}"`,
                        Math.round(commission * 10) / 10,
                        p.influencer_count || 0,
                        p.sales_7d || 0,
                        p.price || 0,
                        p.product_id,
                        `https://www.tiktok.com/view/product/${p.product_id}`
                    ];
                });
                
                const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `brand_hunter_favorites_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast(`üì§ Exported ${data.products.length} favorites`, false, 'success');
            } catch (err) {
                showToast('Export failed', true);
            }
        }
        
        async function viewStats() {
            closeModal();
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                alert(`üìä Database Stats:\n\n` +
                    `Total Products: ${data.total_products}\n` +
                    `Unique Brands: ${data.unique_brands}\n` +
                    `üî• Untapped (1-10): ${data.untapped}\n` +
                    `üíé Low (11-30): ${data.low_competition}\n` +
                    `üìä Medium (31-60): ${data.medium_competition}\n` +
                    `‚úÖ Good (61-100): ${data.good_competition}\n` +
                    `‚ù§Ô∏è Favorites: ${data.favorites || 0}`);
            } catch (err) {
                showToast('Failed to load stats', true);
            }
        }
        
        function showToast(message, isError = false, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            if (isError) toast.classList.add('error');
            if (type === 'success') toast.classList.add('success');
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }
    </script>
</body>
</html>
