<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Brand Hunter</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding-bottom: 100px;
        }
        
        .header {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            text-align: center;
        }
        
        .header h1 { font-size: 1.5rem; margin-bottom: 3px; }
        .header p { color: #888; font-size: 0.8rem; }
        
        .content { padding: 12px; }
        
        /* Stats Card */
        .stats-card {
            background: linear-gradient(135deg, #e94560, #0f3460);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.3rem; font-weight: bold; }
        .stat-label { font-size: 0.65rem; color: rgba(255,255,255,0.7); }
        
        /* Strategy Banner */
        .strategy-banner {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(233,69,96,0.3);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
        }
        
        .strategy-banner h3 {
            color: #e94560;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        
        .strategy-banner p {
            color: #aaa;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        
        /* Filter Pills */
        .filter-pills {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding: 8px 0;
            margin-bottom: 12px;
        }
        
        .pill {
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 16px;
            color: #fff;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.8rem;
        }
        
        .pill.active { background: #e94560; }
        .pill .count {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 5px;
            font-size: 0.75rem;
        }
        
        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        @media (min-width: 768px) {
            .product-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 12px;
            }
        }
        
        @media (min-width: 1200px) {
            .product-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        .product-card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .product-card:active { transform: scale(0.98); }
        
        .product-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: rgba(0,0,0,0.2);
        }
        
        .product-info { padding: 10px; }
        
        .product-name {
            font-size: 0.75rem;
            line-height: 1.3;
            height: 2.6em;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .product-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
        }
        
        .influencer-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: bold;
        }
        
        .influencer-badge.untapped { background: #e94560; }
        .influencer-badge.low { background: #9b59b6; }
        .influencer-badge.medium { background: #f39c12; color: #000; }
        .influencer-badge.good { background: #2ecc71; color: #000; }
        
        /* Action Bar */
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26,26,46,0.98);
            padding: 15px;
            display: flex;
            gap: 10px;
            backdrop-filter: blur(10px);
        }
        
        .action-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .action-btn.primary { background: #e94560; color: #fff; }
        .action-btn.secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Loading & Empty States */
        .loading, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty-state .icon { font-size: 4rem; margin-bottom: 15px; }
        
        /* Scan Settings */
        .scan-settings {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .scan-settings h4 {
            margin-bottom: 12px;
            color: #e94560;
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .setting-row label { color: #aaa; font-size: 0.9rem; }
        
        .setting-row input, .setting-row select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #fff;
            width: 100px;
            text-align: center;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2ecc71;
            color: #fff;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .toast.show { display: block; animation: slideIn 0.3s ease; }
        .toast.error { background: #e74c3c; }
        
        @keyframes slideIn {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Brand Hunter</h1>
        <p>Find hidden gems from top brands</p>
    </div>
    
    <div class="content">
        <div class="stats-card">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="total-products">0</div>
                    <div class="stat-label">Products Found</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="unique-brands">0</div>
                    <div class="stat-label">Brands Scanned</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="untapped-count">0</div>
                    <div class="stat-label">üî• Untapped (1-10)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="low-count">0</div>
                    <div class="stat-label">üíé Low (11-30)</div>
                </div>
            </div>
        </div>
        
        <div class="strategy-banner">
            <h3>üìà Strategy: 7-Day Momentum + Low Competition</h3>
            <p>Scans top brands by GMV, sorts products by 7-day sales (recent momentum), 
               filters for 1-100 influencers. Hot NOW + low competition = opportunity!</p>
        </div>
        
        <div class="scan-settings">
            <h4>‚öôÔ∏è Scan Settings</h4>
            <div class="setting-row">
                <label>Start from rank:</label>
                <input type="number" id="start-rank" value="1" min="1" max="500">
            </div>
            <div class="setting-row">
                <label>Brands to scan:</label>
                <input type="number" id="num-brands" value="2" min="1" max="5">
            </div>
            <div class="setting-row">
                <label>Pages per brand:</label>
                <input type="number" id="pages-per-brand" value="3" min="1" max="10">
            </div>
            <div class="setting-row">
                <label>Min influencers:</label>
                <input type="number" id="min-influencers" value="1" min="1">
            </div>
            <div class="setting-row">
                <label>Max influencers:</label>
                <input type="number" id="max-influencers" value="100" min="1">
            </div>
            <div class="setting-row">
                <label>Min 7-day sales:</label>
                <input type="number" id="min-sales" value="0" min="0">
            </div>
        </div>
        
        <div class="filter-pills">
            <button class="pill active" onclick="filterProducts('all', this)">
                All <span class="count" id="count-all">0</span>
            </button>
            <button class="pill" onclick="filterProducts('untapped', this)">
                üî• 1-10 <span class="count" id="count-untapped">0</span>
            </button>
            <button class="pill" onclick="filterProducts('low', this)">
                üíé 11-30 <span class="count" id="count-low">0</span>
            </button>
            <button class="pill" onclick="filterProducts('medium', this)">
                üìä 31-60 <span class="count" id="count-medium">0</span>
            </button>
            <button class="pill" onclick="filterProducts('good', this)">
                ‚úÖ 61-100 <span class="count" id="count-good">0</span>
            </button>
        </div>
        
        <div id="products-container" class="product-grid">
            <div class="empty-state" style="grid-column: 1/-1;">
                <div class="icon">üîç</div>
                <p>No products yet</p>
                <p style="font-size:0.85rem; margin-top:10px;">Click "Scan Top Brands" to start!</p>
            </div>
        </div>
    </div>
    
    <div class="action-bar">
        <button class="action-btn secondary" onclick="loadProducts()">‚Üª Refresh</button>
        <button class="action-btn primary" id="scan-btn" onclick="scanTopBrands()">üéØ Scan Top Brands</button>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        let allProducts = [];
        let currentFilter = 'all';
        
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadProducts();
        });
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }
        
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('total-products').textContent = data.total_products || 0;
                document.getElementById('unique-brands').textContent = data.unique_brands || 0;
                document.getElementById('untapped-count').textContent = data.breakdown?.untapped_1_10 || 0;
                document.getElementById('low-count').textContent = data.breakdown?.low_11_30 || 0;
            } catch (err) {
                console.error('Stats error:', err);
            }
        }
        
        async function loadProducts() {
            const container = document.getElementById('products-container');
            container.innerHTML = '<div class="loading" style="grid-column:1/-1"><div class="spinner"></div>Loading...</div>';
            
            try {
                const response = await fetch('/api/products?limit=200');
                const data = await response.json();
                
                allProducts = data.products || [];
                updateFilterCounts();
                renderProducts();
                loadStats();
            } catch (err) {
                container.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="icon">‚ùå</div><p>Failed to load</p></div>';
            }
        }
        
        function updateFilterCounts() {
            const counts = {
                all: allProducts.length,
                untapped: allProducts.filter(p => p.influencer_count >= 1 && p.influencer_count <= 10).length,
                low: allProducts.filter(p => p.influencer_count >= 11 && p.influencer_count <= 30).length,
                medium: allProducts.filter(p => p.influencer_count >= 31 && p.influencer_count <= 60).length,
                good: allProducts.filter(p => p.influencer_count >= 61 && p.influencer_count <= 100).length
            };
            
            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-untapped').textContent = counts.untapped;
            document.getElementById('count-low').textContent = counts.low;
            document.getElementById('count-medium').textContent = counts.medium;
            document.getElementById('count-good').textContent = counts.good;
        }
        
        function filterProducts(filter, element) {
            currentFilter = filter;
            document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
            if (element) element.classList.add('active');
            renderProducts();
        }
        
        function renderProducts() {
            const container = document.getElementById('products-container');
            
            let filtered = allProducts;
            
            switch(currentFilter) {
                case 'untapped':
                    filtered = allProducts.filter(p => p.influencer_count >= 1 && p.influencer_count <= 10);
                    break;
                case 'low':
                    filtered = allProducts.filter(p => p.influencer_count >= 11 && p.influencer_count <= 30);
                    break;
                case 'medium':
                    filtered = allProducts.filter(p => p.influencer_count >= 31 && p.influencer_count <= 60);
                    break;
                case 'good':
                    filtered = allProducts.filter(p => p.influencer_count >= 61 && p.influencer_count <= 100);
                    break;
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column:1/-1">
                        <div class="icon">üîç</div>
                        <p>No products found</p>
                        <p style="font-size:0.85rem; margin-top:10px;">Click "Scan Top Brands" to find gems!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(p => {
                const badgeClass = p.influencer_count <= 10 ? 'untapped' : 
                                   p.influencer_count <= 30 ? 'low' : 
                                   p.influencer_count <= 60 ? 'medium' : 'good';
                
                return `
                    <div class="product-card" onclick="openProduct('${p.product_id}')">
                        <img class="product-image" 
                             src="/api/image-proxy/${p.product_id}" 
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2240%22>üì¶</text></svg>'"
                             alt="">
                        <div class="product-info">
                            <div class="product-name">${p.product_name}</div>
                            <div class="product-stats">
                                <span class="influencer-badge ${badgeClass}">${p.influencer_count} üë§</span>
                                <span>${(p.sales_7d || 0).toLocaleString()} /7d</span>
                            </div>
                            <div style="font-size:0.75rem; color:#888; margin-top:6px;">
                                ${p.seller_name || ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function scanTopBrands() {
            const btn = document.getElementById('scan-btn');
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Scanning...';
            btn.disabled = true;
            
            const startRank = document.getElementById('start-rank').value;
            const numBrands = document.getElementById('num-brands').value;
            const pagesPerBrand = document.getElementById('pages-per-brand').value;
            const minInfluencers = document.getElementById('min-influencers').value;
            const maxInfluencers = document.getElementById('max-influencers').value;
            const minSales = document.getElementById('min-sales').value;
            
            try {
                const url = `/api/scan?start_rank=${startRank}&brands=${numBrands}&pages_per_brand=${pagesPerBrand}&min_influencers=${minInfluencers}&max_influencers=${maxInfluencers}&min_sales=${minSales}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error, true);
                } else {
                    const rankInfo = data.scan_info?.brand_ranks || '';
                    showToast(`‚úÖ Brands ${rankInfo}: Found ${data.total_products_found}, saved ${data.total_products_saved} new!`);
                    // Auto-increment start rank for next batch
                    document.getElementById('start-rank').value = parseInt(startRank) + parseInt(numBrands);
                    loadProducts();
                }
            } catch (err) {
                showToast('Scan failed: ' + err.message, true);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        function openProduct(productId) {
            // Go to internal product detail page
            window.location.href = `/product?id=${productId}`;
        }
    </script>
</body>
</html>
