<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Control | Vantage</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/pwa/css/main.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        midnight: '#05070a',
                        cyan: '#06b6d4',
                        violet: '#7c3aed',
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scan-card-active {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.05);
            box-shadow: 0 0 20px -5px rgba(6, 182, 212, 0.3);
        }

        .terminal-bg {
            background: rgba(0, 0, 0, 0.4);
            font-family: 'JetBrains Mono', monospace;
        }

        .log-entry {
            border-left: 2px solid transparent;
            padding-left: 1rem;
            margin-bottom: 0.25rem;
        }

        .log-info {
            border-left-color: #64748b;
            color: #94a3b8;
        }

        .log-success {
            border-left-color: #10b981;
            color: #34d399;
        }

        .log-error {
            border-left-color: #f43f5e;
            color: #fb7185;
        }

        .log-warn {
            border-left-color: #f59e0b;
            color: #fbbf24;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden bg-midnight">

    <!-- Sidebar (Shared with Dashboard) -->
    <aside class="hidden md:flex flex-col w-72 glass border-r border-white/5 z-30">
        <div class="p-8">
            <div class="flex items-center gap-3 group cursor-pointer" onclick="window.location.href='/'">
                <div class="w-12 h-12 rounded-2xl glass flex items-center justify-center relative overflow-hidden">
                    <img src="/vantage_logo.png" class="w-full h-full object-cover p-1.5"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <span style="display:none" class="text-2xl h-full w-full items-center justify-center">ðŸŽ¯</span>
                    <div class="absolute inset-0 bg-cyan-400/10 opacity-0 group-hover:opacity-100 transition-opacity">
                    </div>
                </div>
                <div>
                    <h1 class="font-heading font-bold text-2xl tracking-tight text-white">Vantage</h1>
                    <p class="text-[10px] text-cyan-400 font-bold tracking-widest uppercase opacity-70">Intelligence</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-2 overflow-y-auto no-scrollbar">
            <div class="px-4 py-2 text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">Navigation</div>
            <a href="/" class="sidebar-link">
                <i class="fas fa-th-large w-5"></i>
                <span>Dashboard</span>
            </a>
            <a href="/scanner" id="sidebarScannerLink" class="sidebar-link active">
                <i class="fas fa-radar w-5"></i>
                <span>Scanners</span>
                <span class="ml-auto text-[10px] glass px-2 py-0.5 rounded-full text-cyan-400 font-bold">V4</span>
            </a>
            <a href="/shops" class="sidebar-link">
                <i class="fas fa-store w-5"></i>
                <span>Shops Library</span>
            </a>

            <div class="px-4 py-6 text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">System</div>
            <a href="/admin" class="sidebar-link">
                <i class="fas fa-terminal w-5"></i>
                <span>Terminal</span>
            </a>
            <a href="/settings" class="sidebar-link">
                <i class="fas fa-cog w-5"></i>
                <span>Settings</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <!-- Header -->
        <header class="glass h-20 flex items-center justify-between px-8 border-b border-white/5 sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden glass p-2 rounded-xl border-white/5 text-slate-400">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="font-heading font-bold text-xl text-white">Scanner</h2>
                <div class="h-6 w-px bg-white/10 mx-2 hidden md:block"></div>
                <div id="statusIndicator" class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">System Ready</span>
                </div>
            </div>
        </header>

        <!-- Scanner UI -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 no-scrollbar pb-32">
            <div class="max-w-6xl mx-auto space-y-8">

                <!-- Scanner Tab Grid -->
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="glass-card p-6 flex flex-col items-center gap-4 cursor-pointer transition-all hover:border-cyan-400/30 scan-tab scan-card-active"
                        onclick="setMode('quick', this)">
                        <div
                            class="w-12 h-12 rounded-2xl bg-yellow-500/10 flex items-center justify-center text-yellow-400 text-xl">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="text-center">
                            <div class="font-bold text-white text-sm">Quick Scan</div>
                            <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">EchoTik API
                            </div>
                        </div>
                    </div>

                    <div class="glass-card p-6 flex flex-col items-center gap-4 cursor-pointer transition-all hover:border-cyan-400/30 scan-tab"
                        onclick="setMode('brand', this)">
                        <div
                            class="w-12 h-12 rounded-2xl bg-cyan-500/10 flex items-center justify-center text-cyan-400 text-xl">
                            <i class="fas fa-tag"></i>
                        </div>
                        <div class="text-center">
                            <div class="font-bold text-white text-sm">Brand Hunter</div>
                            <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Seller
                                Lookup</div>
                        </div>
                    </div>

                    <div class="glass-card p-6 flex flex-col items-center gap-4 cursor-pointer transition-all hover:border-cyan-400/30 scan-tab"
                        onclick="setMode('dailyvirals', this)">
                        <div
                            class="w-12 h-12 rounded-2xl bg-emerald-500/10 flex items-center justify-center text-emerald-400 text-xl">
                            <i class="fas fa-fire-alt"></i>
                        </div>
                        <div class="text-center">
                            <div class="font-bold text-white text-sm">DailyVirals</div>
                            <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Live
                                Scraper</div>
                        </div>
                    </div>

                </div>

                <!-- Main Configuration Panel -->
                <div class="glass-card p-8 md:p-10 border-t border-white/5 relative overflow-hidden" id="configPanel">
                    <!-- Loaded via Script -->
                </div>

                <!-- Matrix System Terminal -->
                <div class="glass-card overflow-hidden h-[400px] flex flex-col border border-white/5 shadow-2xl">
                    <div class="px-6 py-3 bg-white/5 border-b border-white/5 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="flex gap-1.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-rose-500/40"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-amber-500/40"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500/40"></div>
                            </div>
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] ml-2">Mainframe
                                Uplink Log</span>
                        </div>
                        <button onclick="document.getElementById('consoleLog').innerHTML = ''"
                            class="text-[10px] font-bold text-slate-500 hover:text-white uppercase tracking-widest transition-colors">Clear
                            Buffer</button>
                    </div>
                    <div id="consoleLog"
                        class="flex-1 overflow-y-auto p-6 space-y-1 terminal-bg no-scrollbar text-[13px] leading-relaxed">
                        <div class="log-entry log-info">> Vantage Scanner V4 online. Awaiting mission parameters...
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        let currentMode = 'quick';

        const CONFIGS = {
            'quick': `
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
                    <div>
                        <h3 class="text-2xl font-heading font-bold text-white mb-2">EchoTik Quick Discovery</h3>
                        <p class="text-slate-400 text-sm">Scan global top brands and extract high-performing products.</p>
                    </div>
                    <button onclick="runQuickScan(this)" class="btn-premium px-10 py-4 shadow-xl">
                        <i class="fas fa-bolt mr-2"></i> Execute Search
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Global Rank Range</label>
                        <div class="flex items-center gap-3">
                            <input type="number" id="quick-rank" value="1" class="input-premium w-full text-center font-bold">
                            <span class="text-slate-600">to</span>
                            <div class="input-premium w-full text-center bg-white/5 opacity-50 font-bold" id="rank-end">5</div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Sample Size (Brands)</label>
                        <input type="number" id="quick-count" value="5" class="input-premium w-full font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Min 7D Sales Vol</label>
                        <input type="number" id="quick-min-sales" value="100" class="input-premium w-full font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Saturation (Videos)</label>
                        <div class="flex items-center gap-3">
                            <input type="number" id="quick-min-videos" value="1" class="input-premium w-full text-center">
                            <span class="text-slate-600">-</span>
                            <input type="number" id="quick-max-videos" value="30" class="input-premium w-full text-center">
                        </div>
                    </div>
                </div>
            `,
            'brand': `
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
                    <div>
                        <h3 class="text-2xl font-heading font-bold text-white mb-2">Advanced Brand Hunter</h3>
                        <p class="text-slate-400 text-sm">Infiltrate specific seller catalogs using unique Shop IDs.</p>
                    </div>
                    <button onclick="runBrandScan(this)" class="btn-premium px-10 py-4 shadow-xl">
                        <i class="fas fa-crosshairs mr-2"></i> Target Shop
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Seller ID / SPU ID</label>
                        <input type="text" id="brand-id" placeholder="Paste ID here..." class="input-premium w-full font-mono">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Page Depth</label>
                        <div class="flex items-center gap-3">
                            <input type="number" id="brand-start" value="1" class="input-premium w-full text-center">
                            <span class="text-slate-600">to</span>
                            <input type="number" id="brand-end" value="5" class="input-premium w-full text-center">
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Min 7D Sales</label>
                        <input type="number" id="brand-min-sales" value="50" class="input-premium w-full">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Video Radius</label>
                        <input type="number" id="brand-max-videos" value="50" class="input-premium w-full">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Influencers Max</label>
                        <input type="number" id="brand-max-inf" value="100" class="input-premium w-full">
                    </div>
                </div>
            `,
            'dailyvirals': `
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
                    <div>
                        <h3 class="text-2xl font-heading font-bold text-white mb-2">DailyVirals Automation</h3>
                        <p class="text-slate-400 text-sm">Automated extraction from the DailyViral live ad database.</p>
                    </div>
                    <button onclick="runDVScan(this)" data-mode="live" class="btn-premium px-10 py-4 shadow-xl">
                        <i class="fas fa-satellite-dish mr-2"></i> Sync Cloud
                    </button>
                </div>
                <div class="flex gap-4 p-1.5 glass rounded-2xl w-fit mb-8">
                    <button onclick="setDVMode('live')" id="dv-tab-live" class="px-6 py-2 rounded-xl text-xs font-bold active-tab transition-all">Live Automation</button>
                    <button onclick="setDVMode('manual')" id="dv-tab-manual" class="px-6 py-2 rounded-xl text-xs font-bold text-slate-500 hover:text-white transition-all">Manual JSON Logic</button>
                </div>
                <div id="dv-live-ui" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Time Horizon</label>
                        <select id="dv-days" class="input-premium w-full font-bold appearance-none cursor-pointer">
                            <option value="1">24 Hours</option>
                            <option value="3">72 Hours</option>
                            <option value="7">168 Hours</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Saturation Filter</label>
                        <select id="dv-saturation" class="input-premium w-full font-bold appearance-none cursor-pointer">
                            <option value="hidden_gem">ðŸ’Ž Hidden Gems</option>
                            <option value="breakout">ðŸ“ˆ Breakout</option>
                            <option value="hot_seller">ðŸ”¥ Hot Sellers</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Origin Page</label>
                        <input type="number" id="dv-start-page" value="1" class="input-premium w-full">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Batch Depth (Pages)</label>
                        <input type="number" id="dv-page-count" value="3" class="input-premium w-full">
                    </div>
                </div>
                <div id="dv-manual-ui" class="hidden">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Raw JSON Input</label>
                    <textarea id="dv-json" rows="6" class="input-premium w-full font-mono text-xs leading-relaxed" placeholder="Paste server response JSON..."></textarea>
                </div>
            `,
        };

        function setMode(mode, el) {
            currentMode = mode;
            document.querySelectorAll('.scan-tab').forEach(t => t.classList.remove('scan-card-active'));
            el.classList.add('scan-card-active');
            document.getElementById('configPanel').innerHTML = CONFIGS[mode];

            // Re-bind rank update for quick scan
            if (mode === 'quick') {
                const countInput = document.getElementById('quick-count');
                const rankInput = document.getElementById('quick-rank');
                const updateRank = () => {
                    const start = parseInt(rankInput.value) || 1;
                    const count = parseInt(countInput.value) || 1;
                    document.getElementById('rank-end').textContent = start + count - 1;
                };
                countInput.addEventListener('input', updateRank);
                rankInput.addEventListener('input', updateRank);
            }
        }

        function setDVMode(mode) {
            document.getElementById('dv-tab-live').classList.toggle('active-tab', mode === 'live');
            document.getElementById('dv-tab-manual').classList.toggle('active-tab', mode === 'manual');
            document.getElementById('dv-live-ui').classList.toggle('hidden', mode === 'manual');
            document.getElementById('dv-manual-ui').classList.toggle('hidden', mode === 'live');
            const btn = document.querySelector('[data-mode]');
            btn.setAttribute('data-mode', mode);
            btn.innerHTML = mode === 'live' ? '<i class="fas fa-satellite-dish mr-2"></i> Sync Cloud' : '<i class="fas fa-file-import mr-2"></i> Ingest JSON';
        }

        function log(msg, type = 'info') {
            const c = document.getElementById('consoleLog');
            const d = document.createElement('div');
            d.className = `log-entry log-${type}`;
            d.innerHTML = `<span class="opacity-30">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
        }

        async function runQuickScan(btn) {
            const startRank = parseInt(document.getElementById('quick-rank').value) || 1;
            const numBrands = parseInt(document.getElementById('quick-count').value) || 5;
            const minSales = parseInt(document.getElementById('quick-min-sales').value) || 0;
            const minVideos = parseInt(document.getElementById('quick-min-videos').value) || 0;
            const maxVideos = parseInt(document.getElementById('quick-max-videos').value) || 1000;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Operation Running...';
            log(`Initiating Quick Scan Cluster... Sector [${startRank}-${startRank + numBrands - 1}]`, 'info');

            try {
                for (let i = 0; i < numBrands; i++) {
                    const rank = startRank + i;
                    log(`Targeting Brand Rank #${rank}... Establishing Uplink...`, 'info');

                    const query = new URLSearchParams({
                        brand_rank: rank,
                        pages: 3,
                        min_sales: minSales,
                        min_videos: minVideos,
                        max_videos: maxVideos
                    });

                    const res = await fetch(`/api/quick-scan?${query.toString()}`);
                    const data = await res.json();

                    if (data.result) {
                        const s = data.result;
                        log(`>> RECON COMPLETED: Found ${s.products_found}, Saved ${s.products_saved}, Skips ${s.filtered_out || 0}`, s.products_saved > 0 ? 'success' : 'warn');
                    } else {
                        log(`!! UPLINK FAILURE: ${data.error || 'Connection Timeout'}`, 'error');
                    }
                    await new Promise(r => setTimeout(r, 800));
                }
                log("Full Sector Reconnaissance Complete.", 'success');
            } catch (e) { log(`System Crash: ${e.message}`, 'error'); }
            finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-bolt mr-2"></i> Execute Search';
            }
        }

        async function runBrandScan(btn) {
            const id = document.getElementById('brand-id').value;
            if (!id) return log("Error: Target ID Null", 'error');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Tracking Target...';
            log(`Engaging Deep Scan on Shop [${id}]...`, 'warn');

            try {
                const query = new URLSearchParams({
                    start: document.getElementById('brand-start').value,
                    end: document.getElementById('brand-end').value,
                    min_sales: document.getElementById('brand-min-sales').value,
                    max_videos: document.getElementById('brand-max-videos').value,
                    max_influencers: document.getElementById('brand-max-inf').value
                });
                const res = await fetch(`/api/scan-pages/${id}?${query.toString()}`);
                const data = await res.json();

                if (data.products_found !== undefined) {
                    log(`>> TARGET CLEANED: Detected ${data.products_found} items. Success: ${data.products_saved}`, 'success');
                } else log(`!! INTEL ERROR: ${data.error}`, 'error');
            } catch (e) { log(`Link Severed: ${e.message}`, 'error'); }
            finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-crosshairs mr-2"></i> Target Shop';
            }
        }

        async function runDVScan(btn) {
            const mode = btn.getAttribute('data-mode');
            if (mode === 'live') {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-satellite fa-spin mr-2"></i> Syncing Cloud...';
                log("Contacting DailyVirals Hivemind...", 'info');
                try {
                    const res = await fetch('/api/scan/dv-live', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            days: document.getElementById('dv-days').value,
                            saturation: document.getElementById('dv-saturation').value,
                            start_page: document.getElementById('dv-start-page').value,
                            page_count: document.getElementById('dv-page-count').value
                        })
                    });
                    const data = await res.json();
                    if (data.success) log(`>> DATA STREAM SECURED: ${data.message}`, 'success');
                    else log(`!! CLOUD ERROR: ${data.error}`, 'error');
                } catch (e) { log(`Protocol Error: ${e.message}`, 'error'); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-satellite-dish mr-2"></i> Sync Cloud';
                }
            } else {
                const jsonStr = document.getElementById('dv-json').value;
                if (!jsonStr) return log("Buffer Empty", 'error');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Parsing Matrix...';
                try {
                    const res = await fetch('/api/scan/manual', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ json_data: jsonStr })
                    });
                    const data = await res.json();
                    if (data.success) log(`>> INGESTION COMPLETE: ${data.message}`, 'success');
                    else log(`!! PARSER FAILURE: ${data.error}`, 'error');
                } catch (e) { log(`System Fault: ${e.message}`, 'error'); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-file-import mr-2"></i> Ingest JSON';
                }
            }
        }


        document.addEventListener('DOMContentLoaded', () => setMode('quick', document.querySelector('.scan-tab')));

        function toggleSidebar() {
            const aside = document.querySelector('aside');
            if (aside.classList.contains('hidden')) {
                aside.classList.remove('hidden');
                aside.classList.add('fixed', 'inset-0', 'bg-midnight', 'z-50', 'animate-in', 'fade-in', 'duration-300');

                if (!document.getElementById('mobile-sidebar-close')) {
                    const closeBtn = document.createElement('button');
                    closeBtn.id = 'mobile-sidebar-close';
                    closeBtn.className = 'absolute top-8 right-8 glass p-3 rounded-2xl border-white/5 text-white';
                    closeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    closeBtn.onclick = toggleSidebar;
                    aside.appendChild(closeBtn);
                }
            } else {
                aside.classList.add('hidden');
                aside.classList.remove('fixed', 'inset-0', 'bg-midnight', 'z-50', 'animate-in', 'fade-in', 'duration-300');
                const closeBtn = document.getElementById('mobile-sidebar-close');
                if (closeBtn) closeBtn.remove();
            }
        }
    </script>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <a href="/" class="mobile-nav-item">
            <i class="fas fa-th-large"></i>
            <span>Intel</span>
        </a>
        <a href="/scanner" class="mobile-nav-item active">
            <i class="fas fa-radar"></i>
            <span>Scan</span>
        </a>
        <a href="/shops" class="mobile-nav-item">
            <i class="fas fa-store"></i>
            <span>Shops</span>
        </a>
        <a href="/settings" class="mobile-nav-item">
            <i class="fas fa-cog"></i>
            <span>Setup</span>
        </a>
    </nav>
</body>

</html>