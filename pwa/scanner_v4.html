<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner | Vantage</title>
    <link
        href="https://fonts.googleapis.com/css2?family=outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        midnight: '#0F172A',
                        glass: 'rgba(255, 255, 255, 0.05)',
                        'glass-border': 'rgba(255, 255, 255, 0.1)',
                        cyan: '#06B6D4',
                        violet: '#7C3AED',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Outfit', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0F172A;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(124, 58, 237, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(6, 182, 212, 0.15) 0%, transparent 40%);
            color: #F8FAFC;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .nav-item {
            transition: all 0.2s;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(6, 182, 212, 0.1);
            color: #06B6D4;
            border-right: 3px solid #06B6D4;
        }

        .scan-tab {
            cursor: pointer;
            transition: all 0.3s;
        }

        .scan-tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .scan-tab.active {
            background: rgba(6, 182, 212, 0.1);
            border-color: #06B6D4;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.1);
        }

        .log-entry {
            font-family: monospace;
            font-size: 0.85rem;
            padding: 2px 0;
        }

        .log-info {
            color: #94a3b8;
        }

        .log-success {
            color: #4ade80;
        }

        .log-error {
            color: #ef4444;
        }

        .log-warn {
            color: #f59e0b;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 glass-panel border-r border-slate-800 flex flex-col z-20">
        <div class="h-16 flex items-center px-6 border-b border-slate-800/50">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-violet-600 flex items-center justify-center font-bold text-white">
                    V</div>
                <span class="font-heading font-bold text-xl tracking-tight">Vantage</span>
            </div>
        </div>

        <nav class="flex-1 py-6 space-y-1">
            <a href="/" class="nav-item flex items-center gap-3 px-6 py-3 text-slate-400 hover:text-white">
                <i class="fas fa-grid-2"></i> Dashboard
            </a>
            <a href="/scanner"
                class="nav-item active flex items-center gap-3 px-6 py-3 text-slate-400 hover:text-white">
                <i class="fas fa-radar"></i> Scanners
                <span class="ml-auto text-xs bg-cyan-500/20 text-cyan-300 px-2 py-0.5 rounded-full">V2</span>
            </a>

            <!-- Shops Library -->
            <a href="/shops" class="nav-item flex items-center gap-3 px-6 py-3 text-slate-400 hover:text-white">
                <i class="fas fa-shopping-bag"></i> Shops Library
            </a>

            <a href="/manual-import" onclick="alert('Use the Dashboard + Import Button!'); return false;"
                class="nav-item flex items-center gap-3 px-6 py-3 text-slate-400 hover:text-white">
                <i class="fas fa-upload"></i> Manual Import
            </a>
        </nav>

        <div class="p-4 border-t border-slate-800/50">
            <a href="/admin"
                class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800/50">
                <i class="fas fa-cog"></i> Admin
            </a>
            <a href="/developer"
                class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800/50">
                <i class="fas fa-code"></i> Developer
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-900/50">
        <!-- Top Bar -->
        <header class="h-16 glass-panel border-b border-slate-800/50 flex items-center justify-between px-8 z-10">
            <h2 class="font-heading font-semibold text-lg text-white">System Scanners</h2>
        </header>

        <!-- Scanner UI -->
        <div class="flex-1 overflow-y-auto p-8">
            <div class="max-w-5xl mx-auto space-y-8">

                <!-- Scanner Selectors -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="scan-tab active glass-card p-6 rounded-xl border border-slate-700/50 flex flex-col items-center gap-3"
                        onclick="setMode('quick', this)">
                        <i class="fas fa-bolt text-2xl text-yellow-400"></i>
                        <div class="font-medium">Quick Scan</div>
                        <div class="text-xs text-slate-500">Top Brands (EchoTik)</div>
                    </div>
                    <div class="scan-tab glass-card p-6 rounded-xl border border-slate-700/50 flex flex-col items-center gap-3"
                        onclick="setMode('brand', this)">
                        <i class="fas fa-tag text-2xl text-cyan-400"></i>
                        <div class="font-medium">Brand Hunter</div>
                        <div class="text-xs text-slate-500">Specific Seller ID</div>
                    </div>
                    <!-- Legacy Apify Ad Hunter Removed -->
                    <div class="scan-tab glass-card p-6 rounded-xl border border-slate-700/50 flex flex-col items-center gap-3"
                        onclick="setMode('dailyvirals', this)">
                        <i class="fas fa-file-import text-2xl text-emerald-400"></i>
                        <div class="font-medium">DailyVirals</div>
                        <div class="text-xs text-slate-500">Live Scraper / Import</div>
                    </div>
                    <div class="scan-tab glass-card p-6 rounded-xl border border-slate-700/50 flex flex-col items-center gap-3"
                        onclick="setMode('urlbatch', this)">
                        <i class="fas fa-link text-2xl text-pink-400"></i>
                        <div class="font-medium">URL Batch</div>
                        <div class="text-xs text-slate-500">Preview Stats</div>
                    </div>
                </div>

                <!-- Config Panel -->
                <div class="glass-card p-8 rounded-2xl border border-slate-700/50" id="configPanel">
                    <!-- Injected via JS -->
                </div>

                <!-- Console Output -->
                <div class="glass-card p-6 rounded-2xl border border-slate-700/50 h-64 overflow-hidden flex flex-col">
                    <div class="text-xs font-mono text-slate-500 mb-2 uppercase tracking-wider">System Log</div>
                    <div id="consoleLog" class="flex-1 overflow-y-auto space-y-1 font-mono text-sm">
                        <div class="log-entry log-info">> System initialized. Select a scanner to begin.</div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        let currentMode = 'quick';
        let isScanning = false;

        const CONFIGS = {
            'quick': `
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2"><i class="fas fa-bolt text-yellow-400"></i> Quick Scan Configuration</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Start Rank</label>
                        <input type="number" id="quick-rank" value="1" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Count</label>
                        <input type="number" id="quick-count" value="5" max="20" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Min 7d Sales</label>
                        <input type="number" id="quick-min-sales" value="100" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Min Videos</label>
                        <input type="number" id="quick-min-videos" value="1" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Max Videos</label>
                        <input type="number" id="quick-max-videos" value="25" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Min Influencers</label>
                        <input type="number" id="quick-min-inf" value="0" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Max Influencers</label>
                        <input type="number" id="quick-max-inf" value="100" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Pages/Brand</label>
                        <input type="number" id="quick-pages" value="3" max="10" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm text-slate-400 mb-2">Sort Brands By</label>
                        <select id="quick-sort" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none text-slate-300">
                            <option value="2">GMV (Total)</option>
                            <option value="6">30-Day Sales</option>
                            <option value="4">7-Day Sales</option>
                        </select>
                    </div>
                </div>
                <button onclick="runQuickScan(this)" class="w-full bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-orange-500/20 transition-all">
                    Start EchoTik Quick Scan
                </button>
            `,
            'brand': `
                 <h3 class="text-xl font-bold mb-6 flex items-center gap-2"><i class="fas fa-tag text-cyan-400"></i> Brand Hunter Configuration</h3>
                 <div class="mb-6">
                    <label class="block text-sm text-slate-400 mb-2">Seller ID / Shop ID</label>
                    <input type="text" id="brand-id" placeholder="e.g. 74939281..." class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none font-mono">
                 </div>
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Start Page</label>
                        <input type="number" id="brand-start" value="1" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">End Page</label>
                        <input type="number" id="brand-end" value="5" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Min Sales (7d)</label>
                        <input type="number" id="brand-min-sales" value="100" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Min Videos</label>
                        <input type="number" id="brand-min-videos" value="0" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Min Influencers</label>
                        <input type="number" id="brand-min-inf" value="0" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Max Influencers</label>
                        <input type="number" id="brand-max-inf" value="100" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Max Videos</label>
                        <input type="number" id="brand-max-videos" value="25" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-cyan-500 outline-none">
                    </div>
                 </div>
                 <button onclick="runBrandScan(this)" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-cyan-500/20 transition-all">
                    Start Brand Scan
                </button>
            `,
            'dailyvirals': `
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2"><i class="fas fa-file-import text-emerald-400"></i> DailyVirals Live Scraper</h3>
                
                <div class="flex items-center gap-4 mb-6 p-4 bg-slate-800/50 rounded-xl border border-slate-700">
                    <div class="text-sm font-medium text-slate-300">Scraper Mode:</div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="dv-mode" value="live" checked onchange="toggleDVUI()" class="text-emerald-500 focus:ring-emerald-500">
                        <span class="text-sm">Live Scraper</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="dv-mode" value="manual" onchange="toggleDVUI()" class="text-emerald-500 focus:ring-emerald-500">
                        <span class="text-sm">Manual JSON Paste</span>
                    </label>
                </div>

                <div id="dv-live-ui">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Time Range</label>
                            <select id="dv-days" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-emerald-500 outline-none">
                                <option value="1">1 Day</option>
                                <option value="3">3 Days</option>
                                <option value="5">5 Days</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Post Type</label>
                            <select id="dv-type" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-emerald-500 outline-none">
                                <option value="paid">Paid Ads (Verified)</option>
                                <option value="all">Mixed (Paid & Organic)</option>
                                <option value="organic">Organic Only</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Saturation Filter</label>
                            <select id="dv-saturation" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-emerald-500 outline-none">
                                <option value="hidden_gem">üíé Hidden Gems</option>
                                <option value="breakout">üìà Breakout</option>
                                <option value="hot_seller">üî• Hot Sellers</option>
                                <option value="none">All Results</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Start Page</label>
                            <input type="number" id="dv-start-page" value="1" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-emerald-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Number of Pages</label>
                            <input type="number" id="dv-page-count" value="3" max="10" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-emerald-500 outline-none">
                        </div>
                    </div>
                </div>

                <div id="dv-manual-ui" style="display:none">
                    <div class="mb-8">
                        <label class="block text-sm text-slate-400 mb-2">Paste JSON Logic</label>
                        <textarea id="dv-json" rows="6" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-emerald-500 outline-none font-mono text-xs"></textarea>
                        <div class="text-xs text-slate-500 mt-2">Paste raw JSON from DV network request to import products.</div>
                    </div>
                </div>

                <button onclick="runDVScan(this)" class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-emerald-500/20 transition-all">
                    Start DailyVirals Scraper
                </button>
            `,
            'urlbatch': `
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2"><i class="fas fa-link text-pink-400"></i> Batch URL Preview</h3>
                <div class="mb-6">
                    <label class="block text-sm text-slate-400 mb-2">Paste TikTok Product URLs (one per line)</label>
                    <textarea id="batch-urls" rows="8" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 focus:border-pink-500 outline-none font-mono text-xs" placeholder="https://shop.tiktok.com/view/product/123...\nhttps://www.tiktok.com/t/ZTxxxxx/\n1729532687558808508"></textarea>
                    <div class="text-xs text-slate-500 mt-2">Enter up to 50 TikTok product URLs, IDs, or share links. Results shown in console below (not saved to library).</div>
                </div>
                <button onclick="runBatchLookup(this)" class="w-full bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-500 hover:to-rose-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-pink-500/20 transition-all">
                    <i class="fas fa-search mr-2"></i> Lookup Stats (Preview Only)
                </button>
            `
        };

        function setMode(mode, el) {
            currentMode = mode;
            document.querySelectorAll('.scan-tab').forEach(t => t.classList.remove('active', 'border-cyan-500', 'bg-slate-800'));
            el.classList.add('active');
            document.getElementById('configPanel').innerHTML = CONFIGS[mode];
        }

        function log(msg, type = 'info') {
            const c = document.getElementById('consoleLog');
            const d = document.createElement('div');
            d.className = `log-entry log-${type}`;
            d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
        }

        async function runQuickScan(btn) {
            const startRank = parseInt(document.getElementById('quick-rank').value) || 1;
            const numBrands = parseInt(document.getElementById('quick-count').value) || 5;
            const minSales = parseInt(document.getElementById('quick-min-sales').value) || 0;
            const minVideos = parseInt(document.getElementById('quick-min-videos').value) || 0;
            const maxVideos = parseInt(document.getElementById('quick-max-videos').value) || 1000;
            const minInf = parseInt(document.getElementById('quick-min-inf').value) || 0;
            const maxInf = parseInt(document.getElementById('quick-max-inf').value) || 1000;
            const pages = parseInt(document.getElementById('quick-pages').value) || 3;
            const sortField = document.getElementById('quick-sort').value || 2;

            btn.disabled = true;
            btn.innerText = "Scanning...";
            log(`Starting Quick Scan (Rank ${startRank}, ${numBrands} brands, Sales >${minSales}, Videos ${minVideos}-${maxVideos}, Inf ${minInf}-${maxInf})...`);

            try {
                for (let i = 0; i < numBrands; i++) {
                    const rank = startRank + i;
                    log(`Scanning Brand Rank #${rank}...`);

                    const query = new URLSearchParams({
                        brand_rank: rank,
                        pages: pages,
                        min_sales: minSales,
                        min_videos: minVideos,
                        max_videos: maxVideos,
                        min_influencers: minInf,
                        max_influencers: maxInf,
                        sort_field: sortField
                    });

                    const res = await fetch(`/api/quick-scan?${query.toString()}`);
                    const data = await res.json();

                    if (data.result) {
                        const saved = data.result.products_saved;
                        const filtered = data.result.filtered_out || 0;
                        const found = data.result.products_found;
                        log(`Brand #${rank}: Found ${found} (${filtered} filtered), Saved ${saved}`, saved > 0 ? 'success' : 'info');
                    } else {
                        log(`Brand #${rank} Error: ${data.error || 'Unknown'}`, 'error');
                    }
                    await new Promise(r => setTimeout(r, 1000));
                }
                log("Scan Batch Complete.", 'success');
            } catch (e) {
                log(`Error: ${e.message}`, 'error');
            }
            btn.disabled = false;
            btn.innerText = "Start EchoTik Quick Scan";
        }

        async function runBrandScan(btn) {
            const id = document.getElementById('brand-id').value;
            const start = document.getElementById('brand-start').value || 1;
            const end = document.getElementById('brand-end').value || 5;
            const minSales = document.getElementById('brand-min-sales').value || 0;
            const minVideos = document.getElementById('brand-min-videos').value || 0;
            const minInf = document.getElementById('brand-min-inf').value || 0;
            const maxInf = document.getElementById('brand-max-inf').value || 1000;
            const maxVideos = document.getElementById('brand-max-videos').value || 1000;

            if (!id) return log("Enter a Seller ID!", 'error');

            btn.disabled = true;
            btn.innerText = "Scanning...";
            log(`Scanning Seller ${id} (Pages ${start}-${end}, Sales >${minSales}, Videos ${minVideos}-${maxVideos}, Inf ${minInf}-${maxInf})...`);

            try {
                const res = await fetch(`/api/scan-pages/${id}?start=${start}&end=${end}&min_sales=${minSales}&min_videos=${minVideos}&max_videos=${maxVideos}&min_influencers=${minInf}&max_influencers=${maxInf}`);
                const data = await res.json();

                if (data.products_found !== undefined) {
                    const saved = data.products_saved;
                    const filtered = data.filtered_out || 0;
                    const found = data.products_found;
                    log(`Complete: Found ${found} (${filtered} filtered), Saved ${saved}`, 'success');
                } else {
                    log(`Error: ${data.error}`, 'error');
                }
            } catch (e) {
                log(`Error: ${e.message}`, 'error');
            }
            btn.disabled = false;
            btn.innerText = "Start Brand Scan";
        }

        function toggleDVUI() {
            const mode = document.querySelector('input[name="dv-mode"]:checked').value;
            document.getElementById('dv-live-ui').style.display = mode === 'live' ? 'block' : 'none';
            document.getElementById('dv-manual-ui').style.display = mode === 'manual' ? 'block' : 'none';

            const btn = document.querySelector('button[onclick="runDVScan(this)"]');
            btn.textContent = mode === 'live' ? 'Start DailyVirals Live Scraper' : 'Import Data & Enrich (EchoTik)';
        }

        async function runDVScan(btn) {
            const mode = document.querySelector('input[name="dv-mode"]:checked').value;
            if (mode === 'live') {
                return runDVLive(btn);
            } else {
                return runDVImport(btn);
            }
        }

        async function runDVLive(btn) {
            const days = document.getElementById('dv-days').value;
            const type = document.getElementById('dv-type').value;
            const saturation = document.getElementById('dv-saturation').value;
            const startPage = parseInt(document.getElementById('dv-start-page').value) || 1;
            const pageCount = parseInt(document.getElementById('dv-page-count').value) || 1;

            btn.disabled = true;
            btn.textContent = '‚è≥ Scraper Running...';
            log(`Starting DailyVirals Live Scraper...`, 'info');
            log(`Filters: ${days} Day(s), ${type}, ${saturation}`, 'info');

            try {
                const res = await fetch('/api/scan/dv-live', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        days,
                        type,
                        saturation,
                        start_page: startPage,
                        page_count: pageCount
                    })
                });
                const data = await res.json();
                if (data.success) {
                    log(`‚úÖ Batch Complete! ${data.message}`, 'success');
                } else {
                    log(`‚ùå Error: ${data.error}`, 'error');
                }
            } catch (e) {
                log(`Critical Network Error: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Start DailyVirals Live Scraper';
            }
        }

        async function runDVImport(btn) {
            const jsonStr = document.getElementById('dv-json').value;
            if (!jsonStr.trim()) {
                return log("Please paste JSON first", 'error');
            }

            log("Parsing JSON...");
            let parsed;
            try {
                parsed = JSON.parse(jsonStr);
            } catch (e) {
                return log("Invalid JSON: " + e.message, 'error');
            }

            // Quick validation
            if (parsed) {
                const keys = Object.keys(parsed);
                log(`Found object with keys: ${keys.join(', ')}`);
                if (!keys.includes('list') && !keys.includes('videos') && !keys.includes('data')) {
                    log("Warning: No standard list key ('list', 'videos', 'data') found at top level.", 'info');
                }
            }

            btn.disabled = true;
            btn.textContent = '‚è≥ Importing...';
            log("Sending to server for processing...");
            try {
                const res = await fetch(`/api/scan/manual`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ json_data: jsonStr, url: 'dv_import' })
                });
                const data = await res.json();
                if (data.success) {
                    log(data.message || "Import Successful", 'success');
                } else {
                    log(`Import Failed: ${data.error}`, 'error');
                }
            } catch (e) {
                log(`Network Error: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Import Data & Enrich (EchoTik)';
            }
        }

        async function runBatchLookup(btn) {
            const urlsRaw = document.getElementById('batch-urls').value;
            if (!urlsRaw.trim()) {
                return log("Please paste some URLs first", 'error');
            }

            const urls = urlsRaw.trim().split('\n').filter(u => u.trim());
            if (urls.length === 0) {
                return log("No valid URLs found", 'error');
            }
            if (urls.length > 50) {
                return log(`Maximum 50 URLs allowed, you have ${urls.length}`, 'error');
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Looking up...';
            log(`Looking up ${urls.length} products...`, 'info');

            try {
                const res = await fetch('/api/lookup/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls: urlsRaw })
                });
                const data = await res.json();

                if (data.success) {
                    log(data.message, 'success');

                    // Display each product
                    if (data.products && data.products.length > 0) {
                        log('‚îÄ'.repeat(60), 'info');
                        for (const p of data.products) {
                            const name = p.product_name.length > 40 ? p.product_name.substring(0, 40) + '...' : p.product_name;
                            log(`üì¶ ${name}`, 'success');
                            log(`   Shop: ${p.seller_name} | Sales: ${p.sales.toLocaleString()} | 7D: ${p.sales_7d.toLocaleString()} | Videos: ${p.video_count} | Inf: ${p.influencer_count}`, 'info');
                        }
                        log('‚îÄ'.repeat(60), 'info');
                    }

                    // Show errors
                    if (data.errors && data.errors.length > 0) {
                        log(`‚ö†Ô∏è ${data.errors.length} URLs failed:`, 'warn');
                        for (const e of data.errors) {
                            log(`   ${e.url.substring(0, 40)}... ‚Üí ${e.error}`, 'error');
                        }
                    }
                } else {
                    log(`Error: ${data.error}`, 'error');
                }
            } catch (e) {
                log(`Network Error: ${e.message}`, 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search mr-2"></i> Lookup Stats (Preview Only)';
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const mode = params.get('mode');
            const sellerId = params.get('seller_id');

            if (mode) {
                const tab = Array.from(document.querySelectorAll('.scan-tab'))
                    .find(t => t.innerText.toLowerCase().includes(mode.toLowerCase()));
                if (tab) setMode(mode, tab);
            } else {
                setMode('quick', document.querySelector('.scan-tab'));
            }

            if (sellerId && mode === 'brand') {
                // Wait for DOM update
                setTimeout(() => {
                    const input = document.getElementById('brand-id');
                    if (input) input.value = sellerId;
                }, 50);
            }
        });
    </script>
</body>

</html>