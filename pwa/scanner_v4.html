<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner | Gem Hunter</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/pwa/css/main.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        midnight: '#05070a',
                        cyan: '#06b6d4',
                        violet: '#7c3aed',
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .terminal-bg {
            background: rgba(0, 0, 0, 0.4);
            font-family: 'JetBrains Mono', monospace;
        }

        .log-entry {
            border-left: 2px solid transparent;
            padding-left: 1rem;
            margin-bottom: 0.25rem;
        }

        .log-info {
            border-left-color: #64748b;
            color: #94a3b8;
        }

        .log-success {
            border-left-color: #10b981;
            color: #34d399;
        }

        .log-error {
            border-left-color: #f43f5e;
            color: #fb7185;
        }

        .log-warn {
            border-left-color: #f59e0b;
            color: #fbbf24;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden bg-midnight">

    <!-- Sidebar -->
    <aside class="hidden md:flex flex-col w-72 glass border-r border-white/5 z-30">
        <div class="p-8">
            <div class="flex items-center gap-3 group cursor-pointer" onclick="window.location.href='/'">
                <div class="w-12 h-12 rounded-2xl glass flex items-center justify-center relative overflow-hidden">
                    <img src="/vantage_logo.png" class="w-full h-full object-cover p-1.5"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <span style="display:none" class="text-2xl h-full w-full items-center justify-center">ðŸ’Ž</span>
                </div>
                <div>
                    <h1 class="font-heading font-bold text-2xl tracking-tight text-white">Gem Hunter</h1>
                    <p class="text-[10px] text-cyan-400 font-bold tracking-widest uppercase opacity-70">TikTok Shop
                        Intel</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-2 overflow-y-auto no-scrollbar">
            <div class="px-4 py-2 text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">Navigation</div>
            <a href="/" class="sidebar-link"><i class="fas fa-th-large w-5"></i><span>Dashboard</span></a>
            <a href="/scanner" class="sidebar-link active"><i class="fas fa-gem w-5"></i><span>Sync Center</span></a>
            <a href="/shops" class="sidebar-link"><i class="fas fa-store w-5"></i><span>Shops Library</span></a>

            <div class="px-4 py-6 text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">System</div>
            <a href="/admin" class="sidebar-link"><i class="fas fa-terminal w-5"></i><span>Terminal</span></a>
            <a href="/settings" class="sidebar-link"><i class="fas fa-cog w-5"></i><span>Settings</span></a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <header class="glass h-20 flex items-center justify-between px-8 border-b border-white/5 sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden glass p-2 rounded-xl border-white/5 text-slate-400">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="font-heading font-bold text-xl text-white">Sync Center</h2>
                <div class="h-6 w-px bg-white/10 mx-2 hidden md:block"></div>
                <div id="statusIndicator" class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Copilot
                        Connected</span>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 no-scrollbar pb-32">
            <div class="max-w-4xl mx-auto space-y-8">

                <!-- TikTokCopilot Sync Panel -->
                <div class="glass-card p-8 md:p-10 border-t-4 border-t-cyan-500/50 relative overflow-hidden">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
                        <div>
                            <h3 class="text-2xl font-heading font-bold text-white mb-2 flex items-center gap-3">
                                <i class="fas fa-gem text-cyan-400"></i>
                                TikTokCopilot Sync
                            </h3>
                            <p class="text-slate-400 text-sm">Fetch trending products with ad spend, creator counts, and
                                revenue data.</p>
                        </div>
                        <button onclick="runCopilotSync(this)" id="btnSync" class="btn-premium px-10 py-4 shadow-xl">
                            <i class="fas fa-sync-alt mr-2"></i> Sync Now
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div>
                            <label
                                class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Time
                                Horizon</label>
                            <select id="sync-timeframe"
                                class="input-premium w-full font-bold appearance-none cursor-pointer">
                                <option value="1d">24 Hours</option>
                                <option value="3d">3 Days</option>
                                <option value="7d" selected>7 Days</option>
                                <option value="14d">14 Days</option>
                                <option value="30d">30 Days</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Products
                                Per Page</label>
                            <input type="number" id="sync-limit" value="50" class="input-premium w-full font-bold">
                        </div>
                        <div>
                            <label
                                class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Starting
                                Page</label>
                            <input type="number" id="sync-page" value="0" class="input-premium w-full font-bold">
                        </div>
                        <div>
                            <label
                                class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Pages
                                to Sync</label>
                            <input type="number" id="sync-pages" value="3" class="input-premium w-full font-bold">
                        </div>
                    </div>

                    <div class="glass p-4 rounded-xl border border-white/5 bg-black/20">
                        <p class="text-[10px] font-bold text-cyan-400 uppercase tracking-widest mb-2">What You'll Get:
                        </p>
                        <ul class="text-[10px] text-slate-400 space-y-1 list-disc ml-4">
                            <li>Trending products ranked by <span class="text-white">revenue</span></li>
                            <li>Stats: Ad Spend, Videos, Creators, GMV, Views, Commission</li>
                            <li>Products with 1/1 placeholder data are <span class="text-rose-400">automatically
                                    filtered</span></li>
                            <li>~50 products per page Ã— 3 pages = ~150 products per sync</li>
                        </ul>
                    </div>
                </div>

                <!-- Terminal Log -->
                <div class="glass-card overflow-hidden h-[350px] flex flex-col border border-white/5 shadow-2xl">
                    <div class="px-6 py-3 bg-white/5 border-b border-white/5 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="flex gap-1.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-rose-500/40"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-amber-500/40"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500/40"></div>
                            </div>
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] ml-2">Sync
                                Log</span>
                        </div>
                        <button onclick="document.getElementById('consoleLog').innerHTML = ''"
                            class="text-[10px] font-bold text-slate-500 hover:text-white uppercase tracking-widest transition-colors">Clear</button>
                    </div>
                    <div id="consoleLog"
                        class="flex-1 overflow-y-auto p-6 space-y-1 terminal-bg no-scrollbar text-[13px] leading-relaxed">
                        <div class="log-entry log-info">> Gem Hunter ready. Configure sync and click "Sync Now".</div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        function log(msg, type = 'info') {
            const c = document.getElementById('consoleLog');
            const d = document.createElement('div');
            d.className = `log-entry log-${type}`;
            d.innerHTML = `<span class="opacity-30">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
        }

        async function runCopilotSync(btn) {
            const timeframe = document.getElementById('sync-timeframe').value;
            const limit = parseInt(document.getElementById('sync-limit').value) || 50;
            const startPage = parseInt(document.getElementById('sync-page').value) || 0;
            const pageCount = parseInt(document.getElementById('sync-pages').value) || 1;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Syncing...';

            log(`Starting Copilot sync: ${pageCount} pages, ${limit}/page, ${timeframe} horizon...`, 'info');

            let totalSaved = 0;
            let totalFetched = 0;

            try {
                for (let i = 0; i < pageCount; i++) {
                    const page = startPage + i;
                    log(`Fetching page ${page + 1}...`, 'info');

                    const res = await fetch('/api/copilot/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ timeframe, limit, page })
                    });

                    const data = await res.json();

                    if (data.success) {
                        totalSaved += data.saved;
                        totalFetched += data.total_in_response;
                        log(`>> Page ${page + 1}: Saved ${data.saved}/${data.total_in_response} products`, 'success');
                    } else {
                        log(`!! Page ${page + 1} failed: ${data.error}`, 'error');
                    }

                    // Rate limit protection
                    await new Promise(r => setTimeout(r, 1500));
                }

                log(`âœ… SYNC COMPLETE: ${totalSaved} products saved (${totalFetched} fetched, remainder filtered as placeholders)`, 'success');

            } catch (e) {
                log(`System Error: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Sync Now';
            }
        }

        function toggleSidebar() {
            const aside = document.querySelector('aside');
            if (aside.classList.contains('hidden')) {
                aside.classList.remove('hidden');
                aside.classList.add('fixed', 'inset-0', 'bg-midnight', 'z-50');
                if (!document.getElementById('mobile-sidebar-close')) {
                    const closeBtn = document.createElement('button');
                    closeBtn.id = 'mobile-sidebar-close';
                    closeBtn.className = 'absolute top-8 right-8 glass p-3 rounded-2xl border-white/5 text-white';
                    closeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    closeBtn.onclick = toggleSidebar;
                    aside.appendChild(closeBtn);
                }
            } else {
                aside.classList.add('hidden');
                aside.classList.remove('fixed', 'inset-0', 'bg-midnight', 'z-50');
                const closeBtn = document.getElementById('mobile-sidebar-close');
                if (closeBtn) closeBtn.remove();
            }
        }
    </script>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <a href="/" class="mobile-nav-item"><i class="fas fa-th-large"></i><span>Intel</span></a>
        <a href="/scanner" class="mobile-nav-item active"><i class="fas fa-gem"></i><span>Sync</span></a>
        <a href="/shops" class="mobile-nav-item"><i class="fas fa-store"></i><span>Shops</span></a>
        <a href="/settings" class="mobile-nav-item"><i class="fas fa-cog"></i><span>Setup</span></a>
    </nav>
</body>

</html>